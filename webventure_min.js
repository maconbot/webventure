function WebVenture(){function x(){if(ha.isReady()){h.gameState=0;for(var c,d=1;c==undefined&&d<5;d++)c=ha.getResByKind("APPL","MCV"+d);H.open(c);d=H.getIndStr(129,2);c=ha.getRes(d);if(c!=undefined){c=H.open(c);d=decodePPIC(H.get("PPIC",0));H.close(c)}else d=decodePack(ha.getData(d));va.remove();va=undefined;Ha=J.create("","plainDBox",false,false,0,0,512,342);Ha.show();d.draw(Ha.port,0,0);for(d=0;d<5;d++)wa.load(d,H.getIndStr(129,d+4));d=H.get("GNRL",128);xa=d.r16();Ja=d.r16();Aa=d.r16();ya=d.r16();
Ka=d.r16();d.r16();V={};V.top=d.r16();V.left=d.r16();V.height=d.r16();V.width=d.r16();V.stepy=d.r16();V.stepx=d.r16();V.num=0;d.r16();d.r16();La=Array(ya);for(c=0;c<ya;c++)La[c]=d.r8();Ia=Array(ya);for(c=0;c<ya;c++)Ia[c]=d.r16();Ma=Array(ya);for(c=0;c<ya;c++)Ma[c]=d.r8();Ta=Array(Aa);for(c=0;c<Aa;c++)Ta[c]=d.r8();Ua=Array(Aa);for(c=0;c<Aa;c++)Ua[c]=d.r8();Ba=[];l();Z=[];h.queue=[];h.soundQueue=[];h.textQueue=[];aa=Array(xa*2);ba.setHuff(H.get("GNRL",131));commandsWin=J.get(H.get("WIND",128));commandsWin.kind=
9;commandsWin.addClass("commands");for(d=0;d<Aa;d++)Ua[d]&&commandsWin.add(U.get(H.get("CNTL",129+d)));X=J.get(H.get("WIND",129));X.kind=10;qa=J.get(H.get("WIND",130));qa.kind=11;ca=$(document.createElement("div"));ca.addClass("textEdit");qa.setCanvas(ca);ua=J.get(H.get("WIND",131));ua.kind=12;ua.refCon={id:0,x:0,y:0,children:[{id:1,top:0,left:0,width:0,height:0}]};da=J.get(H.get("WIND",132));da.kind=13;da.addClass("exits");for(d=128;d<=133;d++)Na.get(H.get("MENU",d));Na.addDA("Adjust Volume...");
qa.setTitle(H.getIndStr(128,1));if(gameparts.length>1){na=gameparts[1];c=JSON.parse(localStorage.getItem(na));ia=c.gamedata;h.globals=c.globals;ca.html(c.text);qa.setTitle(na)}else{c=ha.getData(H.getString(133));ia=Array(Ka);h.globals=Array(Ja);for(d=0;d<Ka;d++){ia[d]=Array(xa);for(var m=0;m<xa;m++)ia[d][m]=c.r16()}for(d=0;d<Ja;d++)h.globals[d]=c.r16()}e();if(na==""){h.cmdReady=true;h.selectedCtl=1;R.push(h.get(1,0))}setTimeout(u,500)}else setTimeout(x,10)}function u(){J.close(Ha);Ha=undefined;Na.show();
commandsWin.show();ua.show();h.updateWindow(ua);da.show();qa.show();X.show();h.gameState=1;ca.scrollTop(1E4);h.set(h.get(1,0),6,1);h.gameChanged=false;h.runMain()}function l(){h.selectedCtl=0;ra=undefined;R=[];W=0;Y={h:0,v:0};ba.input="";h.cmdReady=false;Oa=0}function e(){for(var c,d,m=0;m<xa*2;m++)aa[m]=0;for(m=xa-1;m;m--){c=ia[0][m];if(d=aa[c*2])aa[m*2+1]=d;aa[c*2]=m}}function b(c){if(c)(c=r(c))&&J.bringToFront(c)}function a(c){if(Ba.indexOf(c)==-1){Ba.push(c);var d={};d.obj=c;d.parent=h.get(c,
0);d.x=h.get(c,1);d.y=h.get(c,2);d.exitx=h.get(c,9);d.exity=h.get(c,10);d.hidden=h.get(c,11);d.offscreen=h.get(c,3);d.invisible=h.get(c,4);h.queue.push({id:7,val:d})}}function g(){if(h.gameState==2){J.closeAll();var c=H.getString(131),d=ha.getRes(c),m;if(d!=undefined){d=H.open(d);var y=H.get("PPIC",0);if(y!=undefined)m=decodePPIC(y);H.close(d)}if(m==undefined)m=decodePack(ha.getData(c));Pa=J.get(H.get("WIND",133));Pa.show();m.draw(Pa.port,0,0);j();h.gameState=4}else if(h.gameState==3){w();var B=J.getAlert(H.get("ALRT",
134));B.show();h.modalDialog=function(F){J.close(B);switch(F){case 1:k();break;case 3:h.gameState=4;h.runMain();break;default:M()}}}}function j(){var c=document.createElement("link");c.type="text/css";c.rel="stylesheet";c.href="print.css";c.media="print";$("head").append(c);var d=H.get("GNRL",129);d.r16();c=d.r16();var m=d.r16(),y=d.r16(),B=d.r16()-m;d=d.r16()-y;J.getDialog(H.get("DLOG",135)).show();h.isPaused=true;var F=U.create(y,m,d,B,4096,"",true,0,0,0,4);Pa.add(F);F.css("text-align","center");
F.css("font-size",c+"px");F.css("line-height",B+"px");F.focus();h.modalDialog=function(G){switch(G){case 1:F.blur();window.print();break;case 2:h.runMain()}}}function k(){for(var c=ha.getData(H.getString(133)),d=0;d<Ka;d++)for(var m=0;m<xa;m++)ia[d][m]=c.r16();for(d=0;d<Ja;d++)h.globals[d]=c.r16();s();e();qa.setTitle(H.getIndStr(128,1));ca.html("");h.selectedCtl=1;R=[h.get(1,0)];h.gameState=1;h.set(h.get(1,0),6,1);Ca=Da=Ea=h.gameChanged=false;sa.reset();h.cmdReady=true;h.runMain()}function t(){if(na==
"")n();else{localStorage.setItem(na,JSON.stringify({game:gamename,gamedata:ia,globals:h.globals,text:ca.html()}));qa.setTitle(na);h.gameChanged=false;za()}}function n(){var c=J.createDialog("","dBox",true,false,104,79,304,184,undefined);c.add(U.create(218,132,70,18,0,"Save",true,0,0,0,1));c.add(U.create(218,158,70,18,0,"Cancel",true,0,0,0,2));c.add(U.create(14,136,183,16,4352,"Save as:",true,0,0,0,3));c.add(U.create(17,157,177,16,4096,"",true,0,0,0,7));c.add(U.create(14,29,183,98,4608,"",true,0,0,
0,8));c.kind=2;h.isPaused=true;c.show();for(var d=c.getItem(8),m=undefined,y=0;y<localStorage.length;y++){var B=localStorage.key(y);if(JSON.parse(localStorage.getItem(B)).game==gamename){var F=$(document.createElement("div"));F.addClass("listitem");F.click(function(G){m&&m.removeClass("active");m=$(G.target);m.addClass("active");c.getItem(7).val(m.text())});F.text(B);d.append(F)}}h.modalDialog=function(G){switch(G){case 1:na=c.getItem(7).val();J.close(c);h.isPaused=false;t();break;case 2:J.close(c);
h.isPaused=false;za()}}}function s(){J.reset();V.num=0;h.queue=[];h.soundQueue=[];h.textQueue=[];Ba=[]}function w(){for(ra&&ra.removeClass("active");Z.length;)p(Z.pop());l()}function p(c){var d=da.find(c);if(d)Z.indexOf(c)!=-1?d.addClass("active"):d.removeClass("active");if(c==h.get(1,0))Z.indexOf(c)!=-1?da.addClass("selected"):da.removeClass("selected");h.updateWindow(h.getParentWin(c))}function r(c){switch(c){case 65532:return da;case 65533:return ua;case 65534:return qa;case 65535:return commandsWin}return J.find(c)}
function f(c,d){for(var m=[],y=aa[c*2];y;){m.push(y);d||(m=m.concat(f(y,false)));y=aa[y*2+1]}return m}function o(c){if(!r(c))if(c==h.get(1,0)){L(c,X);h.updateWindow(X);N();var d=ba.get(c);X.setTitle(ba.capitalize(d))}else{var m={h:h.get(c,1),v:h.get(c,2)};h.getParentWin(c).localToGlobal(m);var y=E();d=ba.get(c);var B=J.create(d,"zoomDoc",false,true,y.left,y.top,y.width,y.height);B.kind=14;B.scrollbars();L(c,B);B.refCon.flag=true;var F=$(document.createElement("div"));c=ja.position();F.addClass("zoom");
ja.append(F);F.css("top",m.v+"px");F.css("left",m.h+"px");F.css("width","0px");F.css("height","0px");F.animate({top:y.top+c.top+"px",left:y.left+c.left+"px",width:y.width+"px",height:y.height+"px"},500,function(){F.remove();B.show();h.updateWindow(B)})}}function z(c){var d=J.tryClose(r(c));if(d!=undefined){c=h.getParentWin(d.obj);if(c!=undefined){var m=$(document.createElement("div"));m.addClass("zoom");ja.append(m);m.css("top",d.top+"px");m.css("left",d.left+"px");m.css("width",d.width+"px");m.css("height",
d.height+"px");d={h:h.get(d.obj,1),v:h.get(d.obj,2)};c.localToGlobal(d);m.animate({top:d.v+"px",left:d.h+"px",width:"0px",height:"0px"},500,function(){m.remove();V.num--})}}}function A(c,d,m){var y={},B={h:0,v:0};c.localToGlobal(B);y.minx=B.h;y.miny=B.v;y.maxx=B.h+c.port.width();y.maxy=B.v+c.port.height();var F=$(document.createElement("div"));F.addClass("lasso");ja.append(F);F.css("top",d.pageY+"px");F.css("left",d.pageX+"px");F.css("width","0px");F.css("height","0px");$(document).mousemove(function(G){var T=
Math.max(Math.min(d.pageX,G.pageX),y.minx),I=Math.max(Math.min(d.pageY,G.pageY),y.miny),O=Math.min(Math.max(d.pageX,G.pageX),y.maxx);G=Math.min(Math.max(d.pageY,G.pageY),y.maxy);F.css("top",I+"px");F.css("left",T+"px");F.css("width",O-T+"px");F.css("height",G-I+"px")});$(document).mouseup(function(G){$(document).unbind("mousemove");$(document).unbind("mouseup");var T=Math.max(Math.min(d.pageX,G.pageX),y.minx),I=Math.max(Math.min(d.pageY,G.pageY),y.miny),O=Math.min(Math.max(d.pageX,G.pageX),y.maxx),
Ya=Math.min(Math.max(d.pageY,G.pageY),y.maxy);F.remove();G={h:T,v:I};c.globalToLocal(G);I={top:G.v,left:G.h,width:O-T,height:Ya-I};T=[];for(O=0;O<c.refCon.children.length;O++){var fa=c.refCon.children[O].id;if(!h.get(fa,4)){I.left=G.h-h.get(fa,1);I.top=G.v-h.get(fa,2);oa(fa,I)&&T.push(fa)}}if(d.shiftkey){if(T.length==0){if(R.length==0||c!=h.getParentWin(R[0]))R.indexOf(c.refCon.id)!=-1?ka(c.refCon.id):h.selectObj(c.refCon.id)}else for(;T.length;){fa=T.shift();R.indexOf(fa)!=-1?ka(fa):h.selectObj(fa)}h.runMain()}else{if(T.length==
0)fa=c.refCon.id;else for(;T.length;){fa=T.shift();h.selectObj(fa)}h.handleObjectSelect(fa,c,d,m)}})}function E(){for(var c=V.left,d=V.top,m=0;m<V.num;m++){c+=V.stepx;d+=V.stepy;if(d>=330)d=V.top;if(c>=500)c=V.left}V.num++;return{top:d,left:c,width:V.width,height:V.height}}function L(c,d){var m=f(c,true);d.refCon={id:c,x:0,y:0,flag:false,children:[]};for(var y=32767,B=32767,F=0;F<m.length;F++)if(m[F]!=1){child={id:m[F],top:0,left:0,width:0,height:0};if(d!=X){var G=h.get(c,1),T=h.get(c,2);if(y>G)y=
G;if(B>T)B=T}d.refCon.children.push(child)}if(y!=32767)d.refCon.x=y-8;if(B!=32767)d.refCon.y=B-8;if(d!=X)d.refCon.flag=true}function N(){da.killControls();for(var c=f(h.get(1,0),true),d=0;d<c.length;d++)ea(c[d])}function ea(c){if(h.get(c,8)){var d=da.find(c);d&&da.remove(d);if(!h.get(c,11)&&h.get(c,0)==h.get(1,0)){d=U.get(H.get("CNTL",128));d.data("refcon",c);U.move(d,h.get(c,9),h.get(c,10));da.add(d)}}}function K(){if(Da){Da=false;if(sa.resume())return Da=true;return false}if(Ca){Ca=false;if(sa.resume())return Ca=
true;h.updateScreen(false)}for(;R.length;){var c=R.shift();if((h.gameState==0||h.gameState==1)&&la(c)){if(sa.run(h.selectedCtl,c,W,Y))return Ca=true;h.updateScreen(false)}}if(h.selectedCtl==1)h.gameChanged=false;else if(h.gameState==0||h.gameState==1)if(sa.run(3,h.selectedCtl,W,Y))return Da=true;return false}function la(c){if(!ta(c))return false;if(ma()>=2&&W>0&&!ta(W))return false;if(h.selectedCtl!=5)return true;if(!(h.get(c,3)==0&&h.get(c,4)==0&&h.get(c,5)==0))return false;if(h.get(1,0)!=W)return true;
var d={top:0,left:0,width:X.port.width(),height:X.port.height()};d.top-=h.get(c,2)+Y.v;d.left-=h.get(c,1)+Y.h;return oa(c,d)}function oa(c,d){var m={top:0,left:0,width:0,height:0},y;if(y=ga.get(c*2+1)){m.width=y.width;m.height=y.height;if(ga.sectRect(m,d,m))return y.intersect(m);return false}if(y=ga.get(c*2)){m.width=y.width;m.height=y.height;return ga.sectRect(m,d,m)}return false}function ta(c){for(var d=h.get(1,0);c!=0&&c!=1&&c!=d;)c=h.get(c,0);return c}function ma(){if(!h.selectedCtl)return 3E3;
return Ta[h.selectedCtl-1]}function ka(c){var d=R.indexOf(c);d!=-1&&R.splice(d,1);if((d=Z.indexOf(c))!=-1){Z.splice(d,1);p(c)}}function C(){var c=H.get(H.getIndStr(129,1),0),d=c.r8();c=h.mac2ascii(c.read(d));var m=J.createDialog("","dBox",true,false,146,96,220,150,undefined);m.add(U.create(75,120,70,18,0,"Ok",true,0,0,0,1));m.add(U.create(20,30,180,40,4352,c,true,0,0,0,2));m.add(U.create(20,80,180,40,4352,"WebVenture <br /> &#169; 2010 Sean Kasun",true,0,0,0,3));m.getItem(2).css("text-align","center");
m.getItem(3).css("text-align","center");m.kind=2;h.isPaused=true;m.show();h.modalDialog=function(){J.close(m);h.isPaused=false}}function D(){var c=J.createDialog("","dBox",true,false,146,96,220,120,undefined);c.add(U.create(75,90,70,18,0,"Ok",true,0,0,0,1));var d=h.setting("volume");if(d==null)d=100;c.add(U.create(55,55,110,13,4864,"",true,d,0,100,2));c.add(U.create(20,25,180,20,4352,"Sound Volume",true,0,0,0,3));c.getItem(3).css("text-align","center");c.kind=2;h.isPaused=true;c.show();h.modalDialog=
function(){var m=c.getItem(2).data("value"),y=new Date;y.setTime(y.getTime()+31536E6);document.cookie="webventure_volume="+escape(m)+"; expires="+y.toGMTString()+"; path=/";J.close(c);h.isPaused=false}}function Q(){if(h.gameChanged){var c=h.mac2ascii(H.getIndStr(128,8)),d=J.getAlert(H.get("ALRT",131));h.isPaused=true;d.param([c]);d.show();h.modalDialog=function(m){J.close(d);switch(m){case 1:za=Q;t();break;case 2:h.isPaused=false;break;case 3:k()}}}else k()}function P(){if(h.gameChanged){var c=h.mac2ascii(H.getIndStr(128,
9)),d=J.getAlert(H.get("ALRT",131));d.param([c]);d.show();h.isPaused=true;h.modalDialog=function(m){J.close(d);switch(m){case 1:za=P;t();break;case 2:h.isPaused=false;break;case 3:M()}}}else M()}function M(){var c=J.createDialog("","dBox",true,false,82,71,348,200,undefined);c.add(U.create(256,138,80,18,0,"Open",true,0,0,0,1));c.add(U.create(256,163,80,18,0,"Cancel",true,0,0,0,3));c.add(U.create(12,39,218,146,4608,"",true,0,0,0,7));c.kind=2;h.isPaused=true;c.show();for(var d=c.getItem(7),m=undefined,
y=0;y<localStorage.length;y++){var B=localStorage.key(y);if(JSON.parse(localStorage.getItem(B)).game==gamename){var F=$(document.createElement("div"));F.addClass("listitem");F.click(function(G){m&&m.removeClass("active");m=$(G.target);m.addClass("active")});F.text(B);d.append(F)}}h.modalDialog=function(G){switch(G){case 1:if(m==undefined)break;na=m.text();J.close(c);h.isPaused=false;G=JSON.parse(localStorage.getItem(na));ia=G.gamedata;h.globals=G.globals;s();e();qa.setTitle(na);ca.html(G.text);ca.scrollTop(1E4);
h.gameState=1;Ca=Da=Ea=false;R=[];h.selectedCtl=0;sa.reset();h.set(h.get(1,0),6,1);h.gameChanged=false;h.runMain();break;case 3:J.close(c);h.isPaused=false}}}function pa(){if(h.gameChanged){var c=h.mac2ascii(H.getIndStr(128,7)),d=J.getAlert(H.get("ALRT",131));d.param([c]);d.show();h.isPaused=true;h.modalDialog=function(m){J.close(d);switch(m){case 1:za=pa;t();break;case 2:h.isPaused=false;break;case 3:h.gameState=4;h.runMain()}}}else{h.gameState=4;h.runMain()}}function Fa(c){if(c!=W){var d;if(W>0&&
(d=Z.indexOf(W))!=-1&&R.indexOf(W)==-1){Z.splice(d,1);p(W)}W=c;if(Z.indexOf(W)==-1){Z.push(W);p(W)}h.cmdReady=true}}function Ga(c,d,m,y){var B=m.pageX,F=m.pageY,G={h:0,v:0},T=false;S=undefined;y&&$(document).mousemove(function(I){if(S==undefined){if(Math.abs(I.pageX-B)+Math.abs(I.pageY-F)<=7)return false;T=true;S=Wa(c);var O=h.getChildIdx(d.refCon.children,c);if(O){G.h=d.refCon.children[O-1].left;G.v=d.refCon.children[O-1].top}d.localToGlobal(G);S.css("top",G.v+"px");S.css("left",G.h+"px")}O=S.position();
S.css("top",O.top+(I.pageY-F)+"px");S.css("left",O.left+(I.pageX-B)+"px");B=I.pageX;F=I.pageY;return false});$(document).mouseup(function(I){var O;if(y){$(document).unbind("mousemove");if(S){O=S.position();S.remove()}}$(document).unbind("mouseup");if(T){Y.h=O.left;Y.v=O.top;I=Xa(I.pageX,I.pageY);W=I.id;Y.h-=G.h;Y.v-=G.v;if(I.win!=d){d.localToGlobal(Y);I.win&&I.win.globalToLocal(Y)}h.selectedCtl=5;h.activateCommand(5);h.cmdReady=true}if(!h.cmdReady){Fa(c);if(!h.selectedCtl){h.selectedCtl=4;h.activateCommand(4);
h.cmdReady=true}}h.runMain()})}function Qa(c,d,m,y){var B=m.pageX,F=m.pageY,G={h:0,v:0},T=false;S=undefined;y&&$(document).mousemove(function(I){if(S==undefined){if(Math.abs(I.pageX-B)+Math.abs(I.pageY-F)<=7)return false;T=true;S=Wa(c);var O=h.getChildIdx(d.refCon.children,c);if(O){G.h=d.refCon.children[O-1].left;G.v=d.refCon.children[O-1].top}d.localToGlobal(G);S.css("top",G.v+"px");S.css("left",G.h+"px")}O=S.position();S.css("top",O.top+(I.pageY-F)+"px");S.css("left",O.left+(I.pageX-B)+"px");B=
I.pageX;F=I.pageY;return false});$(document).mouseup(function(I){Oa=I.timeStamp;var O;if(y){$(document).unbind("mousemove");if(S){O=S.position();S.remove()}}$(document).unbind("mouseup");if(T){Y.h=O.left;Y.v=O.top;I=Xa(I.pageX,I.pageY);W=I.id;Y.h-=G.h;Y.v-=G.v;if(I.win!=d){d.localToGlobal(Y);I.win&&I.win.globalToLocal(Y)}h.selectedCtl=5;h.activateCommand(5);h.cmdReady=true}if(ma()==1)h.cmdReady=true;h.runMain()})}function Ra(c){ja.append(S);var d={h:h.get(c,1),v:h.get(c,2)};h.getParentWin(c).localToGlobal(d);
S.animate({top:d.v+"px",left:d.h+"px"},300,function(){S.remove()})}function Wa(c){var d=ga.get(c*2);c=ga.get(c*2+1);var m=d.width,y=d.height;if(c){if(m<c.width)m=c.width;if(y<c.height)y=c.height}var B=$(document.createElement("canvas"));B.addClass("proxy");B.attr("width",m);B.attr("height",y);ja.append(B);c?c.bic(B,0,0):ga.fill(B,0);d.xor(B,0,0);return B}function Xa(c,d){var m=J.findWindow(c,d),y=0;if(m.win!=undefined)y=m.win.kind;if(m.id==3&&(y==14||y==10))m.id=m.win.refCon.id;else switch(y){case 9:m.id=
-1;break;case 11:m.id=-2;break;case 12:m.id=-3;break;case 13:m.id=-4;break;default:switch(m.id){case 0:m.id=-5;break;case 1:m.id=-6;break;case 2:m.id=-7;break;case 3:m.id=-8;break;case 4:m.id=-9;break;case 5:m.id=-10;break;case 6:m.id=-11;break;default:m.id=-12}}return m}var h=this,ja,J,ha,wa,ba,H,sa,U,Na,ga,Va,va,Ha,Pa,X,qa,ua,da,ca;this.gameState=0;this.gameChanged=false;var xa,Ja,Aa,ya,Ka,V,La,Ia,Ma,Ta,Ua,Ba,Z,R;this.textQueue=this.soundQueue=this.queue=undefined;var ra,W,Y;this.cmdReady=false;
this.selectedCtl=undefined;var Oa,aa,na="",ia;this.globals=undefined;var Ea=false;var Da=this.isPaused=false,Ca=false;this.init=function(){var c=document.createElement("link");c.type="text/css";c.rel="stylesheet";c.href="game.css";$("head").append(c);ja=$(document.createElement("div"));ja.addClass("screen");va=$(document.createElement("img"));va.attr("src","images/start.png");va.css("width","100%");va.css("height","100%");ja.append(va);$("script").filter(function(){return this.src.match(/webventure_(min|full)\.js/)}).after(ja);
ha=new FileManager(gamename);H=new ResourceManager(ha);wa=new ObjectManager(ha);ba=new TextManager(wa,H);U=new ControlManager;J=new WindowManager(ja,H,U);ga=new GraphicManager(wa);Va=new SoundManager(wa);Na=new MenuManager(ja);sa=new Engine(wa,ba,H,ga);x()};this.get=function(c,d){var m,y=La[d];if(y&128){var B=wa.get(0,c);if(B.length==0)return 0;y&=127;m=(B.charCodeAt(y*2)&255)<<8;m|=B.charCodeAt(y*2+1)&255}else m=ia[y][c];m&=Ia[d];return ha.neg16(m>>Ma[d])};this.set=function(c,d,m){if(d==0){var y=
m,B=ia[0][c];if(y!=c){var F=B*2;for(B=aa[F];B!=c;){F=B*2+1;B=aa[F]}aa[F]=aa[B*2+1];F=y*2;for(B=aa[F];B&&B<=c;){F=B*2+1;B=aa[F]}aa[c*2+1]=B;aa[F]=c}}d<12&&a(c);idx=La[d];m<<=Ma[d];m&=Ia[d];ia[idx][c]=m|ia[idx][c]&~Ia[d];h.gameChanged=true};this.updateObject=function(c){var d;if(d=this.get(1,0)==c?X:r(c)){b(c);h.runQueue();h.updateWindow(d)}};this.updateWindow=function(c){if(c!=undefined)if(c.refCon!=undefined)if(c==ua||h.get(c.refCon.id,6)==1){c==X?ga.get(c.refCon.id*2).draw(X.port,0,0):ga.fill(c.port,
0);for(var d=0;d<c.refCon.children.length;d++){var m=h.drawObject(c.refCon.children[d].id,c,0);c.refCon.children[d].top=m.top;c.refCon.children[d].left=m.left;c.refCon.children[d].width=m.width;c.refCon.children[d].height=m.height}}};this.drawObject=function(c,d,m){var y=h.get(c,1),B=h.get(c,2),F=h.get(c,3);if(m||!F||!h.get(c,4)){var G=1;if(F||m)G=0;else if(Z.indexOf(c)!=-1)G=2;return ga.draw(c,y,B,d.port,G)}return{top:0,left:0,width:0,height:0}};this.runMain=function(){if(h.gameState==4)window.location=
"index.html";else{Ea||h.updateScreen(false);if(h.cmdReady||Ea){Ea=false;if(K()){Ea=true;h.isPaused=true;return}h.isPaused=false;h.updateScreen(false);w()}if(h.gameState==2||h.gameState==3)g()}};this.updateScreen=function(c){this.runQueue();this.printTexts();return this.playSounds(c)};this.runQueue=function(){for(;h.queue.length;){for(var c,d=0,m=0;m<h.queue.length;m++)if(h.queue[m].id>d){d=h.queue[m].id;c=m}d=h.queue.splice(c,1)[0];switch(d.id){case 2:b(d.val);break;case 3:o(d.val);break;case 4:z(d.val);
break;case 7:a:{m=d.val;var y=false;d=m.obj;var B=Ba.indexOf(d);B!=-1&&Ba.splice(B,1);if(d==1){m.parent!=h.get(d,0)&&h.queue.push({id:12});if(m.offscreen!=h.get(d,3)||m.invisible!=h.get(d,4))h.updateWindow(h.getParentWin(d))}else if(m.parent!=h.get(d,0)||m.x!=h.get(d,1)||m.y!=h.get(d,2)){if(B=r(m.parent)){y=B;if(y.refCon!=undefined){B=h.getChildIdx(y.refCon.children,d);if(B!=0){y.refCon.children.splice(B-1,1);y.refCon.flag=true;h.updateWindow(y)}}y=true}if(B=h.getParentWin(d)){y=B;if(y.refCon!=undefined){B=
void 0;for(B=0;B<y.refCon.children.length&&d>y.refCon.children[B].id;B++);if(B==y.refCon.children.length||d!=y.refCon.children[B].id){y.refCon.children.splice(B,0,{id:d,top:0,left:0,width:0,height:0});h.updateWindow(y)}}y=true}}else if(m.offscreen!=h.get(d,3)||m.invisible!=h.get(d,4))h.updateWindow(h.getParentWin(d));if(h.get(d,8))if(y||m.hidden!=h.get(d,11)||m.exitx!=h.get(d,9)||m.exity!=h.get(d,10))ea(d);m=r(d);y=d;for(B=h.get(1,0);y!=B;){if(y==0||!h.get(y,6))break;y=h.get(y,0)}if(y==B){if(m)break a;
h.queue.push({id:3,val:d})}else{if(!m)break a;h.queue.push({id:4,val:d})}d=f(d,true);for(B=0;B<d.length;B++)a(d[B])}break;case 8:d=d.val;y=r(d.from);(m=B=r(d.to))||(m=y);if(m){y=ba.get(d.to);m.setTitle(y);L(d.to,m);m.refCon.flag=true;h.updateWindow(m)}break;case 12:h.set(X.refCon.id,6,0);h.set(h.get(1,0),6,1);break;case 13:for(;Z.length;)p(Z.pop());break;case 14:Ra(d.val)}}};this.playSounds=function(c){for(var d=0;h.soundQueue.length;){var m=h.soundQueue.splice(0,1)[0];switch(m.id){case 1:Va.play(m.val);
break;case 2:d=Va.play(m.val);break;case 3:console.log("wait?")}}if(c&&d){setTimeout(h.runMain,d*1E3);return true}return false};this.printTexts=function(){for(;h.textQueue.length;){var c=h.textQueue.splice(0,1)[0];switch(c.id){case 1:ca.append(c.val);ca.scrollTop(1E4);h.gameChanged=true;break;case 2:ca.append("<br/>");ca.scrollTop(1E4);h.gameChanged=true;break;case 3:ba.source=c.val[1];ba.target=c.val[0];ca.append(ba.get(c.val[2]));ca.scrollTop(1E4);h.gameChanged=true}}};this.invertmain=function(){X.invert()};
this.revertmain=function(){X.invert();h.runMain()};this.getParentWin=function(c){if(c==1)return ua;if(c=h.get(c,0))return r(c)};this.getFamily=function(c,d){return[c].concat(f(c,d))};this.getChildIdx=function(c,d){var m;for(m=0;m<c.length&&c[m].id!=d;m++);if(m==c.length)return 0;return m+1};this.unselectall=function(){for(;R.length;)ka(R.shift())};this.selectObj=function(c){R.length&&h.getParentWin(c)!=h.getParentWin(R[0])&&h.unselectall();R.indexOf(c)==-1&&R.push(c);if(Z.indexOf(c)==-1){Z.push(c);
p(c)}};this.activateCommand=function(c){c=commandsWin.find(c);if(c!=ra){ra&&ra.removeClass("active");(ra=c)&&c.addClass("active")}};var za=undefined;this.menuSelect=function(c,d){switch(c){case 128:switch(d){case 1:C();break;case 3:D()}break;case 129:switch(d){case 1:Q();break;case 3:P();break;case 4:za=function(){};t();break;case 5:za=function(){};n();break;case 7:pa()}break;case 131:switch(d){case 1:cleanup();break;case 2:messup()}break;case 132:doFont(d);break;case 133:doFontSize(d)}};this.buttonClicked=
function(c,d){var m=c.data("win");if(m.kind==2)return this.modalDialog(c.data("refcon"));if(m==da)h.isPaused||h.handleObjectSelect(c.data("refcon"),da,d,false);else if(c.data("refcon")==0){commandsWin.remove(Sa);commandsWin.showControls();h.runMain()}else if(!h.isPaused){ra&&c!=ra&&ra.removeClass("active");h.selectedCtl=c.data("refcon");h.activateCommand(h.selectedCtl);switch(ma()){case 0:h.cmdReady=true;break;case 1:h.cmdReady=R.length!=0;break;case 2:if(W>0)h.cmdReady=true}h.runMain()}};this.handleObjectSelect=
function(c,d,m,y){if(d==da)d=X;if(m.shiftKey)if(c){R.indexOf(c)!=-1?ka(c):h.selectObj(c);h.runMain()}else if(d.kind==14)A(d,m,y);else{if(R.length==0||d!=h.getParentWin(R[0]))R.indexOf(d.refCon.id)!=-1?ka(d.refCon.id):h.selectObj(d.refCon.id);h.runMain()}else if(h.selectedCtl&&R.length&&ma()>1){c?Fa(c):Fa(d.refCon.id);h.runMain()}else{if(!c){h.unselectall();if(d.kind==14)A(d,m,y);else c=d.refCon.id}if(c){var B;if(m.timeStamp-Oa<=300){Oa=0;B=true}else B=false;if(B){R.indexOf(c)==-1&&h.unselectall();
h.selectObj(c);Ga(c,d,m,y)}else{R.indexOf(c)==-1&&h.unselectall();h.selectObj(c);Qa(c,d,m,y)}}}};var S=undefined;this.objHit=function(c,d){var m=0,y;if(y=!this.get(d.id,4))y=c.h>=d.left&&c.v>=d.top&&c.h<d.left+d.width&&c.v<d.top+d.height?true:false;if(y)if(bmp=ga.get(d.id*2+1)){if(bmp.hit(c.h-d.left,c.v-d.top))m=d.id}else m=d.id;return m};var Sa;this.clickToContinue=function(){var c=commandsWin.port.width(),d=commandsWin.port.height();Sa=U.create(4,4,c-8,d-8,2048,"Click to continue",true,0,0,0,0);
Sa.addClass("ctc");commandsWin.hideControls();commandsWin.add(Sa)};this.textEntry=function(c,d,m){ba.target=m;ba.source=d;var y=J.getDialog(H.get("DLOG",132));y.param([ba.get(c)]);y.show();h.modalDialog=function(B){ba.input=y.getItem(3).val();B!=2?sa.push(65535):sa.push(0);J.close(y);h.runMain()}};this.mac2ascii=function(c){for(var d="",m=0;m<c.length;m++)switch(c.charCodeAt(m)){case 13:d+="<br />";break;case 63368:d+="&#224;";break;case 63374:d+="&#233;";break;case 63401:d+="&#169;";break;case 63433:d+=
"...";break;case 63441:d+="&#8212;";break;default:d+=c.charAt(m)}return d};this.setting=function(c){var d=document.cookie.split(";");c="webventure_"+c+"=";for(var m=0;m<d.length;m++){for(var y=d[m];y.charAt(0)==" ";)y=y.substring(1,y.length);if(y.indexOf(c)==0)return unescape(y.substring(c.length,y.length))}return null}}var webventure=new WebVenture;function Win(x,u,l,e,b,a,g,j,k){function t(C,D){var Q=C,P=D;k.bringToFront(L);$(document).mousemove(function(M){var pa=K.position();K.css("top",pa.top+(M.pageY-P)+"px");K.css("left",pa.left+(M.pageX-Q)+"px");Q=M.pageX;P=M.pageY});$(document).mouseup(function(M){$(document).unbind("mousemove");$(document).unbind("mouseup");var pa=K.position();K.css("top",pa.top+(M.pageY-P)+"px");K.css("left",pa.left+(M.pageX-Q)+"px")})}function n(C,D){var Q={h:C,v:D},P=0,M=L.refCon.children.length;for(L.globalToLocal(Q);M>
0&&P==0;){M--;P=webventure.objHit(Q,L.refCon.children[M])}return P}var s=undefined,w=undefined,p=undefined,r=undefined,f=undefined,o=undefined,z=undefined,A=undefined,E=undefined,L=this,N=[];x=undefined;var ea=u=="zoomDoc",K=$(document.createElement("div"));K.addClass(u);if(u!="plainDBox"&&u!="altDBox"&&u!="dBox"){var la="<span></span>";x=$(document.createElement("div"));x.addClass("title");x.mousedown(function(C){webventure.isPaused||t(C.pageX,C.pageY);return false});if(l)la='<div class="close"></div>'+
la;if(ea)la+='<div class="resize"></div>';x.html(la);if(l){la=x.children("div.close");la.mousedown(function(){return false});la.click(function(){if(!webventure.isPaused){if(L.kind==14){webventure.unselectall();webventure.selectObj(L.refCon.id);webventure.selectedCtl=2;webventure.activateCommand(2);webventure.cmdReady=true}webventure.runMain()}return false})}if(ea){la=x.children("div.resize");la.mousedown(function(){return false});la.click(function(){resizeClicked();return false})}K.append(x)}this.port=
$(document.createElement("canvas"));this.port.mousedown(function(C){if(!webventure.isPaused)switch(L.kind){case 9:t(C.pageX,C.pageY);break;case 10:case 14:var D=n(C.pageX,C.pageY),Q=false;if(D&&!webventure.get(D,3))Q=true;webventure.handleObjectSelect(D,L,C,Q);break;case 12:D=n(C.pageX,C.pageY);D==1?webventure.handleObjectSelect(D,L,C,false):t(C.pageX,C.pageY);break;case 13:webventure.handleObjectSelect(webventure.get(1,0),L,C,false)}return false});this.port.attr("width",a);this.port.attr("height",
g);K.append(this.port);var oa=b,ta=g,ma=e,ka=a;if(x!=undefined){oa-=17;ta+=18}if(u=="dBox"){oa-=2;ma-=2;ka+=2;ta+=2}K.css("top",oa+"px");K.css("left",ma+"px");K.css("width",ka+"px");K.css("height",ta+"px");j.append(K);this.show=function(){K.show()};this.hide=function(){K.hide()};this.setTitle=function(C){if(x!=undefined){var D=x.children("span");D.html("");if(C=="")D.hide();else{var Q=K.css("display")=="none";K.show();D.css({position:"absolute",visibility:"hidden",display:"block"});var P=a;if(l)P-=
30;if(ea)P-=30;for(var M=0;M<C.length;M++){D.append(C.substring(M,M+1));if(D.width()>P){D.html(C.substring(0,M-1));break}}D.css({position:"",visibility:"",display:""});Q&&K.hide()}}};this.setCanvas=function(C){this.port.remove();C.css("top","0px");C.css("left","0px");C.css("width",a+"px");C.css("height",g+"px");K.append(C)};this.addClass=function(C){K.addClass(C)};this.removeClass=function(C){K.removeClass(C)};this.add=function(C){if(x!=undefined){var D=parseInt(C.css("top"),10);C.css("top",D+17+
"px")}K.append(C);C.data("win",this);N.unshift(C)};this.remove=function(C){var D=N.indexOf(C);D!=-1&&N.splice(D,1);C.remove()};this.find=function(C){for(var D=0;D<N.length;D++)if(N[D].data("refcon")==C)return N[D]};this.killControls=function(){for(var C=0;C<N.length;C++)N[C].remove();N=[]};this.hideControls=function(){for(var C=0;C<N.length;C++)N[C].hide()};this.showControls=function(){for(var C=0;C<N.length;C++)N[C].show()};this.close=function(){K.remove()};this.globalToLocal=function(C){var D=K.position();
C.h-=D.left;C.v-=D.top;D=this.port.position();C.h-=D.left;C.v-=D.top};this.localToGlobal=function(C){var D=K.position();C.h+=D.left;C.v+=D.top;D=this.port.position();C.h+=D.left;C.v+=D.top};this.hit=function(C,D){pos=K.position();if(C>=pos.left&&C<pos.left+K.width()&&D>=pos.top&&D<pos.top+K.height()){C-=pos.left;D-=pos.top;pos=this.port.position();if(C>=pos.left&&C<pos.left+this.port.width()&&D>=pos.top&&D<pos.top+this.port.height())return{id:3,win:this};return{id:4,win:this}}};this.invert=function(){var C=
L.port.get(0).getContext("2d"),D=L.port.width(),Q=L.port.height();D=C.getImageData(0,0,D,Q);for(Q=0;Q<D.height;Q++)for(var P=Q*D.width*4,M=0;M<D.width;M++){D.data[P++]^=255;D.data[P++]^=255;D.data[P++]^=255;D.data[P++]=255}C.putImageData(D,0,0)};this.param=function(C){for(var D=0;D<N.length;D++){var Q=N[D].text().indexOf("^");if(Q>=0){var P=N[D].text().substr(0,Q),M=N[D].text().substr(Q+1,1);P+=C[parseInt(M,10)];P+=N[D].text().substr(Q+2);N[D].text(P)}}};this.getItem=function(C){for(var D=0;D<N.length;D++)if(N[D].data("refcon")==
C)return N[D]};this.scrollbars=function(){L.port.attr("width",a-15);L.port.attr("height",g-15);s=$(document.createElement("div"));s.addClass("hscroll");s.css("top",18+g-15+"px");s.css("left","0px");s.css("width",a-15+"px");s.css("height","14px");f=$(document.createElement("div"));f.addClass("leftarrow");f.css("top","0px");f.css("left","0px");f.css("width","14px");f.css("height","14px");s.append(f);o=$(document.createElement("div"));o.addClass("rightarrow");o.css("top","0px");o.css("left",a-30+"px");
o.css("width","14px");o.css("height","14px");s.append(o);z=$(document.createElement("div"));z.addClass("slider");z.css("top","0px");z.css("left","15px");z.css("width","30px");z.css("height","12px");s.append(z);K.append(s);w=$(document.createElement("div"));w.addClass("vscroll");w.css("top","17px");w.css("left",a-15+"px");w.css("width","14px");w.css("height",g-15+"px");p=$(document.createElement("div"));p.addClass("uparrow");p.css("top","0px");p.css("left","0px");p.css("width","14px");p.css("height",
"14px");w.append(p);r=$(document.createElement("div"));r.addClass("downarrow");r.css("top",g-30+"px");r.css("left","0px");r.css("width","14px");r.css("height","14px");w.append(r);A=$(document.createElement("div"));A.addClass("slider");A.css("top","15px");A.css("left","0px");A.css("width","12px");A.css("height","30px");w.append(A);K.append(w);E=$(document.createElement("div"));E.addClass("grow");E.css("top",18+g-15+"px");E.css("left",a-15+"px");E.css("width","14px");E.css("height","14px");E.mousedown(function(C){k.bringToFront(L);
var D=$(document.createElement("div"));D.addClass("resizeProxy");j.append(D);var Q=K.position();D.css("top",Q.top+"px");D.css("left",Q.left+"px");var P=ma+ka,M=oa+ta;D.css("width",P-ma+"px");D.css("height",M-oa+"px");var pa=C.pageX,Fa=C.pageY;$(document).mousemove(function(Ga){var Qa=P+(Ga.pageX-pa),Ra=M+(Ga.pageY-Fa);if(Qa>ma+100){P=Qa;D.css("width",P-ma+"px");pa=Ga.pageX}if(Ra>oa+100){M=Ra;D.css("height",M-oa+"px");Fa=Ga.pageY}});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");
D.remove();L.resize(P-ma,M-oa)});return false});K.append(E)};this.resize=function(C,D){ka=C;ta=D;g=D-18;a=ka;K.css("width",ka+"px");K.css("height",ta+"px");s.css("top",18+g-15+"px");s.css("width",a-15+"px");o.css("left",a-30+"px");w.css("left",a-15+"px");w.css("height",g-15+"px");r.css("top",g-30+"px");E.css("top",18+g-15+"px");E.css("left",a-15+"px");L.port.attr("width",a);L.port.attr("height",g);webventure.updateWindow(L)}}
function Dialog(x,u,l,e,b,a,g,j,k,t,n){var s=new Win(x,u,l,e,b,a,g,k,t);s.kind=2;this.show=function(){s.show()};this.hide=function(){s.hide()};this.close=function(){s.close()};this.setTitle=function(w){s.setTitle(w)};this.param=function(w){s.param(w)};this.getItem=function(w){return s.getItem(w)};this.add=function(w){s.add(w)};this.addClass=function(w){s.addClass(w)};this.removeClass=function(w){s.removeClass(w)};if(j!=undefined){x=j.r16()+1;for(u=0;u<x;u++){j.r32();l=j.r16();e=j.r16();b=j.r16()-
l;a=j.r16()-e;g=j.r8();k=j.r8();t="";if(k>0)t=webventure.mac2ascii(j.read(k));k&1&&j.r8();switch(g&127){case 4:l=n.create(e,l,a,b,0,t,true,0,0,0,u+1);s.add(l);break;case 8:l=n.create(e,l,a,b,4352,t,true,0,0,0,u+1);s.add(l);break;case 16:l=n.create(e,l,a,b,4096,t,true,0,0,0,u+1);s.add(l);break;default:console.log("Unknown DITL: "+(g&127));this.die()}}}}
function WindowManager(x,u,l){var e=[];this.create=function(b,a,g,j,k,t,n,s){var w=x.position();k+=w.left;t+=w.top;a=new Win(b,a,j,k,t,n,s,x,this);g==false&&a.hide();a.setTitle(b);this.bringToFront(a);return a};this.createDialog=function(b,a,g,j,k,t,n,s,w){var p=x.position();k+=p.left;t+=p.top;a=new Dialog(b,a,j,k,t,n,s,w,x,this,l);g==false&&a.hide();a.setTitle(b);this.bringToFront(a);return a};this.get=function(b){var a=b.r16(),g=b.r16(),j=b.r16()-a,k=b.r16()-g,t="";switch(b.r16()){case 0:t="document";
break;case 1:t="dBox";break;case 2:t="plainDBox";break;case 3:t="altDBox";break;case 4:t="noGrowDoc";break;case 5:t="movableDBox";break;case 8:t="zoomDoc";break;case 12:t="zoomNoGrow";break;case 16:t="rDoc16";break;case 18:t="rDoc4";break;case 20:t="rDoc6";break;case 22:t="rDoc10"}var n=b.r16()!=0,s=b.r16()!=0;b.r32();var w=b.r8(),p="";if(w!=1)p=webventure.mac2ascii(b.read(w));return this.create(p,t,n,s,g,a,k,j)};this.getDialog=function(b){var a=b.r16(),g=b.r16(),j=b.r16()-a,k=b.r16()-g,t="";switch(b.r16()){case 0:t=
"document";break;case 1:t="dBox";break;case 2:t="plainDBox";break;case 3:t="altDBox";break;case 4:t="noGrowDoc";break;case 5:t="movableDBox";break;case 8:t="zoomDoc";break;case 12:t="zoomNoGrow";break;case 16:t="rDoc16";break;case 18:t="rDoc4";break;case 20:t="rDoc6";break;case 22:t="rDoc10"}var n=b.r8()!=0;b.r8();var s=b.r8()!=0;b.r8();b.r32();var w=b.r16(),p=b.r8(),r="";if(p!=1)r=webventure.mac2ascii(b.read(p));b=u.get("DITL",w);return this.createDialog(r,t,n,s,g,a,k,j,b)};this.getAlert=function(b){var a=
b.r16(),g=b.r16(),j=b.r16()-a,k=b.r16()-g;b=b.r16();b=u.get("DITL",b);return this.createDialog("","dBox",true,false,g,a,k,j,b)};this.close=function(b){for(var a=0;a<e.length;a++)if(e[a]==b){b.close();e.splice(a,1);break}e.length&&this.bringToFront(e[0])};this.tryClose=function(b){if(b!=undefined){var a=b.refCon.id;b.refCon={};if(b.kind==10)b.setTitle("");else{var g={v:0,h:0},j={v:b.port.height(),h:b.port.width()};b.localToGlobal(g);b.localToGlobal(j);this.close(b);return{obj:a,top:g.v,left:g.h,width:j.h-
g.h,height:j.v-g.v}}}};this.find=function(b){for(var a=0;a<e.length;a++)if(e[a].kind==10||e[a].kind==14)if(e[a].refCon!=undefined&&e[a].refCon.id==b)return e[a]};this.bringToFront=function(b){if(e[0]!=b){e[0]!=undefined&&e[0].removeClass("active");for(var a=0;a<e.length;a++)e[a]==b&&e.splice(a,1);e.unshift(b)}b.addClass("active")};this.findWindow=function(b,a){var g=x.position();if(a>=g.top&&a<g.top+20&&b>=g.left&&b<g.left+x.width())return{id:1,win:undefined};for(g=0;g<e.length;g++){var j=e[g].hit(b,
a);if(j!=undefined)return j}return{id:0,win:undefined}};this.reset=function(){for(var b=[],a=0;a<e.length;a++)if(e[a].kind==10||e[a].kind==14)b.push(e[a]);for(a in b)this.tryClose(b[a])};this.closeAll=function(){for(var b=[],a=0;a<e.length;a++)e[a].kind==14?b.push(e[a]):e[a].hide();for(a in b)this.tryClose(b[a])}};function File(x){this.set=0;this.cur=1;this.end=2;this.length=x.length;var u=0;this.bit=0;this.eof=function(){return u>=this.length};this.r8=function(){return x.charCodeAt(u++)&255};this.r16=function(){var l=(x.charCodeAt(u++)&255)<<8;l|=x.charCodeAt(u++)&255;return l};this.r24=function(){var l=(x.charCodeAt(u++)&255)<<16;l|=(x.charCodeAt(u++)&255)<<8;l|=x.charCodeAt(u++)&255;return l};this.r32=function(){var l=(x.charCodeAt(u++)&255)<<24;l|=(x.charCodeAt(u++)&255)<<16;l|=(x.charCodeAt(u++)&255)<<
8;l|=x.charCodeAt(u++)&255;return l};this.peek32=function(){var l=(x.charCodeAt(u)&255)<<24;l|=(x.charCodeAt(u+1)&255)<<16;l|=(x.charCodeAt(u+2)&255)<<8;l|=x.charCodeAt(u+3)&255;return l};this.seek=function(l,e){switch(e){case this.cur:l+=u;break;case this.end:l+=this.length}u=l};this.read=function(l){var e=u;u+=l;return x.substring(e,u)};this.bits=function(l){var e=this.peek32();e>>=32-this.bit-l;e&=(1<<l)-1;this.bit+=l;if(this.bit&16){this.bit&=15;u+=2}return e}}
function MacFile(x,u,l,e,b,a,g,j){this.parent=x;this.name=u;this.type=l;this.creator=e;this.dataStart=b;this.dataLen=a;this.resStart=g;this.resLen=j}
function FileManager(x){function u(j,k){var t=j+k*512;g.seek(t+8,g.set);var n=g.r8();g.r8();var s=g.r16();switch(n){case 0:for(n=0;n<s;n++){g.seek(t+512-(n+1)*2,g.set);var w=g.r16();g.seek(t+w,g.set);var p=g.r8();g.seek(t+w+p+1,g.set);w=g.r32();u(j,w)}break;case 255:for(n=0;n<s;n++){g.seek(t+512-(n+1)*2,g.set);w=g.r16();p=t+w;g.seek(p,g.set);var r=g.r8();if(r!=0){r++;r&1&&r++;g.r8();w=g.r32();var f=g.r8();f=g.read(f);g.seek(p+r,g.set);switch(g.r16()){case 512:g.seek(p+r+4,g.set);var o=g.r32(),z=g.r32();
g.seek(p+r+20,g.set);var A=g.r32();g.seek(2,g.cur);var E=g.r32();g.seek(6,g.cur);var L=g.r32();g.seek(p+r+74,g.set);var N=g.r16();g.seek(p+r+86,g.set);p=g.r16();l[A]=new MacFile(w,f,o,z,N,E,p,L)}}}break;default:console.log("Bad node!");this.die()}}var l=[],e,b,a,g=undefined;$.ajax({url:x,beforeSend:function(j){j.overrideMimeType("text/html; charset=x-user-defined")},complete:function(j){g=new File(j.responseText);g.seek(1044,g.set);e=g.r32();g.seek(1052,g.set);b=g.r16();g.seek(1174,g.set);a=g.r16();
j=(a+b)*e;g.seek(j+e-2,g.set);var k=g.r16();g.seek(j+k+2,g.set);k=g.r32();u(j,k)}});this.isReady=function(){return g!=undefined};this.getResByKind=function(j,k){for(var t=0,n=0,s=0;s<4;s++){t|=j.charCodeAt(s)<<24-s*8;n|=k.charCodeAt(s)<<24-s*8}for(s in l)if(l[s].type==t&&l[s].creator==n){g.seek((l[s].resStart+b)*e,g.set);return new File(g.read(l[s].resLen))}};this.getRes=function(j){for(var k in l)if(l[k].name==j){if(l[k].resLen==0)break;g.seek((l[k].resStart+b)*e,g.set);return new File(g.read(l[k].resLen))}};
this.getData=function(j){for(var k in l)if(l[k].name==j){if(l[k].dataLen==0)break;g.seek((l[k].dataStart+b)*e,g.set);return new File(g.read(l[k].dataLen))}};this.neg16=function(j){if(j&32768)j=-((j^65535)+1);return j}};function BitMap(x,u,l){this.width=x;this.height=u;this.rowBytes=l;this.data=Array(u*l);this.draw=function(e,b,a){if(!(x==0||u==0)){var g=e.get(0).getContext("2d"),j=x,k=u,t=0,n=0;if(b<0){t=-b;b=0}if(a<0){n=-a;a=0}if(j+b>=e.width())j=e.width()-b;if(k+a>=e.height())k=e.height()-a;if(!(j==0||k==0)){e=g.getImageData(b,a,j,k);for(var s=n;s<k;s++)for(var w=s*l,p=(s-n)*e.width*4,r,f=t;f<j;f++){r=(r=this.data[w+(f>>3)]&1<<7-(f&7))?0:255;e.data[p++]=r;e.data[p++]=r;e.data[p++]=r;e.data[p++]=255}g.putImageData(e,
b,a)}}};this.bic=function(e,b,a){if(!(x==0||u==0)){var g=e.get(0).getContext("2d"),j=x,k=u,t=0,n=0;if(b<0){t=-b;b=0}if(a<0){n=-a;a=0}if(j+b>e.width())j=e.width()-b;if(k+a>e.height())k=e.height()-a;if(!(j==0||k==0)){e=g.getImageData(b,a,j,k);for(var s=n;s<k;s++)for(var w=s*l,p=(s-n)*e.width*4,r,f=t;f<j;f++)if(r=this.data[w+(f>>3)]&1<<7-(f&7)){e.data[p++]=255;e.data[p++]=255;e.data[p++]=255;e.data[p++]=255}else p+=4;g.putImageData(e,b,a)}}};this.or=function(e,b,a){if(!(x==0||u==0)){var g=e.get(0).getContext("2d"),
j=x,k=u,t=0,n=0;if(b<0){t=-b;b=0}if(a<0){n=-a;a=0}if(j+b>=e.width())j=e.width()-b;if(k+a>=e.height())k=e.height()-a;if(!(j==0||k==0)){e=g.getImageData(b,a,j,k);for(var s=n;s<k;s++)for(var w=s*l,p=(s-n)*e.width*4,r,f=t;f<j;f++)if(r=this.data[w+(f>>3)]&1<<7-(f&7)){e.data[p++]=0;e.data[p++]=0;e.data[p++]=0;e.data[p++]=255}else p+=4;g.putImageData(e,b,a)}}};this.xor=function(e,b,a){if(!(x==0||u==0)){var g=e.get(0).getContext("2d"),j=x,k=u,t=0,n=0;if(b<0){t=-b;b=0}if(a<0){n=-a;a=0}if(j+b>e.width())j=e.width()-
b;if(k+a>=e.height())k=e.height()-a;if(!(j==0||k==0)){e=g.getImageData(b,a,j,k);for(var s=n;s<k;s++)for(var w=s*l,p=(s-n)*e.width*4,r,f=t;f<j;f++)if(r=this.data[w+(f>>3)]&1<<7-(f&7)){e.data[p++]^=255;e.data[p++]^=255;e.data[p++]^=255;e.data[p++]=255}else p+=4;g.putImageData(e,b,a)}}};this.hit=function(e,b){return(this.data[b*l+(e>>3)]&1<<7-(e&7))!=0};this.intersect=function(e){for(var b=e.top;b<e.top+e.height;b++)for(var a=b*l,g,j=e.left;j<e.left+e.width;j++)if(g=this.data[a+(j>>3)]&1<<7-(j&7))return true;
return false}}function decodePack(x){var u=new BitMap(512,302,64),l=Array(72);x.seek(512,x.set);for(var e=0,b=0;b<u.height;b++){for(var a=0;a<72;){var g=x.r8();if(g!=128)if(g&128){g^=255;g+=2;for(var j=x.r8(),k=0;k<g;k++)l[a++]=j}else{g++;for(k=0;k<g;k++)l[a++]=x.r8()}}for(k=0;k<64;k++)u.data[e++]=l[k]}return u}
function decodePPIC(x){var u=x.bits(3),l,e;e=x.bits(1)?x.bits(10):x.bits(6);if((l=x.bits(1)?x.bits(10):x.bits(6))&&e){l=new BitMap(l,e,l+15>>3&65534);switch(u){case 0:decodePPIC0(l,x);break;case 1:decodePPIC1(l,x);break;case 2:decodePPIC2(l,x);break;case 3:decodePPIC3(l,x)}return l}}
function decodePPIC0(x,u){for(var l=x.width>>4,e=x.width&15,b,a=0,g=0;g<x.height;g++){for(var j=0;j<l;j++){b=u.peek32();u.seek(2,u.cur);b>>=16-u.bit;x.data[a++]=b>>8&255;x.data[a++]=b&255}if(e){b=u.bits(e);b<<=16-e;x.data[a++]=b>>8&255;x.data[a++]=b&255}}}var ppic1huff=[0,8192,16384,20480,24576,28672,32768,36864,40960,45056,49152,53248,55296,57344,59392,61440,63488],ppic1lens=[3,3,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5],ppic1values=[0,15,3,5,6,7,8,9,10,12,255,1,2,4,11,13,14];
function decodePPIC1(x,u){decodeHuff(ppic1huff,ppic1lens,ppic1values,x,u)}var ppic2huff=[0,16384,32768,49152,51200,53248,55296,57344,59392,61440,62464,62976,63488,64E3,64512,65024,65280],ppic2lens=[2,2,2,5,5,5,5,5,5,6,7,7,7,7,7,8,8],ppic2values=[255,0,15,1,3,7,14,12,8,6,2,4,9,13,11,10,5];function decodePPIC2(x,u){decodeHuff(ppic2huff,ppic2lens,ppic2values,x,u)}var loadbits=[8,15,2,255,0,4,255,1,7,9,8,255,3,4,255,4,10,7,10,11,6,255,5,6,6,11,255,7,3,255,9,4,3,14,255,12,2,255,13,1,255,15,255];
function decodePPIC3(x,u){for(var l=Array(17),e,b,a=0;(b=loadbits[a++])!=255;){for(e=u.bits(b);(b=loadbits[a++])!=255;){l[loadbits[a++]]=e%b;e=e/b|0}l[loadbits[a++]]=e}l[16]=0;for(e=16;e>0;e--)for(b=e;b<=16;b++)l[b]>=l[e-1]&&l[b]++;for(e=16;e>=0;e--)if(l[e]==16){l[e]=255;break}a=Array(17);var g=Array(17);b=u.bits(2)+1;var j=0;for(e=0;e<15;e++){if(e)for(;!u.bits(1);)b++;g[e]=b;a[e]=j;j+=1<<16-b}for(a[15]=j;j&1<<16-b;)b++;a[16]=j|1<<16-b;g[15]=b;g[16]=b;decodeHuff(a,g,l,x,u)}
function decodeHuff(x,u,l,e,b){var a;walkHuffLast=walkHuffRepeat=0;a=e.width&3?b.bits(5):b.bits(4)<<1;var g=0,j=e.width&15;if(j){j>>=2;g=j&1;j=2-(j>>1)}for(var k=0,t=0;t<e.height;t++){for(var n=0;n<e.width>>3;n++){var s=walkHuff(x,u,l,b)<<4;e.data[k++]=walkHuff(x,u,l,b)|s}if(g)e.data[k]=walkHuff(x,u,l,b)<<4;k+=j}if(n=e.width&3){k=e.rowBytes-j;for(t=j=s=0;t<e.height;t++){if(a&1){if(s<n){v=walkHuff(x,u,l,b)<<4;j|=v>>s;s+=4}s-=n;v=j;j<<=n;j&=255}else{v=b.bits(n);v<<=8-n}if(g)v>>=4;e.data[k]|=v&255;k+=
e.rowBytes}}if(a&8)for(t=k=0;t<e.height;t++){v=0;if(a&2)for(n=0;n<e.rowBytes;n++){e.data[k]^=v;v=e.data[k++]}else for(n=0;n<e.rowBytes;n++){j=e.data[k]^v;j^=j>>4&15;e.data[k++]=j;v=j<<4}}if(a&4){delta=e.rowBytes*4;if(a&2)delta*=2;k=0;q=delta;for(i=0;i<e.height*e.rowBytes-delta;i++)e.data[q++]^=e.data[k++]}}var walkHuffRepeat=0,walkHuffLast=0;
function walkHuff(x,u,l,e){if(walkHuffRepeat){walkHuffRepeat--;walkHuffLast=walkHuffLast<<8&65280|walkHuffLast>>8;return walkHuffLast&255}var b=e.peek32();b>>=16-e.bit;b&=65535;var a;for(a=0;a<16;a++)if(x[a+1]>b)break;e.bit+=u[a];if(e.bit&16){e.bit&=15;e.seek(2,e.cur)}x=l[a];if(x==255){if(!e.bits(1)){walkHuffLast&=255;walkHuffLast|=walkHuffLast<<8}walkHuffRepeat=e.bits(3);if(walkHuffRepeat<3){walkHuffRepeat<<=4;walkHuffRepeat|=e.bits(4);if(walkHuffRepeat<8){walkHuffRepeat<<=8;walkHuffRepeat|=e.bits(8)}}walkHuffRepeat-=
2;walkHuffLast=walkHuffLast<<8&65280|walkHuffLast>>8;return walkHuffLast&255}else{walkHuffLast<<=8;walkHuffLast|=x;walkHuffLast&=65535}return x}
function GraphicManager(x){function u(l,e,b,a,g,j){l=l.get(0).getContext("2d");for(var k=l.getImageData(e,b,a,g),t=0;t<g;t++)for(var n=t*k.width*4,s=j?0:255,w=0;w<a;w++){k.data[n++]=s;k.data[n++]=s;k.data[n++]=s;k.data[n++]=255}l.putImageData(k,e,b)}this.get=function(l){l=x.get(3,l);if(!(l.length<2)){if(l.length==2)return this.get((l.charCodeAt(0)&255)<<8|l.charCodeAt(1)&255);return decodePPIC(new File(l))}};this.fill=function(l,e){u(l,0,0,l.width(),l.height(),e)};this.draw=function(l,e,b,a,g){var j=
{top:0,left:0,width:0,height:0},k;if(k=this.get(l*2+1)){j={top:b,left:e,width:k.width,height:k.height};switch(g){case 1:k.bic(a,e,b);break;case 2:k.or(a,e,b)}}else if(k=this.get(l*2)){j={top:b,left:e,width:k.width,height:k.height};switch(g){case 1:u(a,e,b,k.width,k.height,0);break;case 2:u(a,e,b,k.width,k.height,1)}}if(g>0&&(k=this.get(l*2)))k.xor(a,e,b);return j};this.sectRect=function(l,e,b){var a=e.top,g=e.left,j=g+e.width;e=a+e.height;if(a<l.top)a=l.top;if(g<l.left)g=l.left;if(e>l.top+l.height)e=
l.top+l.height;if(j>l.left+l.width)j=l.left+l.width;if(j<=g||e<=a)a=e=g=j=0;b.top=a;b.left=g;b.width=j-g;b.height=e-a;return b.height!=0}};function ObjectManager(x){var u=[];this.load=function(l,e){var b=x.getData(e),a={};a.numitems=0;a.isobj=false;b.seek(0,b.set);var g=b.length,j=b.r32(),k;if(j&2147483648){j&=2147483647;a.isobj=true;b.seek(j,b.set);a.numitems=b.r16();g=Array(16);for(var t=Array(16),n=0;n<15;n++)g[n]=b.r16();for(n=0;n<16;n++)t[n]=b.r8();a.offsets=Array(a.numitems);a.lengths=Array(a.numitems);var s=0;for(n=0;n<a.numitems;n++){if((n&63)==0){b.seek(j+(n>>6)*6+48,b.set);var w=b.r24();k=b.r24();s=w&7;b.seek(j+(w>>3),b.set)}a.offsets[n]=
k;w=b.r32()>>16-s&65535;b.seek(-4,b.cur);var p;for(p=0;p<16;p++)if(g[p]>w)break;w=t[p];s+=w&15;if(s&16){s&=15;b.seek(2,b.cur)}w>>=4;p=0;if(w){p=b.peek32();w--;if(w==0)p=0;else p>>=32-w-s;p&=(1<<w)-1;p|=1<<w;s+=w;if(s&16){s&=15;b.seek(2,b.cur)}k+=p}a.lengths[n]=p}k=j-4}else{g-=4;k=g;a.itemlen=j;a.numitems=g/j|0}b.seek(4,b.set);a.data=b.read(k);u[l]=a};this.get=function(l,e){if(e>=u[l].numitems)return"";var b,a;if(u[l].isobj){b=u[l].lengths[e];a=u[l].offsets[e]}else{b=u[l].itemlen;a=e*b}if(!b)return"";
return u[l].data.substring(a,a+b)}};function TextManager(x,u){function l(n){if(n&32768)return a.input;n=new File(x.get(2,n));for(var s=false,w="",p=n.r16();p--;){var r=n.bits(5);if(r>0&&r<27){r|=64;if(s)r|=32;s=true;w+=String.fromCharCode(r)}else switch(r){case 0:w+=" ";break;case 27:w+=s?".":",";s=true;break;case 28:w+=s?"'":'"';s=true;break;case 29:s=n.bits(16);if(s&32768){s^=65535;s=e(s)}else s=l(s);if(s)w+=s;s=true;break;case 30:w+=String.fromCharCode(n.bits(8));s=true;break;case 31:s=!s}}return webventure.mac2ascii(w)}function e(n){var s,
w;s=n&8?a.target:a.source;if((n&3)==1){s=webventure.get(s,7);s=(s>>4&3)+1;w=u.getIndStr(132,s)}else{w=a.get(s);w==""&&fail();switch(n&3){case 2:w=b(0,s)+w;break;case 3:w=b(2,s)+w}}if(w.length&&n&4)w=a.capitalize(w);return w}function b(n,s){var w=webventure.get(s,7)>>n&3;if(w)return u.getIndStr(131,w);return""}var a=this,g,j,k,t=true;this.input="";this.setHuff=function(n){if(n!=undefined){t=false;var s=n.r16();n.r16();g=Array(s);for(var w=0;w<s-1;w++)g[w]=n.r16();j=Array(s);for(w=0;w<s;w++)j[w]=n.r8();
k=Array(s);for(w=0;w<s;w++)k[w]=n.r8()}};this.get=function(n){if(t)return l(n);if(n&32768)return this.input;n=new File(x.get(2,n));var s,w="";for(s=n.bits(1)?n.bits(15):n.bits(7);s--;){var p=n.peek32();p>>=16-n.bit;p&=65535;var r;for(r=0;r<g.length;r++)if(p<g[r])break;n.bit+=j[r];if(n.bit&16){n.bit&=15;n.seek(2,n.cur)}p=k[r];if(p==1)p=n.bits(7);if(p!=2)w+=String.fromCharCode(p);else{if(n.bits(1)){p=n.bits(15);p=this.get(p)}else{p=n.bits(8);p=e(p)}if(p)w+=p}}return webventure.mac2ascii(w)};this.capitalize=
function(n){return n.substr(0,1).toUpperCase()+n.substr(1)}};function EngineState(){function x(e){if(e<0)e=(-e^65535)+1;return e}var u=Array(128),l=128;this.push=function(e){l--;u[l]=x(e)&65535};this.pop=function(){return u[l++]};this.peek=function(e){return u[l+e]};this.poke=function(e,b){u[l+e]=x(b)&65535};this.clear=function(){l=128};this.size=function(){return 128-l}}
function Engine(x,u,l,e){function b(r){r=typeof r!="undefined"?r:false;var f=false;if(p[0].haltedInFirst||r){p[0].haltedInFirst=false;if(f=r?a(0):g())return p[0].haltedInFirst=true;f=true;p[0].familyIdx=0}if(p[0].haltedInFamily||f){p[0].haltedInFamily=false;var o=webventure.getFamily(webventure.get(1,0),false);for(r=p[0].familyIdx;r<o.length;r++){if(f=f?a(o[r]):g()){p[0].haltedInFamily=true;p[0].familyIdx=r;return true}f=true}}var z;if(p[0].haltedInSaves){p[0].haltedInSaves=false;if(g())return p[0].haltedInSaves=
true}do{for(r=f=0;r<p[0].saves.length;r++)if(f<p[0].saves[r].rank){f=p[0].saves[r].rank;z=r}if(f){p[0].saves[z].rank=0;if(a(p[0].saves[z].func))return p[0].haltedInSaves=true}}while(f);p.shift();return false}function a(r){if(func=x.get(1,r)){p[0].p[0]=new File(func);return t()}return false}function g(){var r=t();if(r)return r;p[0].p.shift();if(p[0].p.length)return g()}function j(r){if(r&128)r=-((r^255)+1);return r}function k(r){if(r&32768)r=-((r^65535)+1);return r}function t(){for(var r=p[0].p[0],
f=p[0].state;!r.eof();){var o=r.r8();if(o&128)switch(o){case 128:var z=f.pop(),A=f.pop();o=webventure.get(z,A);f.push(o);break;case 129:z=f.pop();A=f.pop();o=k(f.pop());webventure.set(z,A,o);break;case 130:z=f.pop();A=f.pop();o=f.pop();f.push(s(z,A,o!=0));break;case 131:f.push(p[0].curCtl);break;case 132:f.push(p[0].curObj);break;case 133:f.push(p[0].target);break;case 134:f.push(p[0].ptx);break;case 135:f.push(p[0].pty);break;case 136:f.push(r.r8());break;case 137:f.push(r.r16());break;case 138:z=
f.pop();f.push(webventure.globals[z]);break;case 139:z=f.pop();o=k(f.pop());webventure.globals[z]=o;webventure.gameChanged=true;break;case 140:o=f.pop();f.push(Math.round((o-1)*Math.random()));break;case 141:o=f.peek(0);f.push(o);break;case 142:z=f.pop();for(A=z-1;z--;){o=f.peek(A);f.push(o)}break;case 143:A=f.pop();var E=f.pop();f.push(A);f.push(E);break;case 144:z=f.pop();E=f.peek(z);A=f.peek(0);f.poke(z,A);f.poke(0,E);break;case 145:f.pop();break;case 146:o=f.peek(1);f.push(o);break;case 147:z=
f.pop();o=f.peek(z);f.push(o);break;case 148:E=f.pop();A=f.pop();o=f.pop();f.push(E);f.push(o);f.push(A);break;case 149:var L=k(f.pop());z=k(f.pop());L%=z;if(L<0)L+=z;var N=0,ea=0;for(o=1;o<z;o++){ea+=L;if(ea>=z)ea-=z;if(ea==N){N++;ea=N}else{E=f.peek(N);A=f.peek(ea);f.poke(N,A);f.poke(ea,E)}}break;case 150:f.clear();break;case 151:f.push(f.size());break;case 152:A=f.pop();E=f.pop();f.push(E+A);break;case 153:A=f.pop();E=f.pop();f.push(E-A);break;case 154:A=f.pop();E=f.pop();f.push(E*A);break;case 155:A=
f.pop();E=f.pop();f.push(E/A|0);break;case 156:A=f.pop();E=f.pop();f.push(E%A);break;case 157:A=f.pop();E=f.pop();f.push(E%A);f.push(E/A|0);break;case 158:o=k(f.pop());if(o<0)o=-o;f.push(o);break;case 159:o=-k(f.pop());f.push(o);break;case 160:A=f.pop();E=f.pop();f.push(E&A);break;case 161:A=f.pop();E=f.pop();f.push(E|A);break;case 162:A=f.pop();E=f.pop();f.push(E^A);break;case 163:o=f.pop();f.push(o^65535);break;case 164:A=f.pop();E=f.pop();f.push(E&&A?65535:0);break;case 165:A=f.pop();E=f.pop();
f.push(E||A?65535:0);break;case 166:A=f.pop();E=f.pop();f.push(!E!=!A?65535:0);break;case 167:o=f.pop();f.push(o==0?65535:0);break;case 168:A=f.pop();E=f.pop();f.push(E>A?65535:0);break;case 169:A=f.pop();E=f.pop();f.push(E<A?65535:0);break;case 170:A=k(f.pop());E=k(f.pop());f.push(E>A?65535:0);break;case 171:A=k(f.pop());E=k(f.pop());f.push(E<A?65535:0);break;case 172:A=f.pop();E=f.pop();f.push(E==A?65535:0);break;case 173:A=u.get(f.pop());E=u.get(f.pop());f.push(E==A?1:0);break;case 174:o=u.get(f.pop());
z=u.get(f.pop());f.push(z.toLowerCase().indexOf(o.toLowerCase())!=-1?1:0);break;case 175:o=u.get(f.pop());z=u.get(f.pop());f.push(RegExp("\\b"+o+"\\b","i").test(z)?65535:0);break;case 176:o=k(r.r16());r.seek(o,r.cur);break;case 177:o=j(r.r8());r.seek(o,r.cur);break;case 178:o=k(r.r16());A=f.pop();A!=0&&r.seek(o,r.cur);break;case 179:o=j(r.r8());A=f.pop();A!=0&&r.seek(o,r.cur);break;case 180:o=k(r.r16());A=f.pop();A==0&&r.seek(o,r.cur);break;case 181:o=j(r.r8());A=f.pop();A==0&&r.seek(o,r.cur);break;
case 182:o=f.pop();z=f.pop();p[0].saves.push({rank:o,func:z});break;case 183:z=f.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].func==z)p[0].saves[o].rank=0;break;case 184:z=f.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].rank<=z)p[0].saves[o].rank=0;break;case 185:A=f.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].rank>=A)p[0].saves[o].rank=0;break;case 186:z=f.pop();A=f.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].rank>=A&&p[0].saves[o].rank<=z)p[0].saves[o].rank=
0;break;case 187:o=f.pop();z=f.pop();A=f.pop();E=f.pop();L=f.pop();p.unshift({curCtl:o,curObj:z,target:A,ptx:E,pty:L,state:new EngineState,saves:[],p:[undefined]});if(b(true))return true;break;case 188:o=f.pop();p[0].p.unshift(undefined);if(a(o))return true;p[0].p.shift();r=p[0].p[0];break;case 189:z=f.pop();webventure.queue.push({id:2,val:z});break;case 190:o={};o.from=f.pop();o.to=f.pop();webventure.queue.push({id:8,val:o});o=o;webventure.set(o.to,6,webventure.get(o.from,6));webventure.set(o.from,
6,0);z=webventure.getFamily(o.from,true);for(A=1;A<z.length;A++)webventure.set(z[A],0,o.to);break;case 191:webventure.queue.push({id:14,val:p[0].curObj});break;case 192:webventure.queue.push({id:13});break;case 193:o=f.pop();webventure.textQueue.push({id:3,val:[p[0].target,p[0].curObj,o]});break;case 194:webventure.textQueue.push({id:2});break;case 195:o=f.pop();webventure.textQueue.push({id:3,val:[p[0].target,p[0].curObj,o]});webventure.textQueue.push({id:2});break;case 196:webventure.textQueue.push({id:2});
o=f.pop();webventure.textQueue.push({id:3,val:[p[0].target,p[0].curObj,o]});webventure.textQueue.push({id:2});break;case 197:o=f.pop();webventure.textQueue.push({id:1,val:o});break;case 198:push(2);break;case 199:z=f.pop();webventure.soundQueue.push({id:1,val:z});break;case 200:z=f.pop();webventure.soundQueue.push({id:2,val:z});break;case 201:webventure.soundQueue.push({id:3});break;case 202:o=new Date;o=[o.getFullYear(),o.getMonth()+1,o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];f.push(o[0]);
f.push(o[1]);f.push(o[2]);f.push(o[3]);f.push(o[4]);f.push(o[5]);break;case 203:f.push((new Date).getDay()+1);break;case 204:o=f.pop();z=f.pop();z=webventure.getFamily(z,o!=0);for(o=1;o<z.length;o++)f.push(z[o]);f.push(z.length-1);break;case 205:o=f.pop();z=f.pop();z=webventure.getFamily(z,o!=0);f.push(z.length-1);break;case 206:f.push(86);break;case 207:o=l.getIndStr(129,1);f.push(o.charCodeAt(3)-48);break;case 208:f.push(1);break;case 209:z=f.pop();o=n(z);o={v:o.height,h:o.width};f.push(o.h);f.push(o.v);
break;case 210:A=f.pop();E=f.pop();f.push(w(A,E));break;case 211:o=z=f.pop();z=[];A=webventure.getFamily(webventure.get(o,0),1);for(E=1;E<A.length;E++)o<A[E]&&w(A[E],o)>=40&&z.push(A[E]);for(;z.length;)webventure.set(z.pop(),0,o);break;case 212:z=z=f.pop();o=webventure.getFamily(z,1);z=webventure.get(z,0);for(A=1;A<o.length;A++)webventure.set(o[A],0,z);break;case 213:r=f.pop();webventure.textEntry(r,p[0].curObj,p[0].target);return true;case 214:webventure.activateCommand(f.pop());break;case 215:webventure.gameState=
3;break;case 216:webventure.gameState=2;break;case 217:r=f.pop();setTimeout(webventure.runMain,r/60*1E3);return true;case 218:webventure.updateScreen(false);webventure.clickToContinue();return true;case 219:webventure.runQueue();break;case 220:if(webventure.playSounds(true))return true;break;case 221:webventure.printTexts();break;case 222:if(webventure.updateScreen(true))return true;break;case 223:r=f.pop();webventure.invertmain();setTimeout(webventure.revertmain,r/60*1E3);return true;case 224:f.pop();
break;case 225:f.pop();break;case 226:A=f.pop();E=f.pop();E*=A;o=f.pop();E/=o;f.push(E|0);break;case 227:z=f.pop();webventure.updateObject(z);break;case 228:f.push(0);break;case 229:console.log("wait for event");break;case 230:f.push(fib);break;case 231:z=f.pop();A=1;for(o=fib=0;o<z;o++){fib+=A;fib^=A;A^=fib;fib^=A}break;default:console.log("func: "+o.toString(16));this.die()}else f.push(o)}return false}function n(r){var f={top:0,left:0,width:0,height:0},o=webventure.getParentWin(r),z=0;if(o&&o.refCon)z=
webventure.getChildIdx(o.refCon.children,r);if(z){if(o.refCon.children[z-1].width==0||o.refCon.children[z-1].height==0){r=webventure.drawObject(r,o,true);o.refCon.children[z-1].top=r.top;o.refCon.children[z-1].left=r.left;o.refCon.children[z-1].width=r.width;o.refCon.children[z-1].height=r.height}f.top=o.refCon.children[z-1].top;f.left=o.refCon.children[z-1].left;f.width=o.refCon.children[z-1].width;f.height=o.refCon.children[z-1].height}else if((bmp=e.get(r*2))!=undefined){f.top=webventure.get(r,
2);f.left=webventure.get(r,1);f.width=bmp.width;f.height=bmp.height}else if((bmp=e.get(r*2+1))!=null){f.top=webventure.get(r,2);f.left=webventure.get(r,1);f.width=bmp.width;f.height=bmp.height}else{f.top=0;f.left=0;f.width=0;f.height=0}return f}function s(r,f,o){var z=0;r=webventure.getFamily(r,o);for(o=1;o<r.length;o++)z+=webventure.get(r[o],f);return z}function w(r,f){if(webventure.get(r,0)!=webventure.get(f,0))return 0;var o=n(r),z=n(f);if(e.sectRect(z,o,z))return z.width*z.height*100/(o.width*
o.height)|0;return 0}var p=[];this.reset=function(){p=[]};this.push=function(r){p[0].state.push(r)};this.run=function(r,f,o,z){p.unshift({curCtl:r,curObj:f,target:o,ptx:z.h,pty:z.v,state:new EngineState,saves:[],p:[]});return this.resume(true)};this.resume=function(r){for(r=typeof r!="undefined"?r:false;p.length;)if(b(r))return true;return false}};function ResourceManager(){var x=[];this.open=function(u){x.push(u);return x.length-1};this.close=function(u){x.splice(u,1)};this.get=function(u,l){for(var e=u.charCodeAt(0)<<24|u.charCodeAt(1)<<16|u.charCodeAt(2)<<8|u.charCodeAt(3),b=x.length-1;b>=0;b--){var a=x[b];a.seek(0,a.set);var g=a.r32(),j=a.r32();a.seek(j+24,a.set);j=j+a.r16();a.seek(j,a.set);for(var k=a.r16()+1,t=0;t<k;t++){if(a.r32()==e){e=a.r16()+1;a.seek(j+a.r16(),a.set);for(t=0;t<e;t++){if(a.r16()==l){a.seek(2,a.cur);g+=a.r32()&16777215;
a.seek(g,a.set);g=a.r32();return new File(a.read(g))}a.seek(10,a.cur)}return}a.seek(4,a.cur)}}};this.getString=function(u){u=this.get("STR ",u);if(u==undefined)return"";var l=u.r8();return u.read(l)};this.getIndStr=function(u,l){if(l==0)return"";var e=this.get("STR#",u);if(e==undefined)return"";var b=e.r16();if(l>b)return"";for(;;){l--;if(l==0){b=e.r8();return e.read(b)}b=e.r8();e.seek(b,e.cur)}}};function ControlManager(){function x(e,b,a,g,j,k,t){var n=$(document.createElement("div"));n.addClass("button");n.css("top",b+"px");n.css("left",e+"px");n.css("width",a-2+"px");n.css("height",g-2+"px");n.css("line-height",g-2+"px");n.html(j);n.data("refcon",t);k==false&&n.hide();n.mousedown(function(s){webventure.buttonClicked(n,s);return false});return n}function u(e,b,a,g,j,k,t){var n=$(document.createElement("div"));n.addClass("cbutton");n.css("top",b+"px");n.css("left",e+"px");n.css("width",a-
2+"px");n.css("height",g-2+"px");n.html(j);n.data("refcon",t);k==false&&n.hide();n.mousedown(function(s){webventure.buttonClicked(n,s);return false});return n}function l(e,b,a,g,j,k,t,n,s){var w=$(document.createElement("div"));w.addClass("hslider");w.css("top",b+"px");w.css("left",e+"px");w.css("width",a+"px");w.css("height",g+"px");w.data("refcon",s);n==false&&w.hide();e=$(document.createElement("div"));e.addClass("hsliderLeft");e.css("top","0px");e.css("left","0px");w.append(e);e=$(document.createElement("div"));
e.addClass("hsliderWell");e.css("top","0px");e.css("left","4px");e.css("width",a-8+"px");w.append(e);b=$(document.createElement("div"));b.addClass("hsliderRight");b.css("top","0px");b.css("left",a-4+"px");w.append(b);var p=$(document.createElement("div"));p.addClass("hsliderThumb");p.css("top","-4px");p.css("left",((j-k)*(a-8-11)/t|0)+"px");e.append(p);w.data("value",j);p.mousedown(function(r){var f=r.pageX,o=p.position().left;$(document).mousemove(function(z){o+=z.pageX-f;f=z.pageX;if(o>=0&&o<=a-
8-11)p.css("left",o+"px");else o<0?p.css("left","0px"):p.css("left",a-8-11+"px");return false});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");var z=p.position().left;w.data("value",k+(z*(t-k)/(a-8-11)|0));return false});return false});return w}this.create=function(e,b,a,g,j,k,t,n,s,w,p){switch(j>>4){case 0:return x(e,b,a,g,k,t,p);case 128:return u(e,b,a,g,k,t,p);case 256:j=$(document.createElement("input"));j.addClass("textinput");j.css("top",b+"px");
j.css("left",e+"px");j.css("width",a+"px");j.css("height",g+"px");j.val(k);j.data("refcon",p);t==false&&j.hide();return j;case 272:j=$(document.createElement("div"));j.addClass("text");j.css("top",b+"px");j.css("left",e+"px");j.css("width",a+"px");j.css("height",g+"px");j.html(k);j.data("refcon",p);t==false&&j.hide();return j;case 288:k=$(document.createElement("div"));k.addClass("list");k.css("top",b+"px");k.css("left",e+"px");k.css("width",a+"px");k.css("height",g+"px");k.data("refcon",p);t==false&&
k.hide();return k;case 304:return l(e,b,a,g,n,s,w,t,p);default:console.log("Unknown CDEF:"+j);this.die()}};this.get=function(e){var b=e.r16(),a=e.r16(),g=e.r16()-b,j=e.r16()-a,k=e.r16(),t=e.r8()!=0;e.r8();var n=e.r16(),s=e.r16(),w=e.r16(),p=e.r32(),r=e.r8(),f="";if(r!=0)f=e.read(r);return this.create(a,b,j,g,w,f,t,k,s,n,p)};this.move=function(e,b,a){var g=e.position();e.css("left",g.left+b+"px");e.css("top",g.top+a+"px")}};function Sound(x,u){function l(){var a=Array(44+x);a[0]=82;a[1]=73;a[2]=70;a[3]=70;var g=36+x;a[4]=g&255;a[5]=g>>8&255;a[6]=g>>16&255;a[7]=g>>24&255;a[8]=87;a[9]=65;a[10]=86;a[11]=69;a[12]=102;a[13]=109;a[14]=116;a[15]=32;a[16]=16;a[17]=0;a[18]=0;a[19]=0;a[20]=1;a[21]=0;a[22]=1;a[23]=0;a[24]=u&255;a[25]=u>>8&255;a[26]=u>>16&255;a[27]=u>>24&255;a[28]=a[24];a[29]=a[25];a[30]=a[26];a[31]=a[27];a[32]=1;a[33]=0;a[34]=8;a[35]=0;a[36]=100;a[37]=97;a[38]=116;a[39]=97;a[40]=x&255;a[41]=x>>8&255;a[42]=x>>16&
255;a[43]=x>>24&255;for(g=0;g<x;g++)a[44+g]=e.data[g];g="";var j,k,t="",n,s;k="";var w=0;do{j=a[w++];k=a[w++];t=a[w++];n=j>>2;j=(j&3)<<4;if(k==undefined)s=k=64;else if(t==undefined){j|=k>>4;k=64}else{j|=k>>4;s=(k&15)<<2|t>>6;k=t&63}g+=b.charAt(n)+b.charAt(j)+b.charAt(s)+b.charAt(k)}while(w<a.length);return g}var e=this,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.data=Array(x);this.time=function(){return x/u};this.play=function(){var a=$(document.createElement("audio"));
$(document.body).append(a);a.attr("src","data:audio/x-wav;base64,"+l());var g=webventure.setting("volume");if(g==null)g=100;a.attr("volume",g/100);a.bind("ended",function(){a.remove()});a.get(0).play()}}
function SoundManager(x){var u=false;try{var l=document.createElement("audio").canPlayType("audio/wav");u=l!=""&&l!="no"}catch(e){}this.muted=false;this.play=function(b){var a=x.get(4,b);b=new File(a);var g=undefined;switch(a.charCodeAt(5)&255){case 16:var j=[];b.seek(408,b.set);for(var k=0;k<16;k++)j[k]=b.r8();var t=b.r32()*2;b.r16();k=b.r32()*22100/65536|0;var n=new Sound(t,k),s;for(k=0;k<t;k++){if(k&1)s>>=4;else s=b.r8();n.data[k]=j[s&15]}g=n;break;case 18:b.seek(12,b.set);j=b.r16();b.seek(52,
b.set);s=b.r16()+52;b.seek(s,b.set);t=b.r32()-6;b.r16();k=b.r32()*22100/65536|0;k=new Sound(t*j,k);n=0;a=b.seek(226,b.set)+226;for(g=0;g<j;g++){b.seek(a+g*2,b.set);var w=b.r16();b.seek(s+10,b.set);for(var p=0;p<t;p++){var r=b.r8();if(r&128){r-=128;r=r*w;r=r>>8&255;if(r&128)r=127;r+=128}else{r=(r^255)+1;r-=128;r=r*w;r=r>>8&255;if(r&128)r=127;r+=128;r=(r^255)+1}k.data[n++]=r}}g=k;break;case 24:j=[];b.seek(594,b.set);for(k=0;k<16;k++)j[k]=b.r8();s=b.r32()*2;b.r16();k=b.r32()*22100/65536|0;n=new Sound(s,
k);for(k=0;k<s;k++){if(k&1)t>>=4;else t=b.r8();n.data[k]=j[t&15]}g=n;break;case 26:j=[];b.seek(544,b.set);for(t=0;t<16;t++)j[t]=b.r8();s=b.r32();b.r16();t=b.r32()*22100/65536|0;n=new Sound(s,t);for(t=0;t<s;t++){if(t&1)k>>=4;else k=b.r8();n.data[t]=j[k&15]}g=n;break;case 68:b.seek(94,b.set);j=b.r32();s=b.r32()*22100/65536|0;s=new Sound(j,s);for(t=0;t<j;t++)s.data[t]=b.r8();g=s;break;case 120:j=[];b.seek(186,b.set);for(t=0;t<16;t++)j[t]=b.r8();b.r32();s=b.r32();t=b.r32()*22100/65536|0;k=new Sound(s,
t);for(t=0;t<s;t++){if(t&1)n<<=4;else n=b.r8();k.data[t]=j[n>>4&15]}g=k;break;case 126:s=[];b.seek(194,b.set);for(k=0;k<16;k++)s[k]=b.r8();b.r32();t=b.r32();k=b.r32()*22100/65536|0;n=new Sound(t,k);a=128;for(k=0;k<t;k++){if(k&1)j<<=4;else j=b.r8();a+=s[j>>4&15];n.data[k]=a&255}g=n}if(g==undefined)return 0;else{u&&!this.muted&&g.play();return g.time()}}};function Menu(x,u){this.id=x;this.title=u;this.el=undefined;var l=[];this.add=function(e){l.push(e)};this.draw=function(){var e=$(document.createElement("table"));e.addClass("menu");var b=$(document.createElement("tbody"));e.append(b);var a=this.el.position();e.css("top",a.top+19+"px");e.css("left",a.left+"px");for(a=0;a<l.length;a++){var g=l[a].draw();b.append(g)}return e}}
function MenuItem(x,u){this.draw=function(){var l=$(document.createElement("tr"));if(x=="-"){var e=$(document.createElement("td"));e.attr("colspan","2");e.addClass("divider");e.append(document.createElement("hr"))}else{l.addClass("menuitem");e=$(document.createElement("td"));e.html(x);l.append(e);e=$(document.createElement("td"));if(u!=0){e.addClass("shortcut");e.append(String.fromCharCode(u))}}l.append(e);return l}}
function MenuManager(x){function u(b){if(!webventure.isPaused){for(var a,g=0,j=$(b.target);j.data("refCon")==undefined;)j=j.parent();j.addClass("active");b=j.data("refCon");for(a=0;a<l.length;a++)if(l[a].id==b)break;var k=l[a].draw();x.append(k);$(document).mousemove(function(t){var n=e.position();if(t.pageX>=n.left&&t.pageY>n.top&&t.pageX<n.left+e.width()&&t.pageY<n.top+e.height())for(a=0;a<l.length;a++){n=l[a].el.position();var s=(l[a].el.outerWidth()-l[a].el.width())/2;if(t.pageX>=n.left-s&&t.pageX<
n.left-s+l[a].el.outerWidth()){k.remove();j.removeClass("active");j=l[a].el;j.addClass("active");k=l[a].draw();x.append(k);break}}else{n=k.position();if(t.pageX>=n.left&&t.pageY>=n.top&&t.pageX<n.left+k.width()&&t.pageY<n.top+k.height()){t.pageY-=n.top;k.find("tr").each(function(w,p){n=$(p).position();if(t.pageY>=n.top&&t.pageY<n.top+$(p).height()){if($(p).hasClass("menuitem")){g=w+1;$(p).addClass("active")}}else $(p).removeClass("active")})}else{k.find("tr").each(function(w,p){$(p).removeClass("active")});
g=0}}});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");k.remove();j.removeClass("active");g&&webventure.menuSelect(l[a].id,g)})}}var l=[],e;this.get=function(b){var a=b.r16();b.seek(12,b.cur);var g=b.r8(),j="";if(g!=0)j=b.read(g);if(g==1)j="";for(a=new Menu(a,j);;){j=b.r8();if(j==0)break;g="";if(j!=0)g=webventure.mac2ascii(b.read(j));b.r8();j=b.r8();var k=b.r8(),t=b.r8();g=new MenuItem(g,j,k,t);a.add(g)}l.push(a)};this.show=function(){e=$(document.createElement("div"));
e.addClass("menubar");for(var b in l){var a=$(document.createElement("div"));a.addClass("menu");l[b].title==""?a.addClass("apple"):a.append(l[b].title);a.data("refCon",l[b].id);a.mousedown(function(g){u(g);return false});l[b].el=a;e.append(a)}x.append(e)};this.addDA=function(b){l[0].add(new MenuItem(b,0,0,0))}};webventure.init();
