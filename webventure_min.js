function WebVenture(){function w(){if(ha.isReady()){h.gameState=0;for(var c,d=1;c==undefined&&d<5;d++)c=ha.getResByKind("APPL","MCV"+d);H.open(c);d=H.getIndStr(129,2);c=ha.getRes(d);if(c!=undefined){c=H.open(c);d=decodePPIC(H.get("PPIC",0));H.close(c)}else d=decodePack(ha.getData(d));va.remove();va=undefined;Ga=K.create("","plainDBox",false,false,0,0,512,342);Ga.show();d.draw(Ga.port,0,0);for(d=0;d<5;d++)wa.load(d,H.getIndStr(129,d+4));d=H.get("GNRL",128);xa=d.r16();Ja=d.r16();Aa=d.r16();ya=d.r16();
Ka=d.r16();d.r16();U={};U.top=d.r16();U.left=d.r16();U.height=d.r16();U.width=d.r16();U.stepy=d.r16();U.stepx=d.r16();U.num=0;d.r16();d.r16();La=Array(ya);for(c=0;c<ya;c++)La[c]=d.r8();Ha=Array(ya);for(c=0;c<ya;c++)Ha[c]=d.r16();Ma=Array(ya);for(c=0;c<ya;c++)Ma[c]=d.r8();Sa=Array(Aa);for(c=0;c<Aa;c++)Sa[c]=d.r8();Ta=Array(Aa);for(c=0;c<Aa;c++)Ta[c]=d.r8();Ba=[];j();Z=[];h.queue=[];h.soundQueue=[];h.textQueue=[];aa=Array(xa*2);ba.setHuff(H.get("GNRL",131));commandsWin=K.get(H.get("WIND",128));commandsWin.kind=
9;commandsWin.addClass("commands");for(d=0;d<Aa;d++)Ta[d]&&commandsWin.add(V.get(H.get("CNTL",129+d)));X=K.get(H.get("WIND",129));X.kind=10;qa=K.get(H.get("WIND",130));qa.kind=11;ca=$(document.createElement("div"));ca.addClass("textEdit");qa.setCanvas(ca);ua=K.get(H.get("WIND",131));ua.kind=12;ua.refCon={id:0,x:0,y:0,children:[{id:1,top:0,left:0,width:0,height:0}]};da=K.get(H.get("WIND",132));da.kind=13;da.addClass("exits");for(d=128;d<=133;d++)Ua.get(H.get("MENU",d));qa.setTitle(H.getIndStr(128,
1));if(gameparts.length>1){oa=gameparts[1];c=JSON.parse(localStorage.getItem(oa));ia=c.gamedata;h.globals=c.globals;ca.html(c.text);qa.setTitle(oa)}else{c=ha.getData(H.getString(133));ia=Array(Ka);h.globals=Array(Ja);for(d=0;d<Ka;d++){ia[d]=Array(xa);for(var m=0;m<xa;m++)ia[d][m]=c.r16()}for(d=0;d<Ja;d++)h.globals[d]=c.r16()}e();if(oa==""){h.cmdReady=true;h.selectedCtl=1;R.push(h.get(1,0))}setTimeout(u,500)}else setTimeout(w,10)}function u(){K.close(Ga);Ga=undefined;Ua.show();commandsWin.show();ua.show();
h.updateWindow(ua);da.show();qa.show();X.show();h.gameState=1;ca.scrollTop(1E4);h.set(h.get(1,0),6,1);h.gameChanged=false;h.runMain()}function j(){h.selectedCtl=0;ra=undefined;R=[];W=0;Y={h:0,v:0};ba.input="";h.cmdReady=false;Na=0}function e(){for(var c,d,m=0;m<xa*2;m++)aa[m]=0;for(m=xa-1;m;m--){c=ia[0][m];if(d=aa[c*2])aa[m*2+1]=d;aa[c*2]=m}}function b(c){if(c)(c=p(c))&&K.bringToFront(c)}function a(c){if(Ba.indexOf(c)==-1){Ba.push(c);var d={};d.obj=c;d.parent=h.get(c,0);d.x=h.get(c,1);d.y=h.get(c,
2);d.exitx=h.get(c,9);d.exity=h.get(c,10);d.hidden=h.get(c,11);d.offscreen=h.get(c,3);d.invisible=h.get(c,4);h.queue.push({id:7,val:d})}}function f(){if(h.gameState==2){K.closeAll();var c=H.getString(131),d=ha.getRes(c),m;if(d!=undefined){d=H.open(d);var y=H.get("PPIC",0);if(y!=undefined)m=decodePPIC(y);H.close(d)}if(m==undefined)m=decodePack(ha.getData(c));Oa=K.get(H.get("WIND",133));Oa.show();m.draw(Oa.port,0,0);k();h.gameState=4}else if(h.gameState==3){x();var B=K.getAlert(H.get("ALRT",134));B.show();
h.modalDialog=function(F){K.close(B);switch(F){case 1:l();break;case 3:h.gameState=4;h.runMain();break;default:O()}}}}function k(){var c=document.createElement("link");c.type="text/css";c.rel="stylesheet";c.href="print.css";c.media="print";$("head").append(c);var d=H.get("GNRL",129);d.r16();c=d.r16();var m=d.r16(),y=d.r16(),B=d.r16()-m;d=d.r16()-y;K.getDialog(H.get("DLOG",135)).show();h.isPaused=true;var F=V.create(y,m,d,B,4096,"",true,0,0,0,4);Oa.add(F);F.css("text-align","center");F.css("font-size",
c+"px");F.css("line-height",B+"px");F.focus();h.modalDialog=function(G){switch(G){case 1:F.blur();window.print();break;case 2:h.runMain()}}}function l(){for(var c=ha.getData(H.getString(133)),d=0;d<Ka;d++)for(var m=0;m<xa;m++)ia[d][m]=c.r16();for(d=0;d<Ja;d++)h.globals[d]=c.r16();s();e();qa.setTitle(H.getIndStr(128,1));ca.html("");h.selectedCtl=1;R=[h.get(1,0)];h.gameState=1;h.set(h.get(1,0),6,1);Ca=Da=Ea=h.gameChanged=false;sa.reset();h.cmdReady=true;h.runMain()}function n(){if(oa=="")r();else{localStorage.setItem(oa,
JSON.stringify({game:gamename,gamedata:ia,globals:h.globals,text:ca.html()}));qa.setTitle(oa);h.gameChanged=false;za()}}function r(){var c=K.createDialog("","dBox",true,false,104,79,304,184,undefined);c.add(V.create(218,132,70,18,0,"Save",true,0,0,0,1));c.add(V.create(218,158,70,18,0,"Cancel",true,0,0,0,2));c.add(V.create(14,136,183,16,4352,"Save as:",true,0,0,0,3));c.add(V.create(17,157,177,16,4096,"",true,0,0,0,7));c.add(V.create(14,29,183,98,4608,"",true,0,0,0,8));c.kind=2;h.isPaused=true;c.show();
for(var d=c.getItem(8),m=undefined,y=0;y<localStorage.length;y++){var B=localStorage.key(y);if(JSON.parse(localStorage.getItem(B)).game==gamename){var F=$(document.createElement("div"));F.addClass("listitem");F.click(function(G){m&&m.removeClass("active");m=$(G.target);m.addClass("active");c.getItem(7).val(m.text())});F.text(B);d.append(F)}}h.modalDialog=function(G){switch(G){case 1:oa=c.getItem(7).val();K.close(c);h.isPaused=false;n();break;case 2:K.close(c);h.isPaused=false;za()}}}function s(){K.reset();
U.num=0;h.queue=[];h.soundQueue=[];h.textQueue=[];Ba=[]}function x(){for(ra&&ra.removeClass("active");Z.length;)t(Z.pop());j()}function t(c){var d=da.find(c);if(d)Z.indexOf(c)!=-1?d.addClass("active"):d.removeClass("active");if(c==h.get(1,0))Z.indexOf(c)!=-1?da.addClass("selected"):da.removeClass("selected");h.updateWindow(h.getParentWin(c))}function p(c){switch(c){case 65532:return da;case 65533:return ua;case 65534:return qa;case 65535:return commandsWin}return K.find(c)}function g(c,d){for(var m=
[],y=aa[c*2];y;){m.push(y);d||(m=m.concat(g(y,false)));y=aa[y*2+1]}return m}function o(c){if(!p(c))if(c==h.get(1,0)){L(c,X);h.updateWindow(X);M();var d=ba.get(c);X.setTitle(ba.capitalize(d))}else{var m={h:h.get(c,1),v:h.get(c,2)};h.getParentWin(c).localToGlobal(m);var y=E();d=ba.get(c);var B=K.create(d,"zoomDoc",false,true,y.left,y.top,y.width,y.height);B.kind=14;B.scrollbars();L(c,B);B.refCon.flag=true;var F=$(document.createElement("div"));c=ja.position();F.addClass("zoom");ja.append(F);F.css("top",
m.v+"px");F.css("left",m.h+"px");F.css("width","0px");F.css("height","0px");F.animate({top:y.top+c.top+"px",left:y.left+c.left+"px",width:y.width+"px",height:y.height+"px"},500,function(){F.remove();B.show();h.updateWindow(B)})}}function z(c){var d=K.tryClose(p(c));if(d!=undefined){c=h.getParentWin(d.obj);if(c!=undefined){var m=$(document.createElement("div"));m.addClass("zoom");ja.append(m);m.css("top",d.top+"px");m.css("left",d.left+"px");m.css("width",d.width+"px");m.css("height",d.height+"px");
d={h:h.get(d.obj,1),v:h.get(d.obj,2)};c.localToGlobal(d);m.animate({top:d.v+"px",left:d.h+"px",width:"0px",height:"0px"},500,function(){m.remove();U.num--})}}}function A(c,d,m){var y={},B={h:0,v:0};c.localToGlobal(B);y.minx=B.h;y.miny=B.v;y.maxx=B.h+c.port.width();y.maxy=B.v+c.port.height();var F=$(document.createElement("div"));F.addClass("lasso");ja.append(F);F.css("top",d.pageY+"px");F.css("left",d.pageX+"px");F.css("width","0px");F.css("height","0px");$(document).mousemove(function(G){var T=Math.max(Math.min(d.pageX,
G.pageX),y.minx),I=Math.max(Math.min(d.pageY,G.pageY),y.miny),P=Math.min(Math.max(d.pageX,G.pageX),y.maxx);G=Math.min(Math.max(d.pageY,G.pageY),y.maxy);F.css("top",I+"px");F.css("left",T+"px");F.css("width",P-T+"px");F.css("height",G-I+"px")});$(document).mouseup(function(G){$(document).unbind("mousemove");$(document).unbind("mouseup");var T=Math.max(Math.min(d.pageX,G.pageX),y.minx),I=Math.max(Math.min(d.pageY,G.pageY),y.miny),P=Math.min(Math.max(d.pageX,G.pageX),y.maxx),Xa=Math.min(Math.max(d.pageY,
G.pageY),y.maxy);F.remove();G={h:T,v:I};c.globalToLocal(G);I={top:G.v,left:G.h,width:P-T,height:Xa-I};T=[];for(P=0;P<c.refCon.children.length;P++){var fa=c.refCon.children[P].id;if(!h.get(fa,4)){I.left=G.h-h.get(fa,1);I.top=G.v-h.get(fa,2);pa(fa,I)&&T.push(fa)}}if(d.shiftkey){if(T.length==0){if(R.length==0||c!=h.getParentWin(R[0]))R.indexOf(c.refCon.id)!=-1?ka(c.refCon.id):h.selectObj(c.refCon.id)}else for(;T.length;){fa=T.shift();R.indexOf(fa)!=-1?ka(fa):h.selectObj(fa)}h.runMain()}else{if(T.length==
0)fa=c.refCon.id;else for(;T.length;){fa=T.shift();h.selectObj(fa)}h.handleObjectSelect(fa,c,d,m)}})}function E(){for(var c=U.left,d=U.top,m=0;m<U.num;m++){c+=U.stepx;d+=U.stepy;if(d>=330)d=U.top;if(c>=500)c=U.left}U.num++;return{top:d,left:c,width:U.width,height:U.height}}function L(c,d){var m=g(c,true);d.refCon={id:c,x:0,y:0,flag:false,children:[]};for(var y=32767,B=32767,F=0;F<m.length;F++)if(m[F]!=1){child={id:m[F],top:0,left:0,width:0,height:0};if(d!=X){var G=h.get(c,1),T=h.get(c,2);if(y>G)y=
G;if(B>T)B=T}d.refCon.children.push(child)}if(y!=32767)d.refCon.x=y-8;if(B!=32767)d.refCon.y=B-8;if(d!=X)d.refCon.flag=true}function M(){da.killControls();for(var c=g(h.get(1,0),true),d=0;d<c.length;d++)ea(c[d])}function ea(c){if(h.get(c,8)){var d=da.find(c);d&&da.remove(d);if(!h.get(c,11)&&h.get(c,0)==h.get(1,0)){d=V.get(H.get("CNTL",128));d.data("refcon",c);V.move(d,h.get(c,9),h.get(c,10));da.add(d)}}}function J(){if(Da){Da=false;if(sa.resume())return Da=true;return false}if(Ca){Ca=false;if(sa.resume())return Ca=
true;h.updateScreen(false)}for(;R.length;){var c=R.shift();if((h.gameState==0||h.gameState==1)&&la(c)){if(sa.run(h.selectedCtl,c,W,Y))return Ca=true;h.updateScreen(false)}}if(h.selectedCtl==1)h.gameChanged=false;else if(h.gameState==0||h.gameState==1)if(sa.run(3,h.selectedCtl,W,Y))return Da=true;return false}function la(c){if(!ta(c))return false;if(ma()>=2&&W>0&&!ta(W))return false;if(h.selectedCtl!=5)return true;if(!(h.get(c,3)==0&&h.get(c,4)==0&&h.get(c,5)==0))return false;if(h.get(1,0)!=W)return true;
var d={top:0,left:0,width:X.port.width(),height:X.port.height()};d.top-=h.get(c,2)+Y.v;d.left-=h.get(c,1)+Y.h;return pa(c,d)}function pa(c,d){var m={top:0,left:0,width:0,height:0},y;if(y=ga.get(c*2+1)){m.width=y.width;m.height=y.height;if(ga.sectRect(m,d,m))return y.intersect(m);return false}if(y=ga.get(c*2)){m.width=y.width;m.height=y.height;return ga.sectRect(m,d,m)}return false}function ta(c){for(var d=h.get(1,0);c!=0&&c!=1&&c!=d;)c=h.get(c,0);return c}function ma(){if(!h.selectedCtl)return 3E3;
return Sa[h.selectedCtl-1]}function ka(c){var d=R.indexOf(c);d!=-1&&R.splice(d,1);if((d=Z.indexOf(c))!=-1){Z.splice(d,1);t(c)}}function C(){var c=H.get(H.getIndStr(129,1),0),d=c.r8();c=h.mac2ascii(c.read(d));var m=K.createDialog("","dBox",true,false,146,96,220,150,undefined);m.add(V.create(75,120,70,18,0,"Ok",true,0,0,0,1));m.add(V.create(20,30,180,40,4352,c,true,0,0,0,2));m.add(V.create(20,80,180,40,4352,"WebVenture <br /> &#169; 2010 Sean Kasun",true,0,0,0,3));m.getItem(2).css("text-align","center");
m.getItem(3).css("text-align","center");m.kind=2;h.isPaused=true;m.show();h.modalDialog=function(){K.close(m);h.isPaused=false}}function D(){if(h.gameChanged){var c=h.mac2ascii(H.getIndStr(128,8)),d=K.getAlert(H.get("ALRT",131));h.isPaused=true;d.param([c]);d.show();h.modalDialog=function(m){K.close(d);switch(m){case 1:za=D;n();break;case 2:h.isPaused=false;break;case 3:l()}}}else l()}function Q(){if(h.gameChanged){var c=h.mac2ascii(H.getIndStr(128,9)),d=K.getAlert(H.get("ALRT",131));d.param([c]);
d.show();h.isPaused=true;h.modalDialog=function(m){K.close(d);switch(m){case 1:za=Q;n();break;case 2:h.isPaused=false;break;case 3:O()}}}else O()}function O(){var c=K.createDialog("","dBox",true,false,82,71,348,200,undefined);c.add(V.create(256,138,80,18,0,"Open",true,0,0,0,1));c.add(V.create(256,163,80,18,0,"Cancel",true,0,0,0,3));c.add(V.create(12,39,218,146,4608,"",true,0,0,0,7));c.kind=2;h.isPaused=true;c.show();for(var d=c.getItem(7),m=undefined,y=0;y<localStorage.length;y++){var B=localStorage.key(y);
if(JSON.parse(localStorage.getItem(B)).game==gamename){var F=$(document.createElement("div"));F.addClass("listitem");F.click(function(G){m&&m.removeClass("active");m=$(G.target);m.addClass("active")});F.text(B);d.append(F)}}h.modalDialog=function(G){switch(G){case 1:if(m==undefined)break;oa=m.text();K.close(c);h.isPaused=false;G=JSON.parse(localStorage.getItem(oa));ia=G.gamedata;h.globals=G.globals;s();e();qa.setTitle(oa);ca.html(G.text);ca.scrollTop(1E4);h.gameState=1;Ca=Da=Ea=false;R=[];h.selectedCtl=
0;sa.reset();h.set(h.get(1,0),6,1);h.gameChanged=false;h.runMain();break;case 3:K.close(c);h.isPaused=false}}}function N(){if(h.gameChanged){var c=h.mac2ascii(H.getIndStr(128,7)),d=K.getAlert(H.get("ALRT",131));d.param([c]);d.show();h.isPaused=true;h.modalDialog=function(m){K.close(d);switch(m){case 1:za=N;n();break;case 2:h.isPaused=false;break;case 3:h.gameState=4;h.runMain()}}}else{h.gameState=4;h.runMain()}}function na(c){if(c!=W){var d;if(W>0&&(d=Z.indexOf(W))!=-1&&R.indexOf(W)==-1){Z.splice(d,
1);t(W)}W=c;if(Z.indexOf(W)==-1){Z.push(W);t(W)}h.cmdReady=true}}function Pa(c,d,m,y){var B=m.pageX,F=m.pageY,G={h:0,v:0},T=false;S=undefined;y&&$(document).mousemove(function(I){if(S==undefined){if(Math.abs(I.pageX-B)+Math.abs(I.pageY-F)<=7)return false;T=true;S=Ia(c);var P=h.getChildIdx(d.refCon.children,c);if(P){G.h=d.refCon.children[P-1].left;G.v=d.refCon.children[P-1].top}d.localToGlobal(G);S.css("top",G.v+"px");S.css("left",G.h+"px")}P=S.position();S.css("top",P.top+(I.pageY-F)+"px");S.css("left",
P.left+(I.pageX-B)+"px");B=I.pageX;F=I.pageY;return false});$(document).mouseup(function(I){var P;if(y){$(document).unbind("mousemove");if(S){P=S.position();S.remove()}}$(document).unbind("mouseup");if(T){Y.h=P.left;Y.v=P.top;I=Wa(I.pageX,I.pageY);W=I.id;Y.h-=G.h;Y.v-=G.v;if(I.win!=d){d.localToGlobal(Y);I.win&&I.win.globalToLocal(Y)}h.selectedCtl=5;h.activateCommand(5);h.cmdReady=true}if(!h.cmdReady){na(c);if(!h.selectedCtl){h.selectedCtl=4;h.activateCommand(4);h.cmdReady=true}}h.runMain()})}function Fa(c,
d,m,y){var B=m.pageX,F=m.pageY,G={h:0,v:0},T=false;S=undefined;y&&$(document).mousemove(function(I){if(S==undefined){if(Math.abs(I.pageX-B)+Math.abs(I.pageY-F)<=7)return false;T=true;S=Ia(c);var P=h.getChildIdx(d.refCon.children,c);if(P){G.h=d.refCon.children[P-1].left;G.v=d.refCon.children[P-1].top}d.localToGlobal(G);S.css("top",G.v+"px");S.css("left",G.h+"px")}P=S.position();S.css("top",P.top+(I.pageY-F)+"px");S.css("left",P.left+(I.pageX-B)+"px");B=I.pageX;F=I.pageY;return false});$(document).mouseup(function(I){Na=
I.timeStamp;var P;if(y){$(document).unbind("mousemove");if(S){P=S.position();S.remove()}}$(document).unbind("mouseup");if(T){Y.h=P.left;Y.v=P.top;I=Wa(I.pageX,I.pageY);W=I.id;Y.h-=G.h;Y.v-=G.v;if(I.win!=d){d.localToGlobal(Y);I.win&&I.win.globalToLocal(Y)}h.selectedCtl=5;h.activateCommand(5);h.cmdReady=true}if(ma()==1)h.cmdReady=true;h.runMain()})}function Qa(c){ja.append(S);var d={h:h.get(c,1),v:h.get(c,2)};h.getParentWin(c).localToGlobal(d);S.animate({top:d.v+"px",left:d.h+"px"},300,function(){S.remove()})}
function Ia(c){var d=ga.get(c*2);c=ga.get(c*2+1);var m=d.width,y=d.height;if(c){if(m<c.width)m=c.width;if(y<c.height)y=c.height}var B=$(document.createElement("canvas"));B.addClass("proxy");B.attr("width",m);B.attr("height",y);ja.append(B);c?c.bic(B,0,0):ga.fill(B,0);d.xor(B,0,0);return B}function Wa(c,d){var m=K.findWindow(c,d),y=0;if(m.win!=undefined)y=m.win.kind;if(m.id==3&&(y==14||y==10))m.id=m.win.refCon.id;else switch(y){case 9:m.id=-1;break;case 11:m.id=-2;break;case 12:m.id=-3;break;case 13:m.id=
-4;break;default:switch(m.id){case 0:m.id=-5;break;case 1:m.id=-6;break;case 2:m.id=-7;break;case 3:m.id=-8;break;case 4:m.id=-9;break;case 5:m.id=-10;break;case 6:m.id=-11;break;default:m.id=-12}}return m}var h=this,ja,K,ha,wa,ba,H,sa,V,Ua,ga,Va,va,Ga,Oa,X,qa,ua,da,ca;this.gameState=0;this.gameChanged=false;var xa,Ja,Aa,ya,Ka,U,La,Ha,Ma,Sa,Ta,Ba,Z,R;this.textQueue=this.soundQueue=this.queue=undefined;var ra,W,Y;this.cmdReady=false;this.selectedCtl=undefined;var Na,aa,oa="",ia;this.globals=undefined;
var Ea=false;var Da=this.isPaused=false,Ca=false;this.init=function(){var c=document.createElement("link");c.type="text/css";c.rel="stylesheet";c.href="game.css";$("head").append(c);ja=$(document.createElement("div"));ja.addClass("screen");va=$(document.createElement("img"));va.attr("src","images/start.png");va.css("width","100%");va.css("height","100%");ja.append(va);$("script").filter(function(){return this.src.match(/webventure_(min|full)\.js/)}).after(ja);ha=new FileManager(gamename);H=new ResourceManager(ha);
wa=new ObjectManager(ha);ba=new TextManager(wa,H);V=new ControlManager;K=new WindowManager(ja,H,V);ga=new GraphicManager(wa);Va=new SoundManager(wa);Ua=new MenuManager(ja);sa=new Engine(wa,ba,H,ga);w()};this.get=function(c,d){var m,y=La[d];if(y&128){var B=wa.get(0,c);if(B.length==0)return 0;y&=127;m=(B.charCodeAt(y*2)&255)<<8;m|=B.charCodeAt(y*2+1)&255}else m=ia[y][c];m&=Ha[d];return ha.neg16(m>>Ma[d])};this.set=function(c,d,m){if(d==0){var y=m,B=ia[0][c];if(y!=c){var F=B*2;for(B=aa[F];B!=c;){F=B*
2+1;B=aa[F]}aa[F]=aa[B*2+1];F=y*2;for(B=aa[F];B&&B<=c;){F=B*2+1;B=aa[F]}aa[c*2+1]=B;aa[F]=c}}d<12&&a(c);idx=La[d];m<<=Ma[d];m&=Ha[d];ia[idx][c]=m|ia[idx][c]&~Ha[d];h.gameChanged=true};this.updateObject=function(c){var d;if(d=this.get(1,0)==c?X:p(c)){b(c);h.runQueue();h.updateWindow(d)}};this.updateWindow=function(c){if(c!=undefined)if(c.refCon!=undefined)if(c==ua||h.get(c.refCon.id,6)==1){c==X?ga.get(c.refCon.id*2).draw(X.port,0,0):ga.fill(c.port,0);for(var d=0;d<c.refCon.children.length;d++){var m=
h.drawObject(c.refCon.children[d].id,c,0);c.refCon.children[d].top=m.top;c.refCon.children[d].left=m.left;c.refCon.children[d].width=m.width;c.refCon.children[d].height=m.height}}};this.drawObject=function(c,d,m){var y=h.get(c,1),B=h.get(c,2),F=h.get(c,3);if(m||!F||!h.get(c,4)){var G=1;if(F||m)G=0;else if(Z.indexOf(c)!=-1)G=2;return ga.draw(c,y,B,d.port,G)}return{top:0,left:0,width:0,height:0}};this.runMain=function(){if(h.gameState==4)window.location="index.html";else{Ea||h.updateScreen(false);if(h.cmdReady||
Ea){Ea=false;if(J()){Ea=true;h.isPaused=true;return}h.isPaused=false;h.updateScreen(false);x()}if(h.gameState==2||h.gameState==3)f()}};this.updateScreen=function(c){this.runQueue();this.printTexts();return this.playSounds(c)};this.runQueue=function(){for(;h.queue.length;){for(var c,d=0,m=0;m<h.queue.length;m++)if(h.queue[m].id>d){d=h.queue[m].id;c=m}d=h.queue.splice(c,1)[0];switch(d.id){case 2:b(d.val);break;case 3:o(d.val);break;case 4:z(d.val);break;case 7:a:{m=d.val;var y=false;d=m.obj;var B=Ba.indexOf(d);
B!=-1&&Ba.splice(B,1);if(d==1){m.parent!=h.get(d,0)&&h.queue.push({id:12});if(m.offscreen!=h.get(d,3)||m.invisible!=h.get(d,4))h.updateWindow(h.getParentWin(d))}else if(m.parent!=h.get(d,0)||m.x!=h.get(d,1)||m.y!=h.get(d,2)){if(B=p(m.parent)){y=B;if(y.refCon!=undefined){B=h.getChildIdx(y.refCon.children,d);if(B!=0){y.refCon.children.splice(B-1,1);y.refCon.flag=true;h.updateWindow(y)}}y=true}if(B=h.getParentWin(d)){y=B;if(y.refCon!=undefined){B=void 0;for(B=0;B<y.refCon.children.length&&d>y.refCon.children[B].id;B++);
if(B==y.refCon.children.length||d!=y.refCon.children[B].id){y.refCon.children.splice(B,0,{id:d,top:0,left:0,width:0,height:0});h.updateWindow(y)}}y=true}}else if(m.offscreen!=h.get(d,3)||m.invisible!=h.get(d,4))h.updateWindow(h.getParentWin(d));if(h.get(d,8))if(y||m.hidden!=h.get(d,11)||m.exitx!=h.get(d,9)||m.exity!=h.get(d,10))ea(d);m=p(d);y=d;for(B=h.get(1,0);y!=B;){if(y==0||!h.get(y,6))break;y=h.get(y,0)}if(y==B){if(m)break a;h.queue.push({id:3,val:d})}else{if(!m)break a;h.queue.push({id:4,val:d})}d=
g(d,true);for(B=0;B<d.length;B++)a(d[B])}break;case 8:d=d.val;y=p(d.from);(m=B=p(d.to))||(m=y);if(m){y=ba.get(d.to);m.setTitle(y);L(d.to,m);m.refCon.flag=true;h.updateWindow(m)}break;case 12:h.set(X.refCon.id,6,0);h.set(h.get(1,0),6,1);break;case 13:for(;Z.length;)t(Z.pop());break;case 14:Qa(d.val)}}};this.playSounds=function(c){for(var d=0;h.soundQueue.length;){var m=h.soundQueue.splice(0,1)[0];switch(m.id){case 1:Va.play(m.val);break;case 2:d=Va.play(m.val);break;case 3:console.log("wait?")}}if(c&&
d){setTimeout(h.runMain,d*1E3);return true}return false};this.printTexts=function(){for(;h.textQueue.length;){var c=h.textQueue.splice(0,1)[0];switch(c.id){case 1:ca.append(c.val);ca.scrollTop(1E4);h.gameChanged=true;break;case 2:ca.append("<br/>");ca.scrollTop(1E4);h.gameChanged=true;break;case 3:ba.source=c.val[1];ba.target=c.val[0];ca.append(ba.get(c.val[2]));ca.scrollTop(1E4);h.gameChanged=true}}};this.invertmain=function(){X.invert()};this.revertmain=function(){X.invert();h.runMain()};this.getParentWin=
function(c){if(c==1)return ua;if(c=h.get(c,0))return p(c)};this.getFamily=function(c,d){return[c].concat(g(c,d))};this.getChildIdx=function(c,d){var m;for(m=0;m<c.length&&c[m].id!=d;m++);if(m==c.length)return 0;return m+1};this.unselectall=function(){for(;R.length;)ka(R.shift())};this.selectObj=function(c){R.length&&h.getParentWin(c)!=h.getParentWin(R[0])&&h.unselectall();R.indexOf(c)==-1&&R.push(c);if(Z.indexOf(c)==-1){Z.push(c);t(c)}};this.activateCommand=function(c){c=commandsWin.find(c);if(c!=
ra){ra&&ra.removeClass("active");(ra=c)&&c.addClass("active")}};var za=undefined;this.menuSelect=function(c,d){switch(c){case 128:C();break;case 129:switch(d){case 1:D();break;case 3:Q();break;case 4:za=function(){};n();break;case 5:za=function(){};r();break;case 7:N()}break;case 131:switch(d){case 1:cleanup();break;case 2:messup()}break;case 132:doFont(d);break;case 133:doFontSize(d)}};this.buttonClicked=function(c,d){var m=c.data("win");if(m.kind==2)return this.modalDialog(c.data("refcon"));if(m==
da)h.isPaused||h.handleObjectSelect(c.data("refcon"),da,d,false);else if(c.data("refcon")==0){commandsWin.remove(Ra);commandsWin.showControls();h.runMain()}else if(!h.isPaused){ra&&c!=ra&&ra.removeClass("active");h.selectedCtl=c.data("refcon");h.activateCommand(h.selectedCtl);switch(ma()){case 0:h.cmdReady=true;break;case 1:h.cmdReady=R.length!=0;break;case 2:if(W>0)h.cmdReady=true}h.runMain()}};this.handleObjectSelect=function(c,d,m,y){if(d==da)d=X;if(m.shiftKey)if(c){R.indexOf(c)!=-1?ka(c):h.selectObj(c);
h.runMain()}else if(d.kind==14)A(d,m,y);else{if(R.length==0||d!=h.getParentWin(R[0]))R.indexOf(d.refCon.id)!=-1?ka(d.refCon.id):h.selectObj(d.refCon.id);h.runMain()}else if(h.selectedCtl&&R.length&&ma()>1){c?na(c):na(d.refCon.id);h.runMain()}else{if(!c){h.unselectall();if(d.kind==14)A(d,m,y);else c=d.refCon.id}if(c){var B;if(m.timeStamp-Na<=300){Na=0;B=true}else B=false;if(B){R.indexOf(c)==-1&&h.unselectall();h.selectObj(c);Pa(c,d,m,y)}else{R.indexOf(c)==-1&&h.unselectall();h.selectObj(c);Fa(c,d,
m,y)}}}};var S=undefined;this.objHit=function(c,d){var m=0,y;if(y=!this.get(d.id,4))y=c.h>=d.left&&c.v>=d.top&&c.h<d.left+d.width&&c.v<d.top+d.height?true:false;if(y)if(bmp=ga.get(d.id*2+1)){if(bmp.hit(c.h-d.left,c.v-d.top))m=d.id}else m=d.id;return m};var Ra;this.clickToContinue=function(){var c=commandsWin.port.width(),d=commandsWin.port.height();Ra=V.create(4,4,c-8,d-8,2048,"Click to continue",true,0,0,0,0);Ra.addClass("ctc");commandsWin.hideControls();commandsWin.add(Ra)};this.textEntry=function(c,
d,m){ba.target=m;ba.source=d;var y=K.getDialog(H.get("DLOG",132));y.param([ba.get(c)]);y.show();h.modalDialog=function(B){ba.input=y.getItem(3).val();B!=2?sa.push(65535):sa.push(0);K.close(y);h.runMain()}};this.mac2ascii=function(c){for(var d="",m=0;m<c.length;m++)switch(c.charCodeAt(m)){case 13:d+="<br />";break;case 63368:d+="&#224;";break;case 63374:d+="&#233;";break;case 63401:d+="&#169;";break;case 63433:d+="...";break;case 63441:d+="&#8212;";break;default:d+=c.charAt(m)}return d}}
var webventure=new WebVenture;function Win(w,u,j,e,b,a,f,k,l){function n(C,D){var Q=C,O=D;l.bringToFront(L);$(document).mousemove(function(N){var na=J.position();J.css("top",na.top+(N.pageY-O)+"px");J.css("left",na.left+(N.pageX-Q)+"px");Q=N.pageX;O=N.pageY});$(document).mouseup(function(N){$(document).unbind("mousemove");$(document).unbind("mouseup");var na=J.position();J.css("top",na.top+(N.pageY-O)+"px");J.css("left",na.left+(N.pageX-Q)+"px")})}function r(C,D){var Q={h:C,v:D},O=0,N=L.refCon.children.length;for(L.globalToLocal(Q);N>
0&&O==0;){N--;O=webventure.objHit(Q,L.refCon.children[N])}return O}var s=undefined,x=undefined,t=undefined,p=undefined,g=undefined,o=undefined,z=undefined,A=undefined,E=undefined,L=this,M=[];w=undefined;var ea=u=="zoomDoc",J=$(document.createElement("div"));J.addClass(u);if(u!="plainDBox"&&u!="altDBox"&&u!="dBox"){var la="<span></span>";w=$(document.createElement("div"));w.addClass("title");w.mousedown(function(C){webventure.isPaused||n(C.pageX,C.pageY);return false});if(j)la='<div class="close"></div>'+
la;if(ea)la+='<div class="resize"></div>';w.html(la);if(j){la=w.children("div.close");la.mousedown(function(){return false});la.click(function(){if(!webventure.isPaused){if(L.kind==14){webventure.unselectall();webventure.selectObj(L.refCon.id);webventure.selectedCtl=2;webventure.activateCommand(2);webventure.cmdReady=true}webventure.runMain()}return false})}if(ea){la=w.children("div.resize");la.mousedown(function(){return false});la.click(function(){resizeClicked();return false})}J.append(w)}this.port=
$(document.createElement("canvas"));this.port.mousedown(function(C){if(!webventure.isPaused)switch(L.kind){case 9:n(C.pageX,C.pageY);break;case 10:case 14:var D=r(C.pageX,C.pageY),Q=false;if(D&&!webventure.get(D,3))Q=true;webventure.handleObjectSelect(D,L,C,Q);break;case 12:D=r(C.pageX,C.pageY);D==1?webventure.handleObjectSelect(D,L,C,false):n(C.pageX,C.pageY);break;case 13:webventure.handleObjectSelect(webventure.get(1,0),L,C,false)}return false});this.port.attr("width",a);this.port.attr("height",
f);J.append(this.port);var pa=b,ta=f,ma=e,ka=a;if(w!=undefined){pa-=17;ta+=18}if(u=="dBox"){pa-=2;ma-=2;ka+=2;ta+=2}J.css("top",pa+"px");J.css("left",ma+"px");J.css("width",ka+"px");J.css("height",ta+"px");k.append(J);this.show=function(){J.show()};this.hide=function(){J.hide()};this.setTitle=function(C){if(w!=undefined){var D=w.children("span");D.html("");if(C=="")D.hide();else{var Q=J.css("display")=="none";J.show();D.css({position:"absolute",visibility:"hidden",display:"block"});var O=a;if(j)O-=
30;if(ea)O-=30;for(var N=0;N<C.length;N++){D.append(C.substring(N,N+1));if(D.width()>O){D.html(C.substring(0,N-1));break}}D.css({position:"",visibility:"",display:""});Q&&J.hide()}}};this.setCanvas=function(C){this.port.remove();C.css("top","0px");C.css("left","0px");C.css("width",a+"px");C.css("height",f+"px");J.append(C)};this.addClass=function(C){J.addClass(C)};this.removeClass=function(C){J.removeClass(C)};this.add=function(C){if(w!=undefined){var D=parseInt(C.css("top"),10);C.css("top",D+17+
"px")}J.append(C);C.data("win",this);M.unshift(C)};this.remove=function(C){var D=M.indexOf(C);D!=-1&&M.splice(D,1);C.remove()};this.find=function(C){for(var D=0;D<M.length;D++)if(M[D].data("refcon")==C)return M[D]};this.killControls=function(){for(var C=0;C<M.length;C++)M[C].remove();M=[]};this.hideControls=function(){for(var C=0;C<M.length;C++)M[C].hide()};this.showControls=function(){for(var C=0;C<M.length;C++)M[C].show()};this.close=function(){J.remove()};this.globalToLocal=function(C){var D=J.position();
C.h-=D.left;C.v-=D.top;D=this.port.position();C.h-=D.left;C.v-=D.top};this.localToGlobal=function(C){var D=J.position();C.h+=D.left;C.v+=D.top;D=this.port.position();C.h+=D.left;C.v+=D.top};this.hit=function(C,D){pos=J.position();if(C>=pos.left&&C<pos.left+J.width()&&D>=pos.top&&D<pos.top+J.height()){C-=pos.left;D-=pos.top;pos=this.port.position();if(C>=pos.left&&C<pos.left+this.port.width()&&D>=pos.top&&D<pos.top+this.port.height())return{id:3,win:this};return{id:4,win:this}}};this.invert=function(){var C=
L.port.get(0).getContext("2d"),D=L.port.width(),Q=L.port.height();D=C.getImageData(0,0,D,Q);for(Q=0;Q<D.height;Q++)for(var O=Q*D.width*4,N=0;N<D.width;N++){D.data[O++]^=255;D.data[O++]^=255;D.data[O++]^=255;D.data[O++]=255}C.putImageData(D,0,0)};this.param=function(C){for(var D=0;D<M.length;D++){var Q=M[D].text().indexOf("^");if(Q>=0){var O=M[D].text().substr(0,Q),N=M[D].text().substr(Q+1,1);O+=C[parseInt(N,10)];O+=M[D].text().substr(Q+2);M[D].text(O)}}};this.getItem=function(C){for(var D=0;D<M.length;D++)if(M[D].data("refcon")==
C)return M[D]};this.scrollbars=function(){L.port.attr("width",a-15);L.port.attr("height",f-15);s=$(document.createElement("div"));s.addClass("hscroll");s.css("top",18+f-15+"px");s.css("left","0px");s.css("width",a-15+"px");s.css("height","14px");g=$(document.createElement("div"));g.addClass("leftarrow");g.css("top","0px");g.css("left","0px");g.css("width","14px");g.css("height","14px");s.append(g);o=$(document.createElement("div"));o.addClass("rightarrow");o.css("top","0px");o.css("left",a-30+"px");
o.css("width","14px");o.css("height","14px");s.append(o);z=$(document.createElement("div"));z.addClass("slider");z.css("top","0px");z.css("left","15px");z.css("width","30px");z.css("height","12px");s.append(z);J.append(s);x=$(document.createElement("div"));x.addClass("vscroll");x.css("top","17px");x.css("left",a-15+"px");x.css("width","14px");x.css("height",f-15+"px");t=$(document.createElement("div"));t.addClass("uparrow");t.css("top","0px");t.css("left","0px");t.css("width","14px");t.css("height",
"14px");x.append(t);p=$(document.createElement("div"));p.addClass("downarrow");p.css("top",f-30+"px");p.css("left","0px");p.css("width","14px");p.css("height","14px");x.append(p);A=$(document.createElement("div"));A.addClass("slider");A.css("top","15px");A.css("left","0px");A.css("width","12px");A.css("height","30px");x.append(A);J.append(x);E=$(document.createElement("div"));E.addClass("grow");E.css("top",18+f-15+"px");E.css("left",a-15+"px");E.css("width","14px");E.css("height","14px");E.mousedown(function(C){l.bringToFront(L);
var D=$(document.createElement("div"));D.addClass("resizeProxy");k.append(D);var Q=J.position();D.css("top",Q.top+"px");D.css("left",Q.left+"px");var O=ma+ka,N=pa+ta;D.css("width",O-ma+"px");D.css("height",N-pa+"px");var na=C.pageX,Pa=C.pageY;$(document).mousemove(function(Fa){var Qa=O+(Fa.pageX-na),Ia=N+(Fa.pageY-Pa);if(Qa>ma+100){O=Qa;D.css("width",O-ma+"px");na=Fa.pageX}if(Ia>pa+100){N=Ia;D.css("height",N-pa+"px");Pa=Fa.pageY}});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");
D.remove();L.resize(O-ma,N-pa)});return false});J.append(E)};this.resize=function(C,D){ka=C;ta=D;f=D-18;a=ka;J.css("width",ka+"px");J.css("height",ta+"px");s.css("top",18+f-15+"px");s.css("width",a-15+"px");o.css("left",a-30+"px");x.css("left",a-15+"px");x.css("height",f-15+"px");p.css("top",f-30+"px");E.css("top",18+f-15+"px");E.css("left",a-15+"px");L.port.attr("width",a);L.port.attr("height",f);webventure.updateWindow(L)}}
function Dialog(w,u,j,e,b,a,f,k,l,n,r){var s=new Win(w,u,j,e,b,a,f,l,n);s.kind=2;this.show=function(){s.show()};this.hide=function(){s.hide()};this.close=function(){s.close()};this.setTitle=function(x){s.setTitle(x)};this.param=function(x){s.param(x)};this.getItem=function(x){return s.getItem(x)};this.add=function(x){s.add(x)};this.addClass=function(x){s.addClass(x)};this.removeClass=function(x){s.removeClass(x)};if(k!=undefined){w=k.r16()+1;for(u=0;u<w;u++){k.r32();j=k.r16();e=k.r16();b=k.r16()-
j;a=k.r16()-e;f=k.r8();l=k.r8();n="";if(l>0)n=webventure.mac2ascii(k.read(l));l&1&&k.r8();switch(f&127){case 4:j=r.create(e,j,a,b,0,n,true,0,0,0,u+1);s.add(j);break;case 8:j=r.create(e,j,a,b,4352,n,true,0,0,0,u+1);s.add(j);break;case 16:j=r.create(e,j,a,b,4096,n,true,0,0,0,u+1);s.add(j);break;default:console.log("Unknown DITL: "+(f&127));this.die()}}}}
function WindowManager(w,u,j){var e=[];this.create=function(b,a,f,k,l,n,r,s){var x=w.position();l+=x.left;n+=x.top;a=new Win(b,a,k,l,n,r,s,w,this);f==false&&a.hide();a.setTitle(b);this.bringToFront(a);return a};this.createDialog=function(b,a,f,k,l,n,r,s,x){var t=w.position();l+=t.left;n+=t.top;a=new Dialog(b,a,k,l,n,r,s,x,w,this,j);f==false&&a.hide();a.setTitle(b);this.bringToFront(a);return a};this.get=function(b){var a=b.r16(),f=b.r16(),k=b.r16()-a,l=b.r16()-f,n="";switch(b.r16()){case 0:n="document";
break;case 1:n="dBox";break;case 2:n="plainDBox";break;case 3:n="altDBox";break;case 4:n="noGrowDoc";break;case 5:n="movableDBox";break;case 8:n="zoomDoc";break;case 12:n="zoomNoGrow";break;case 16:n="rDoc16";break;case 18:n="rDoc4";break;case 20:n="rDoc6";break;case 22:n="rDoc10"}var r=b.r16()!=0,s=b.r16()!=0;b.r32();var x=b.r8(),t="";if(x!=1)t=webventure.mac2ascii(b.read(x));return this.create(t,n,r,s,f,a,l,k)};this.getDialog=function(b){var a=b.r16(),f=b.r16(),k=b.r16()-a,l=b.r16()-f,n="";switch(b.r16()){case 0:n=
"document";break;case 1:n="dBox";break;case 2:n="plainDBox";break;case 3:n="altDBox";break;case 4:n="noGrowDoc";break;case 5:n="movableDBox";break;case 8:n="zoomDoc";break;case 12:n="zoomNoGrow";break;case 16:n="rDoc16";break;case 18:n="rDoc4";break;case 20:n="rDoc6";break;case 22:n="rDoc10"}var r=b.r8()!=0;b.r8();var s=b.r8()!=0;b.r8();b.r32();var x=b.r16(),t=b.r8(),p="";if(t!=1)p=webventure.mac2ascii(b.read(t));b=u.get("DITL",x);return this.createDialog(p,n,r,s,f,a,l,k,b)};this.getAlert=function(b){var a=
b.r16(),f=b.r16(),k=b.r16()-a,l=b.r16()-f;b=b.r16();b=u.get("DITL",b);return this.createDialog("","dBox",true,false,f,a,l,k,b)};this.close=function(b){for(var a=0;a<e.length;a++)if(e[a]==b){b.close();e.splice(a,1);break}e.length&&this.bringToFront(e[0])};this.tryClose=function(b){if(b!=undefined){var a=b.refCon.id;b.refCon={};if(b.kind==10)b.setTitle("");else{var f={v:0,h:0},k={v:b.port.height(),h:b.port.width()};b.localToGlobal(f);b.localToGlobal(k);this.close(b);return{obj:a,top:f.v,left:f.h,width:k.h-
f.h,height:k.v-f.v}}}};this.find=function(b){for(var a=0;a<e.length;a++)if(e[a].kind==10||e[a].kind==14)if(e[a].refCon!=undefined&&e[a].refCon.id==b)return e[a]};this.bringToFront=function(b){if(e[0]!=b){e[0]!=undefined&&e[0].removeClass("active");for(var a=0;a<e.length;a++)e[a]==b&&e.splice(a,1);e.unshift(b)}b.addClass("active")};this.findWindow=function(b,a){var f=w.position();if(a>=f.top&&a<f.top+20&&b>=f.left&&b<f.left+w.width())return{id:1,win:undefined};for(f=0;f<e.length;f++){var k=e[f].hit(b,
a);if(k!=undefined)return k}return{id:0,win:undefined}};this.reset=function(){for(var b=[],a=0;a<e.length;a++)if(e[a].kind==10||e[a].kind==14)b.push(e[a]);for(a in b)this.tryClose(b[a])};this.closeAll=function(){for(var b=[],a=0;a<e.length;a++)e[a].kind==14?b.push(e[a]):e[a].hide();for(a in b)this.tryClose(b[a])}};function File(w){this.set=0;this.cur=1;this.end=2;this.length=w.length;var u=0;this.bit=0;this.eof=function(){return u>=this.length};this.r8=function(){return w.charCodeAt(u++)&255};this.r16=function(){var j=(w.charCodeAt(u++)&255)<<8;j|=w.charCodeAt(u++)&255;return j};this.r24=function(){var j=(w.charCodeAt(u++)&255)<<16;j|=(w.charCodeAt(u++)&255)<<8;j|=w.charCodeAt(u++)&255;return j};this.r32=function(){var j=(w.charCodeAt(u++)&255)<<24;j|=(w.charCodeAt(u++)&255)<<16;j|=(w.charCodeAt(u++)&255)<<
8;j|=w.charCodeAt(u++)&255;return j};this.peek32=function(){var j=(w.charCodeAt(u)&255)<<24;j|=(w.charCodeAt(u+1)&255)<<16;j|=(w.charCodeAt(u+2)&255)<<8;j|=w.charCodeAt(u+3)&255;return j};this.seek=function(j,e){switch(e){case this.cur:j+=u;break;case this.end:j+=this.length}u=j};this.read=function(j){var e=u;u+=j;return w.substring(e,u)};this.bits=function(j){var e=this.peek32();e>>=32-this.bit-j;e&=(1<<j)-1;this.bit+=j;if(this.bit&16){this.bit&=15;u+=2}return e}}
function MacFile(w,u,j,e,b,a,f,k){this.parent=w;this.name=u;this.type=j;this.creator=e;this.dataStart=b;this.dataLen=a;this.resStart=f;this.resLen=k}
function FileManager(w){function u(k,l){var n=k+l*512;f.seek(n+8,f.set);var r=f.r8();f.r8();var s=f.r16();switch(r){case 0:for(r=0;r<s;r++){f.seek(n+512-(r+1)*2,f.set);var x=f.r16();f.seek(n+x,f.set);var t=f.r8();f.seek(n+x+t+1,f.set);x=f.r32();u(k,x)}break;case 255:for(r=0;r<s;r++){f.seek(n+512-(r+1)*2,f.set);x=f.r16();t=n+x;f.seek(t,f.set);var p=f.r8();if(p!=0){p++;p&1&&p++;f.r8();x=f.r32();var g=f.r8();g=f.read(g);f.seek(t+p,f.set);switch(f.r16()){case 512:f.seek(t+p+4,f.set);var o=f.r32(),z=f.r32();
f.seek(t+p+20,f.set);var A=f.r32();f.seek(2,f.cur);var E=f.r32();f.seek(6,f.cur);var L=f.r32();f.seek(t+p+74,f.set);var M=f.r16();f.seek(t+p+86,f.set);t=f.r16();j[A]=new MacFile(x,g,o,z,M,E,t,L)}}}break;default:console.log("Bad node!");this.die()}}var j=[],e,b,a,f=undefined;$.ajax({url:w,beforeSend:function(k){k.overrideMimeType("text/html; charset=x-user-defined")},complete:function(k){f=new File(k.responseText);f.seek(1044,f.set);e=f.r32();f.seek(1052,f.set);b=f.r16();f.seek(1174,f.set);a=f.r16();
k=(a+b)*e;f.seek(k+e-2,f.set);var l=f.r16();f.seek(k+l+2,f.set);l=f.r32();u(k,l)}});this.isReady=function(){return f!=undefined};this.getResByKind=function(k,l){for(var n=0,r=0,s=0;s<4;s++){n|=k.charCodeAt(s)<<24-s*8;r|=l.charCodeAt(s)<<24-s*8}for(s in j)if(j[s].type==n&&j[s].creator==r){f.seek((j[s].resStart+b)*e,f.set);return new File(f.read(j[s].resLen))}};this.getRes=function(k){for(var l in j)if(j[l].name==k){if(j[l].resLen==0)break;f.seek((j[l].resStart+b)*e,f.set);return new File(f.read(j[l].resLen))}};
this.getData=function(k){for(var l in j)if(j[l].name==k){if(j[l].dataLen==0)break;f.seek((j[l].dataStart+b)*e,f.set);return new File(f.read(j[l].dataLen))}};this.neg16=function(k){if(k&32768)k=-((k^65535)+1);return k}};function BitMap(w,u,j){this.width=w;this.height=u;this.rowBytes=j;this.data=Array(u*j);this.draw=function(e,b,a){if(!(w==0||u==0)){var f=e.get(0).getContext("2d"),k=w,l=u,n=0,r=0;if(b<0){n=-b;b=0}if(a<0){r=-a;a=0}if(k+b>=e.width())k=e.width()-b;if(l+a>=e.height())l=e.height()-a;if(!(k==0||l==0)){e=f.getImageData(b,a,k,l);for(var s=r;s<l;s++)for(var x=s*j,t=(s-r)*e.width*4,p,g=n;g<k;g++){p=(p=this.data[x+(g>>3)]&1<<7-(g&7))?0:255;e.data[t++]=p;e.data[t++]=p;e.data[t++]=p;e.data[t++]=255}f.putImageData(e,
b,a)}}};this.bic=function(e,b,a){if(!(w==0||u==0)){var f=e.get(0).getContext("2d"),k=w,l=u,n=0,r=0;if(b<0){n=-b;b=0}if(a<0){r=-a;a=0}if(k+b>e.width())k=e.width()-b;if(l+a>e.height())l=e.height()-a;if(!(k==0||l==0)){e=f.getImageData(b,a,k,l);for(var s=r;s<l;s++)for(var x=s*j,t=(s-r)*e.width*4,p,g=n;g<k;g++)if(p=this.data[x+(g>>3)]&1<<7-(g&7)){e.data[t++]=255;e.data[t++]=255;e.data[t++]=255;e.data[t++]=255}else t+=4;f.putImageData(e,b,a)}}};this.or=function(e,b,a){if(!(w==0||u==0)){var f=e.get(0).getContext("2d"),
k=w,l=u,n=0,r=0;if(b<0){n=-b;b=0}if(a<0){r=-a;a=0}if(k+b>=e.width())k=e.width()-b;if(l+a>=e.height())l=e.height()-a;if(!(k==0||l==0)){e=f.getImageData(b,a,k,l);for(var s=r;s<l;s++)for(var x=s*j,t=(s-r)*e.width*4,p,g=n;g<k;g++)if(p=this.data[x+(g>>3)]&1<<7-(g&7)){e.data[t++]=0;e.data[t++]=0;e.data[t++]=0;e.data[t++]=255}else t+=4;f.putImageData(e,b,a)}}};this.xor=function(e,b,a){if(!(w==0||u==0)){var f=e.get(0).getContext("2d"),k=w,l=u,n=0,r=0;if(b<0){n=-b;b=0}if(a<0){r=-a;a=0}if(k+b>e.width())k=e.width()-
b;if(l+a>=e.height())l=e.height()-a;if(!(k==0||l==0)){e=f.getImageData(b,a,k,l);for(var s=r;s<l;s++)for(var x=s*j,t=(s-r)*e.width*4,p,g=n;g<k;g++)if(p=this.data[x+(g>>3)]&1<<7-(g&7)){e.data[t++]^=255;e.data[t++]^=255;e.data[t++]^=255;e.data[t++]=255}else t+=4;f.putImageData(e,b,a)}}};this.hit=function(e,b){return(this.data[b*j+(e>>3)]&1<<7-(e&7))!=0};this.intersect=function(e){for(var b=e.top;b<e.top+e.height;b++)for(var a=b*j,f,k=e.left;k<e.left+e.width;k++)if(f=this.data[a+(k>>3)]&1<<7-(k&7))return true;
return false}}function decodePack(w){var u=new BitMap(512,302,64),j=Array(72);w.seek(512,w.set);for(var e=0,b=0;b<u.height;b++){for(var a=0;a<72;){var f=w.r8();if(f!=128)if(f&128){f^=255;f+=2;for(var k=w.r8(),l=0;l<f;l++)j[a++]=k}else{f++;for(l=0;l<f;l++)j[a++]=w.r8()}}for(l=0;l<64;l++)u.data[e++]=j[l]}return u}
function decodePPIC(w){var u=w.bits(3),j,e;e=w.bits(1)?w.bits(10):w.bits(6);if((j=w.bits(1)?w.bits(10):w.bits(6))&&e){j=new BitMap(j,e,j+15>>3&65534);switch(u){case 0:decodePPIC0(j,w);break;case 1:decodePPIC1(j,w);break;case 2:decodePPIC2(j,w);break;case 3:decodePPIC3(j,w)}return j}}
function decodePPIC0(w,u){for(var j=w.width>>4,e=w.width&15,b,a=0,f=0;f<w.height;f++){for(var k=0;k<j;k++){b=u.peek32();u.seek(2,u.cur);b>>=16-u.bit;w.data[a++]=b>>8&255;w.data[a++]=b&255}if(e){b=u.bits(e);b<<=16-e;w.data[a++]=b>>8&255;w.data[a++]=b&255}}}var ppic1huff=[0,8192,16384,20480,24576,28672,32768,36864,40960,45056,49152,53248,55296,57344,59392,61440,63488],ppic1lens=[3,3,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5],ppic1values=[0,15,3,5,6,7,8,9,10,12,255,1,2,4,11,13,14];
function decodePPIC1(w,u){decodeHuff(ppic1huff,ppic1lens,ppic1values,w,u)}var ppic2huff=[0,16384,32768,49152,51200,53248,55296,57344,59392,61440,62464,62976,63488,64E3,64512,65024,65280],ppic2lens=[2,2,2,5,5,5,5,5,5,6,7,7,7,7,7,8,8],ppic2values=[255,0,15,1,3,7,14,12,8,6,2,4,9,13,11,10,5];function decodePPIC2(w,u){decodeHuff(ppic2huff,ppic2lens,ppic2values,w,u)}var loadbits=[8,15,2,255,0,4,255,1,7,9,8,255,3,4,255,4,10,7,10,11,6,255,5,6,6,11,255,7,3,255,9,4,3,14,255,12,2,255,13,1,255,15,255];
function decodePPIC3(w,u){for(var j=Array(17),e,b,a=0;(b=loadbits[a++])!=255;){for(e=u.bits(b);(b=loadbits[a++])!=255;){j[loadbits[a++]]=e%b;e=e/b|0}j[loadbits[a++]]=e}j[16]=0;for(e=16;e>0;e--)for(b=e;b<=16;b++)j[b]>=j[e-1]&&j[b]++;for(e=16;e>=0;e--)if(j[e]==16){j[e]=255;break}a=Array(17);var f=Array(17);b=u.bits(2)+1;var k=0;for(e=0;e<15;e++){if(e)for(;!u.bits(1);)b++;f[e]=b;a[e]=k;k+=1<<16-b}for(a[15]=k;k&1<<16-b;)b++;a[16]=k|1<<16-b;f[15]=b;f[16]=b;decodeHuff(a,f,j,w,u)}
function decodeHuff(w,u,j,e,b){var a;walkHuffLast=walkHuffRepeat=0;a=e.width&3?b.bits(5):b.bits(4)<<1;var f=0,k=e.width&15;if(k){k>>=2;f=k&1;k=2-(k>>1)}for(var l=0,n=0;n<e.height;n++){for(var r=0;r<e.width>>3;r++){var s=walkHuff(w,u,j,b)<<4;e.data[l++]=walkHuff(w,u,j,b)|s}if(f)e.data[l]=walkHuff(w,u,j,b)<<4;l+=k}if(r=e.width&3){l=e.rowBytes-k;for(n=k=s=0;n<e.height;n++){if(a&1){if(s<r){v=walkHuff(w,u,j,b)<<4;k|=v>>s;s+=4}s-=r;v=k;k<<=r;k&=255}else{v=b.bits(r);v<<=8-r}if(f)v>>=4;e.data[l]|=v&255;l+=
e.rowBytes}}if(a&8)for(n=l=0;n<e.height;n++){v=0;if(a&2)for(r=0;r<e.rowBytes;r++){e.data[l]^=v;v=e.data[l++]}else for(r=0;r<e.rowBytes;r++){k=e.data[l]^v;k^=k>>4&15;e.data[l++]=k;v=k<<4}}if(a&4){delta=e.rowBytes*4;if(a&2)delta*=2;l=0;q=delta;for(i=0;i<e.height*e.rowBytes-delta;i++)e.data[q++]^=e.data[l++]}}var walkHuffRepeat=0,walkHuffLast=0;
function walkHuff(w,u,j,e){if(walkHuffRepeat){walkHuffRepeat--;walkHuffLast=walkHuffLast<<8&65280|walkHuffLast>>8;return walkHuffLast&255}var b=e.peek32();b>>=16-e.bit;b&=65535;var a;for(a=0;a<16;a++)if(w[a+1]>b)break;e.bit+=u[a];if(e.bit&16){e.bit&=15;e.seek(2,e.cur)}w=j[a];if(w==255){if(!e.bits(1)){walkHuffLast&=255;walkHuffLast|=walkHuffLast<<8}walkHuffRepeat=e.bits(3);if(walkHuffRepeat<3){walkHuffRepeat<<=4;walkHuffRepeat|=e.bits(4);if(walkHuffRepeat<8){walkHuffRepeat<<=8;walkHuffRepeat|=e.bits(8)}}walkHuffRepeat-=
2;walkHuffLast=walkHuffLast<<8&65280|walkHuffLast>>8;return walkHuffLast&255}else{walkHuffLast<<=8;walkHuffLast|=w;walkHuffLast&=65535}return w}
function GraphicManager(w){function u(j,e,b,a,f,k){j=j.get(0).getContext("2d");for(var l=j.getImageData(e,b,a,f),n=0;n<f;n++)for(var r=n*l.width*4,s=k?0:255,x=0;x<a;x++){l.data[r++]=s;l.data[r++]=s;l.data[r++]=s;l.data[r++]=255}j.putImageData(l,e,b)}this.get=function(j){j=w.get(3,j);if(!(j.length<2)){if(j.length==2)return this.get((j.charCodeAt(0)&255)<<8|j.charCodeAt(1)&255);return decodePPIC(new File(j))}};this.fill=function(j,e){u(j,0,0,j.width(),j.height(),e)};this.draw=function(j,e,b,a,f){var k=
{top:0,left:0,width:0,height:0},l;if(l=this.get(j*2+1)){k={top:b,left:e,width:l.width,height:l.height};switch(f){case 1:l.bic(a,e,b);break;case 2:l.or(a,e,b)}}else if(l=this.get(j*2)){k={top:b,left:e,width:l.width,height:l.height};switch(f){case 1:u(a,e,b,l.width,l.height,0);break;case 2:u(a,e,b,l.width,l.height,1)}}if(f>0&&(l=this.get(j*2)))l.xor(a,e,b);return k};this.sectRect=function(j,e,b){var a=e.top,f=e.left,k=f+e.width;e=a+e.height;if(a<j.top)a=j.top;if(f<j.left)f=j.left;if(e>j.top+j.height)e=
j.top+j.height;if(k>j.left+j.width)k=j.left+j.width;if(k<=f||e<=a)a=e=f=k=0;b.top=a;b.left=f;b.width=k-f;b.height=e-a;return b.height!=0}};function ObjectManager(w){var u=[];this.load=function(j,e){var b=w.getData(e),a={};a.numitems=0;a.isobj=false;b.seek(0,b.set);var f=b.length,k=b.r32(),l;if(k&2147483648){k&=2147483647;a.isobj=true;b.seek(k,b.set);a.numitems=b.r16();f=Array(16);for(var n=Array(16),r=0;r<15;r++)f[r]=b.r16();for(r=0;r<16;r++)n[r]=b.r8();a.offsets=Array(a.numitems);a.lengths=Array(a.numitems);var s=0;for(r=0;r<a.numitems;r++){if((r&63)==0){b.seek(k+(r>>6)*6+48,b.set);var x=b.r24();l=b.r24();s=x&7;b.seek(k+(x>>3),b.set)}a.offsets[r]=
l;x=b.r32()>>16-s&65535;b.seek(-4,b.cur);var t;for(t=0;t<16;t++)if(f[t]>x)break;x=n[t];s+=x&15;if(s&16){s&=15;b.seek(2,b.cur)}x>>=4;t=0;if(x){t=b.peek32();x--;if(x==0)t=0;else t>>=32-x-s;t&=(1<<x)-1;t|=1<<x;s+=x;if(s&16){s&=15;b.seek(2,b.cur)}l+=t}a.lengths[r]=t}l=k-4}else{f-=4;l=f;a.itemlen=k;a.numitems=f/k|0}b.seek(4,b.set);a.data=b.read(l);u[j]=a};this.get=function(j,e){if(e>=u[j].numitems)return"";var b,a;if(u[j].isobj){b=u[j].lengths[e];a=u[j].offsets[e]}else{b=u[j].itemlen;a=e*b}if(!b)return"";
return u[j].data.substring(a,a+b)}};function TextManager(w,u){function j(r){if(r&32768)return a.input;r=new File(w.get(2,r));for(var s=false,x="",t=r.r16();t--;){var p=r.bits(5);if(p>0&&p<27){p|=64;if(s)p|=32;s=true;x+=String.fromCharCode(p)}else switch(p){case 0:x+=" ";break;case 27:x+=s?".":",";s=true;break;case 28:x+=s?"'":'"';s=true;break;case 29:s=r.bits(16);if(s&32768){s^=65535;s=e(s)}else s=j(s);if(s)x+=s;s=true;break;case 30:x+=String.fromCharCode(r.bits(8));s=true;break;case 31:s=!s}}return webventure.mac2ascii(x)}function e(r){var s,
x;s=r&8?a.target:a.source;if((r&3)==1){s=webventure.get(s,7);s=(s>>4&3)+1;x=u.getIndStr(132,s)}else{x=a.get(s);x==""&&fail();switch(r&3){case 2:x=b(0,s)+x;break;case 3:x=b(2,s)+x}}if(x.length&&r&4)x=a.capitalize(x);return x}function b(r,s){var x=webventure.get(s,7)>>r&3;if(x)return u.getIndStr(131,x);return""}var a=this,f,k,l,n=true;this.input="";this.setHuff=function(r){if(r!=undefined){n=false;var s=r.r16();r.r16();f=Array(s);for(var x=0;x<s-1;x++)f[x]=r.r16();k=Array(s);for(x=0;x<s;x++)k[x]=r.r8();
l=Array(s);for(x=0;x<s;x++)l[x]=r.r8()}};this.get=function(r){if(n)return j(r);if(r&32768)return this.input;r=new File(w.get(2,r));var s,x="";for(s=r.bits(1)?r.bits(15):r.bits(7);s--;){var t=r.peek32();t>>=16-r.bit;t&=65535;var p;for(p=0;p<f.length;p++)if(t<f[p])break;r.bit+=k[p];if(r.bit&16){r.bit&=15;r.seek(2,r.cur)}t=l[p];if(t==1)t=r.bits(7);if(t!=2)x+=String.fromCharCode(t);else{if(r.bits(1)){t=r.bits(15);t=this.get(t)}else{t=r.bits(8);t=e(t)}if(t)x+=t}}return webventure.mac2ascii(x)};this.capitalize=
function(r){return r.substr(0,1).toUpperCase()+r.substr(1)}};function EngineState(){function w(e){if(e<0)e=(-e^65535)+1;return e}var u=Array(128),j=128;this.push=function(e){j--;u[j]=w(e)&65535};this.pop=function(){return u[j++]};this.peek=function(e){return u[j+e]};this.poke=function(e,b){u[j+e]=w(b)&65535};this.clear=function(){j=128};this.size=function(){return 128-j}}
function Engine(w,u,j,e){function b(p){p=typeof p!="undefined"?p:false;var g=false;if(t[0].haltedInFirst||p){t[0].haltedInFirst=false;if(g=p?a(0):f())return t[0].haltedInFirst=true;g=true;t[0].familyIdx=0}if(t[0].haltedInFamily||g){t[0].haltedInFamily=false;var o=webventure.getFamily(webventure.get(1,0),false);for(p=t[0].familyIdx;p<o.length;p++){if(g=g?a(o[p]):f()){t[0].haltedInFamily=true;t[0].familyIdx=p;return true}g=true}}var z;if(t[0].haltedInSaves){t[0].haltedInSaves=false;if(f())return t[0].haltedInSaves=
true}do{for(p=g=0;p<t[0].saves.length;p++)if(g<t[0].saves[p].rank){g=t[0].saves[p].rank;z=p}if(g){t[0].saves[z].rank=0;if(a(t[0].saves[z].func))return t[0].haltedInSaves=true}}while(g);t.shift();return false}function a(p){if(func=w.get(1,p)){t[0].p[0]=new File(func);return n()}return false}function f(){var p=n();if(p)return p;t[0].p.shift();if(t[0].p.length)return f()}function k(p){if(p&128)p=-((p^255)+1);return p}function l(p){if(p&32768)p=-((p^65535)+1);return p}function n(){for(var p=t[0].p[0],
g=t[0].state;!p.eof();){var o=p.r8();if(o&128)switch(o){case 128:var z=g.pop(),A=g.pop();o=webventure.get(z,A);g.push(o);break;case 129:z=g.pop();A=g.pop();o=l(g.pop());webventure.set(z,A,o);break;case 130:z=g.pop();A=g.pop();o=g.pop();g.push(s(z,A,o!=0));break;case 131:g.push(t[0].curCtl);break;case 132:g.push(t[0].curObj);break;case 133:g.push(t[0].target);break;case 134:g.push(t[0].ptx);break;case 135:g.push(t[0].pty);break;case 136:g.push(p.r8());break;case 137:g.push(p.r16());break;case 138:z=
g.pop();g.push(webventure.globals[z]);break;case 139:z=g.pop();o=l(g.pop());webventure.globals[z]=o;webventure.gameChanged=true;break;case 140:o=g.pop();g.push(Math.round((o-1)*Math.random()));break;case 141:o=g.peek(0);g.push(o);break;case 142:z=g.pop();for(A=z-1;z--;){o=g.peek(A);g.push(o)}break;case 143:A=g.pop();var E=g.pop();g.push(A);g.push(E);break;case 144:z=g.pop();E=g.peek(z);A=g.peek(0);g.poke(z,A);g.poke(0,E);break;case 145:g.pop();break;case 146:o=g.peek(1);g.push(o);break;case 147:z=
g.pop();o=g.peek(z);g.push(o);break;case 148:E=g.pop();A=g.pop();o=g.pop();g.push(E);g.push(o);g.push(A);break;case 149:var L=l(g.pop());z=l(g.pop());L%=z;if(L<0)L+=z;var M=0,ea=0;for(o=1;o<z;o++){ea+=L;if(ea>=z)ea-=z;if(ea==M){M++;ea=M}else{E=g.peek(M);A=g.peek(ea);g.poke(M,A);g.poke(ea,E)}}break;case 150:g.clear();break;case 151:g.push(g.size());break;case 152:A=g.pop();E=g.pop();g.push(E+A);break;case 153:A=g.pop();E=g.pop();g.push(E-A);break;case 154:A=g.pop();E=g.pop();g.push(E*A);break;case 155:A=
g.pop();E=g.pop();g.push(E/A|0);break;case 156:A=g.pop();E=g.pop();g.push(E%A);break;case 157:A=g.pop();E=g.pop();g.push(E%A);g.push(E/A|0);break;case 158:o=l(g.pop());if(o<0)o=-o;g.push(o);break;case 159:o=-l(g.pop());g.push(o);break;case 160:A=g.pop();E=g.pop();g.push(E&A);break;case 161:A=g.pop();E=g.pop();g.push(E|A);break;case 162:A=g.pop();E=g.pop();g.push(E^A);break;case 163:o=g.pop();g.push(o^65535);break;case 164:A=g.pop();E=g.pop();g.push(E&&A?65535:0);break;case 165:A=g.pop();E=g.pop();
g.push(E||A?65535:0);break;case 166:A=g.pop();E=g.pop();g.push(!E!=!A?65535:0);break;case 167:o=g.pop();g.push(o==0?65535:0);break;case 168:A=g.pop();E=g.pop();g.push(E>A?65535:0);break;case 169:A=g.pop();E=g.pop();g.push(E<A?65535:0);break;case 170:A=l(g.pop());E=l(g.pop());g.push(E>A?65535:0);break;case 171:A=l(g.pop());E=l(g.pop());g.push(E<A?65535:0);break;case 172:A=g.pop();E=g.pop();g.push(E==A?65535:0);break;case 173:A=u.get(g.pop());E=u.get(g.pop());g.push(E==A?1:0);break;case 174:o=u.get(g.pop());
z=u.get(g.pop());g.push(z.toLowerCase().indexOf(o.toLowerCase())!=-1?1:0);break;case 175:o=u.get(g.pop());z=u.get(g.pop());g.push(RegExp("\\b"+o+"\\b","i").test(z)?65535:0);break;case 176:o=l(p.r16());p.seek(o,p.cur);break;case 177:o=k(p.r8());p.seek(o,p.cur);break;case 178:o=l(p.r16());A=g.pop();A!=0&&p.seek(o,p.cur);break;case 179:o=k(p.r8());A=g.pop();A!=0&&p.seek(o,p.cur);break;case 180:o=l(p.r16());A=g.pop();A==0&&p.seek(o,p.cur);break;case 181:o=k(p.r8());A=g.pop();A==0&&p.seek(o,p.cur);break;
case 182:o=g.pop();z=g.pop();t[0].saves.push({rank:o,func:z});break;case 183:z=g.pop();for(o=0;o<t[0].saves.length;o++)if(t[0].saves[o].func==z)t[0].saves[o].rank=0;break;case 184:z=g.pop();for(o=0;o<t[0].saves.length;o++)if(t[0].saves[o].rank<=z)t[0].saves[o].rank=0;break;case 185:A=g.pop();for(o=0;o<t[0].saves.length;o++)if(t[0].saves[o].rank>=A)t[0].saves[o].rank=0;break;case 186:z=g.pop();A=g.pop();for(o=0;o<t[0].saves.length;o++)if(t[0].saves[o].rank>=A&&t[0].saves[o].rank<=z)t[0].saves[o].rank=
0;break;case 187:o=g.pop();z=g.pop();A=g.pop();E=g.pop();L=g.pop();t.unshift({curCtl:o,curObj:z,target:A,ptx:E,pty:L,state:new EngineState,saves:[],p:[undefined]});if(b(true))return true;break;case 188:o=g.pop();t[0].p.unshift(undefined);if(a(o))return true;t[0].p.shift();p=t[0].p[0];break;case 189:z=g.pop();webventure.queue.push({id:2,val:z});break;case 190:o={};o.from=g.pop();o.to=g.pop();webventure.queue.push({id:8,val:o});o=o;webventure.set(o.to,6,webventure.get(o.from,6));webventure.set(o.from,
6,0);z=webventure.getFamily(o.from,true);for(A=1;A<z.length;A++)webventure.set(z[A],0,o.to);break;case 191:webventure.queue.push({id:14,val:t[0].curObj});break;case 192:webventure.queue.push({id:13});break;case 193:o=g.pop();webventure.textQueue.push({id:3,val:[t[0].target,t[0].curObj,o]});break;case 194:webventure.textQueue.push({id:2});break;case 195:o=g.pop();webventure.textQueue.push({id:3,val:[t[0].target,t[0].curObj,o]});webventure.textQueue.push({id:2});break;case 196:webventure.textQueue.push({id:2});
o=g.pop();webventure.textQueue.push({id:3,val:[t[0].target,t[0].curObj,o]});webventure.textQueue.push({id:2});break;case 197:o=g.pop();webventure.textQueue.push({id:1,val:o});break;case 198:push(2);break;case 199:z=g.pop();webventure.soundQueue.push({id:1,val:z});break;case 200:z=g.pop();webventure.soundQueue.push({id:2,val:z});break;case 201:webventure.soundQueue.push({id:3});break;case 202:o=new Date;o=[o.getFullYear(),o.getMonth()+1,o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];g.push(o[0]);
g.push(o[1]);g.push(o[2]);g.push(o[3]);g.push(o[4]);g.push(o[5]);break;case 203:g.push((new Date).getDay()+1);break;case 204:o=g.pop();z=g.pop();z=webventure.getFamily(z,o!=0);for(o=1;o<z.length;o++)g.push(z[o]);g.push(z.length-1);break;case 205:o=g.pop();z=g.pop();z=webventure.getFamily(z,o!=0);g.push(z.length-1);break;case 206:g.push(86);break;case 207:o=j.getIndStr(129,1);g.push(o.charCodeAt(3)-48);break;case 208:g.push(1);break;case 209:z=g.pop();o=r(z);o={v:o.height,h:o.width};g.push(o.h);g.push(o.v);
break;case 210:A=g.pop();E=g.pop();g.push(x(A,E));break;case 211:o=z=g.pop();z=[];A=webventure.getFamily(webventure.get(o,0),1);for(E=1;E<A.length;E++)o<A[E]&&x(A[E],o)>=40&&z.push(A[E]);for(;z.length;)webventure.set(z.pop(),0,o);break;case 212:z=z=g.pop();o=webventure.getFamily(z,1);z=webventure.get(z,0);for(A=1;A<o.length;A++)webventure.set(o[A],0,z);break;case 213:p=g.pop();webventure.textEntry(p,t[0].curObj,t[0].target);return true;case 214:webventure.activateCommand(g.pop());break;case 215:webventure.gameState=
3;break;case 216:webventure.gameState=2;break;case 217:p=g.pop();setTimeout(webventure.runMain,p/60*1E3);return true;case 218:webventure.updateScreen(false);webventure.clickToContinue();return true;case 219:webventure.runQueue();break;case 220:if(webventure.playSounds(true))return true;break;case 221:webventure.printTexts();break;case 222:if(webventure.updateScreen(true))return true;break;case 223:p=g.pop();webventure.invertmain();setTimeout(webventure.revertmain,p/60*1E3);return true;case 224:g.pop();
break;case 225:g.pop();break;case 226:A=g.pop();E=g.pop();E*=A;o=g.pop();E/=o;g.push(E|0);break;case 227:z=g.pop();webventure.updateObject(z);break;case 228:g.push(0);break;case 229:console.log("wait for event");break;case 230:g.push(fib);break;case 231:z=g.pop();A=1;for(o=fib=0;o<z;o++){fib+=A;fib^=A;A^=fib;fib^=A}break;default:console.log("func: "+o.toString(16));this.die()}else g.push(o)}return false}function r(p){var g={top:0,left:0,width:0,height:0},o=webventure.getParentWin(p),z=0;if(o&&o.refCon)z=
webventure.getChildIdx(o.refCon.children,p);if(z){if(o.refCon.children[z-1].width==0||o.refCon.children[z-1].height==0){p=webventure.drawObject(p,o,true);o.refCon.children[z-1].top=p.top;o.refCon.children[z-1].left=p.left;o.refCon.children[z-1].width=p.width;o.refCon.children[z-1].height=p.height}g.top=o.refCon.children[z-1].top;g.left=o.refCon.children[z-1].left;g.width=o.refCon.children[z-1].width;g.height=o.refCon.children[z-1].height}else if((bmp=e.get(p*2))!=undefined){g.top=webventure.get(p,
2);g.left=webventure.get(p,1);g.width=bmp.width;g.height=bmp.height}else if((bmp=e.get(p*2+1))!=null){g.top=webventure.get(p,2);g.left=webventure.get(p,1);g.width=bmp.width;g.height=bmp.height}else{g.top=0;g.left=0;g.width=0;g.height=0}return g}function s(p,g,o){var z=0;p=webventure.getFamily(p,o);for(o=1;o<p.length;o++)z+=webventure.get(p[o],g);return z}function x(p,g){if(webventure.get(p,0)!=webventure.get(g,0))return 0;var o=r(p),z=r(g);if(e.sectRect(z,o,z))return z.width*z.height*100/(o.width*
o.height)|0;return 0}var t=[];this.reset=function(){t=[]};this.push=function(p){t[0].state.push(p)};this.run=function(p,g,o,z){t.unshift({curCtl:p,curObj:g,target:o,ptx:z.h,pty:z.v,state:new EngineState,saves:[],p:[]});return this.resume(true)};this.resume=function(p){for(p=typeof p!="undefined"?p:false;t.length;)if(b(p))return true;return false}};function ResourceManager(){var w=[];this.open=function(u){w.push(u);return w.length-1};this.close=function(u){w.splice(u,1)};this.get=function(u,j){for(var e=u.charCodeAt(0)<<24|u.charCodeAt(1)<<16|u.charCodeAt(2)<<8|u.charCodeAt(3),b=w.length-1;b>=0;b--){var a=w[b];a.seek(0,a.set);var f=a.r32(),k=a.r32();a.seek(k+24,a.set);k=k+a.r16();a.seek(k,a.set);for(var l=a.r16()+1,n=0;n<l;n++){if(a.r32()==e){e=a.r16()+1;a.seek(k+a.r16(),a.set);for(n=0;n<e;n++){if(a.r16()==j){a.seek(2,a.cur);f+=a.r32()&16777215;
a.seek(f,a.set);f=a.r32();return new File(a.read(f))}a.seek(10,a.cur)}return}a.seek(4,a.cur)}}};this.getString=function(u){u=this.get("STR ",u);if(u==undefined)return"";var j=u.r8();return u.read(j)};this.getIndStr=function(u,j){if(j==0)return"";var e=this.get("STR#",u);if(e==undefined)return"";var b=e.r16();if(j>b)return"";for(;;){j--;if(j==0){b=e.r8();return e.read(b)}b=e.r8();e.seek(b,e.cur)}}};function ControlManager(){function w(j,e,b,a,f,k,l){var n=$(document.createElement("div"));n.addClass("button");n.css("top",e+"px");n.css("left",j+"px");n.css("width",b-2+"px");n.css("height",a-2+"px");n.css("line-height",a-2+"px");n.html(f);n.data("refcon",l);k==false&&n.hide();n.mousedown(function(r){webventure.buttonClicked(n,r);return false});return n}function u(j,e,b,a,f,k,l){var n=$(document.createElement("div"));n.addClass("cbutton");n.css("top",e+"px");n.css("left",j+"px");n.css("width",b-
2+"px");n.css("height",a-2+"px");n.html(f);n.data("refcon",l);k==false&&n.hide();n.mousedown(function(r){webventure.buttonClicked(n,r);return false});return n}this.create=function(j,e,b,a,f,k,l,n,r,s,x){switch(f>>4){case 0:return w(j,e,b,a,k,l,x);case 128:return u(j,e,b,a,k,l,x);case 256:f=$(document.createElement("input"));f.addClass("textinput");f.css("top",e+"px");f.css("left",j+"px");f.css("width",b+"px");f.css("height",a+"px");f.val(k);f.data("refcon",x);l==false&&f.hide();return f;case 272:f=
$(document.createElement("div"));f.addClass("text");f.css("top",e+"px");f.css("left",j+"px");f.css("width",b+"px");f.css("height",a+"px");f.html(k);f.data("refcon",x);l==false&&f.hide();return f;case 288:k=$(document.createElement("div"));k.addClass("list");k.css("top",e+"px");k.css("left",j+"px");k.css("width",b+"px");k.css("height",a+"px");k.data("refcon",x);l==false&&k.hide();return k;default:console.log("Unknown CDEF:"+f);this.die()}};this.get=function(j){var e=j.r16(),b=j.r16(),a=j.r16()-e,f=
j.r16()-b,k=j.r16(),l=j.r8()!=0;j.r8();var n=j.r16(),r=j.r16(),s=j.r16(),x=j.r32(),t=j.r8(),p="";if(t!=0)p=j.read(t);return this.create(b,e,f,a,s,p,l,k,r,n,x)};this.move=function(j,e,b){var a=j.position();j.css("left",a.left+e+"px");j.css("top",a.top+b+"px")}};function Sound(w,u){function j(){var a=Array(44+w);a[0]=82;a[1]=73;a[2]=70;a[3]=70;var f=36+w;a[4]=f&255;a[5]=f>>8&255;a[6]=f>>16&255;a[7]=f>>24&255;a[8]=87;a[9]=65;a[10]=86;a[11]=69;a[12]=102;a[13]=109;a[14]=116;a[15]=32;a[16]=16;a[17]=0;a[18]=0;a[19]=0;a[20]=1;a[21]=0;a[22]=1;a[23]=0;a[24]=u&255;a[25]=u>>8&255;a[26]=u>>16&255;a[27]=u>>24&255;a[28]=a[24];a[29]=a[25];a[30]=a[26];a[31]=a[27];a[32]=1;a[33]=0;a[34]=8;a[35]=0;a[36]=100;a[37]=97;a[38]=116;a[39]=97;a[40]=w&255;a[41]=w>>8&255;a[42]=w>>16&
255;a[43]=w>>24&255;for(f=0;f<w;f++)a[44+f]=e.data[f];f="";var k,l,n="",r,s;l="";var x=0;do{k=a[x++];l=a[x++];n=a[x++];r=k>>2;k=(k&3)<<4;if(l==undefined)s=l=64;else if(n==undefined){k|=l>>4;l=64}else{k|=l>>4;s=(l&15)<<2|n>>6;l=n&63}f+=b.charAt(r)+b.charAt(k)+b.charAt(s)+b.charAt(l)}while(x<a.length);return f}var e=this,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.data=Array(w);this.time=function(){return w/u};this.play=function(){var a=$(document.createElement("audio"));
$(document.body).append(a);a.attr("src","data:audio/x-wav;base64,"+j());a.bind("ended",function(){a.remove()});a.get(0).play()}}
function SoundManager(w){var u=false;try{var j=document.createElement("audio").canPlayType("audio/wav");u=j!=""&&j!="no"}catch(e){}this.muted=false;this.play=function(b){var a=w.get(4,b);b=new File(a);var f=undefined;switch(a.charCodeAt(5)&255){case 16:var k=[];b.seek(408,b.set);for(var l=0;l<16;l++)k[l]=b.r8();var n=b.r32()*2;b.r16();l=b.r32()*22100/65536|0;var r=new Sound(n,l),s;for(l=0;l<n;l++){if(l&1)s>>=4;else s=b.r8();r.data[l]=k[s&15]}f=r;break;case 18:b.seek(12,b.set);k=b.r16();b.seek(52,
b.set);s=b.r16()+52;b.seek(s,b.set);n=b.r32()-6;b.r16();l=b.r32()*22100/65536|0;l=new Sound(n*k,l);r=0;a=b.seek(226,b.set)+226;for(f=0;f<k;f++){b.seek(a+f*2,b.set);var x=b.r16();b.seek(s+10,b.set);for(var t=0;t<n;t++){var p=b.r8();if(p&128){p-=128;p=p*x;p=p>>8&255;if(p&128)p=127;p+=128}else{p=(p^255)+1;p-=128;p=p*x;p=p>>8&255;if(p&128)p=127;p+=128;p=(p^255)+1}l.data[r++]=p}}f=l;break;case 24:k=[];b.seek(594,b.set);for(l=0;l<16;l++)k[l]=b.r8();s=b.r32()*2;b.r16();l=b.r32()*22100/65536|0;r=new Sound(s,
l);for(l=0;l<s;l++){if(l&1)n>>=4;else n=b.r8();r.data[l]=k[n&15]}f=r;break;case 26:k=[];b.seek(544,b.set);for(n=0;n<16;n++)k[n]=b.r8();s=b.r32();b.r16();n=b.r32()*22100/65536|0;r=new Sound(s,n);for(n=0;n<s;n++){if(n&1)l>>=4;else l=b.r8();r.data[n]=k[l&15]}f=r;break;case 68:b.seek(94,b.set);k=b.r32();s=b.r32()*22100/65536|0;s=new Sound(k,s);for(n=0;n<k;n++)s.data[n]=b.r8();f=s;break;case 120:k=[];b.seek(186,b.set);for(n=0;n<16;n++)k[n]=b.r8();b.r32();s=b.r32();n=b.r32()*22100/65536|0;l=new Sound(s,
n);for(n=0;n<s;n++){if(n&1)r<<=4;else r=b.r8();l.data[n]=k[r>>4&15]}f=l;break;case 126:s=[];b.seek(194,b.set);for(l=0;l<16;l++)s[l]=b.r8();b.r32();n=b.r32();l=b.r32()*22100/65536|0;r=new Sound(n,l);a=128;for(l=0;l<n;l++){if(l&1)k<<=4;else k=b.r8();a+=s[k>>4&15];r.data[l]=a&255}f=r}if(f==undefined)return 0;else{u&&!this.muted&&f.play();return f.time()}}};function Menu(w,u){this.id=w;this.title=u;this.el=undefined;var j=[];this.add=function(e){j.push(e)};this.draw=function(){var e=$(document.createElement("table"));e.addClass("menu");var b=$(document.createElement("tbody"));e.append(b);var a=this.el.position();e.css("top",a.top+19+"px");e.css("left",a.left+"px");for(a=0;a<j.length;a++){var f=j[a].draw();b.append(f)}return e}}
function MenuItem(w,u){this.draw=function(){var j=$(document.createElement("tr"));if(w=="-"){var e=$(document.createElement("td"));e.attr("colspan","2");e.addClass("divider");e.append(document.createElement("hr"))}else{j.addClass("menuitem");e=$(document.createElement("td"));e.html(w);j.append(e);e=$(document.createElement("td"));if(u!=0){e.addClass("shortcut");e.append(String.fromCharCode(u))}}j.append(e);return j}}
function MenuManager(w){function u(b){if(!webventure.isPaused){for(var a,f=0,k=$(b.target);k.data("refCon")==undefined;)k=k.parent();k.addClass("active");b=k.data("refCon");for(a=0;a<j.length;a++)if(j[a].id==b)break;var l=j[a].draw();w.append(l);$(document).mousemove(function(n){var r=e.position();if(n.pageX>=r.left&&n.pageY>r.top&&n.pageX<r.left+e.width()&&n.pageY<r.top+e.height())for(a=0;a<j.length;a++){r=j[a].el.position();var s=(j[a].el.outerWidth()-j[a].el.width())/2;if(n.pageX>=r.left-s&&n.pageX<
r.left-s+j[a].el.outerWidth()){l.remove();k.removeClass("active");k=j[a].el;k.addClass("active");l=j[a].draw();w.append(l);break}}else{r=l.position();if(n.pageX>=r.left&&n.pageY>=r.top&&n.pageX<r.left+l.width()&&n.pageY<r.top+l.height()){n.pageY-=r.top;l.find("tr").each(function(x,t){r=$(t).position();if(n.pageY>=r.top&&n.pageY<r.top+$(t).height()){if($(t).hasClass("menuitem")){f=x+1;$(t).addClass("active")}}else $(t).removeClass("active")})}else{l.find("tr").each(function(x,t){$(t).removeClass("active")});
f=0}}});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");l.remove();k.removeClass("active");f&&webventure.menuSelect(j[a].id,f)})}}var j=[],e;this.get=function(b){var a=b.r16();b.seek(12,b.cur);var f=b.r8(),k="";if(f!=0)k=b.read(f);if(f==1)k="";for(a=new Menu(a,k);;){k=b.r8();if(k==0)break;f="";if(k!=0)f=webventure.mac2ascii(b.read(k));b.r8();k=b.r8();var l=b.r8(),n=b.r8();f=new MenuItem(f,k,l,n);a.add(f)}j.push(a)};this.show=function(){e=$(document.createElement("div"));
e.addClass("menubar");for(var b in j){var a=$(document.createElement("div"));a.addClass("menu");j[b].title==""?a.addClass("apple"):a.append(j[b].title);a.data("refCon",j[b].id);a.mousedown(function(f){u(f);return false});j[b].el=a;e.append(a)}w.append(e)}};webventure.init();
