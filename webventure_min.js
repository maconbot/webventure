function WebVenture(){function y(){if(ka.isReady()){h.gameState=0;for(var c,a=1;c==undefined&&a<5;a++)c=ka.getResByKind("APPL","MCV"+a);K.open(c);a=K.getIndStr(129,2);c=ka.getRes(a);if(c!=undefined){c=K.open(c);a=decodePPIC(K.get("PPIC",0));K.close(c)}else a=decodePack(ka.getData(a));wa.remove();wa=undefined;Ha=O.create("","plainDBox",false,false,0,0,512,342);Ha.show();a.draw(Ha.port,0,0);for(a=0;a<5;a++)xa.load(a,K.getIndStr(129,a+4));a=K.get("GNRL",128);ya=a.r16();Ma=a.r16();Ba=a.r16();za=a.r16();
Na=a.r16();a.r16();W={};W.top=a.r16();W.left=a.r16();W.height=a.r16();W.width=a.r16();W.stepy=a.r16();W.stepx=a.r16();W.num=0;a.r16();a.r16();Oa=Array(za);for(c=0;c<za;c++)Oa[c]=a.r8();Ia=Array(za);for(c=0;c<za;c++)Ia[c]=a.r16();Pa=Array(za);for(c=0;c<za;c++)Pa[c]=a.r8();Va=Array(Ba);for(c=0;c<Ba;c++)Va[c]=a.r8();Wa=Array(Ba);for(c=0;c<Ba;c++)Wa[c]=a.r8();Ca=[];m();ba=[];h.queue=[];h.soundQueue=[];h.textQueue=[];ca=Array(ya*2);da.setHuff(K.get("GNRL",131));commandsWin=O.get(K.get("WIND",128));commandsWin.kind=
9;commandsWin.addClass("commands");for(a=0;a<Ba;a++)Wa[a]&&commandsWin.add(V.get(K.get("CNTL",129+a)));Z=O.get(K.get("WIND",129));Z.kind=10;qa=O.get(K.get("WIND",130));qa.kind=11;ea=$(document.createElement("div"));ea.addClass("textEdit");qa.setCanvas(ea);ua=O.get(K.get("WIND",131));ua.kind=12;ua.refCon={id:0,x:0,y:0,children:[{id:1,top:0,left:0,width:0,height:0}]};fa=O.get(K.get("WIND",132));fa.kind=13;fa.addClass("exits");for(a=128;a<=133;a++)Qa.get(K.get("MENU",a));Qa.addDA("Adjust Volume...");
qa.setTitle(K.getIndStr(128,1));if(gameparts.length>1){pa=gameparts[1];c=JSON.parse(localStorage.getItem(pa));la=c.gamedata;h.globals=c.globals;ea.html(c.text);qa.setTitle(pa)}else{c=ka.getData(K.getString(133));la=Array(Na);h.globals=Array(Ma);for(a=0;a<Na;a++){la[a]=Array(ya);for(var l=0;l<ya;l++)la[a][l]=c.r16()}for(a=0;a<Ma;a++)h.globals[a]=c.r16()}e();if(pa==""){h.cmdReady=true;h.selectedCtl=1;R.push(h.get(1,0))}setTimeout(w,500)}else setTimeout(y,10)}function w(){O.close(Ha);Ha=undefined;Qa.show();
commandsWin.show();ua.show();h.updateWindow(ua);fa.show();qa.show();Z.show();h.gameState=1;ea.scrollTop(1E4);h.set(h.get(1,0),6,1);h.gameChanged=false;h.runMain()}function m(){h.selectedCtl=0;ra=undefined;R=[];Y=0;aa={h:0,v:0};da.input="";h.cmdReady=false;Ra=0}function e(){for(var c,a,l=0;l<ya*2;l++)ca[l]=0;for(l=ya-1;l;l--){c=la[0][l];if(a=ca[c*2])ca[l*2+1]=a;ca[c*2]=l}}function d(c){if(c)(c=r(c))&&O.bringToFront(c)}function b(c){if(Ca.indexOf(c)==-1){Ca.push(c);var a={};a.obj=c;a.parent=h.get(c,
0);a.x=h.get(c,1);a.y=h.get(c,2);a.exitx=h.get(c,9);a.exity=h.get(c,10);a.hidden=h.get(c,11);a.offscreen=h.get(c,3);a.invisible=h.get(c,4);h.queue.push({id:7,val:a})}}function f(){if(h.gameState==2){O.closeAll();var c=K.getString(131),a=ka.getRes(c),l;if(a!=undefined){a=K.open(a);var u=K.get("PPIC",0);if(u!=undefined)l=decodePPIC(u);K.close(a)}if(l==undefined)l=decodePack(ka.getData(c));Sa=O.get(K.get("WIND",133));Sa.show();l.draw(Sa.port,0,0);k();h.gameState=4}else if(h.gameState==3){z();var D=O.getAlert(K.get("ALRT",
134));D.show();h.modalDialog=function(G){O.close(D);switch(G){case 1:j();break;case 3:h.gameState=4;h.runMain();break;default:L()}}}}function k(){var c=document.createElement("link");c.type="text/css";c.rel="stylesheet";c.href="print.css";c.media="print";$("head").append(c);var a=K.get("GNRL",129);a.r16();c=a.r16();var l=a.r16(),u=a.r16(),D=a.r16()-l;a=a.r16()-u;O.getDialog(K.get("DLOG",135)).show();h.isPaused=true;var G=V.create(u,l,a,D,4096,"",true,0,0,0,4);Sa.add(G);G.css("text-align","center");
G.css("font-size",c+"px");G.css("line-height",D+"px");G.focus();h.modalDialog=function(I){switch(I){case 1:G.blur();window.print();break;case 2:h.runMain()}}}function j(){for(var c=ka.getData(K.getString(133)),a=0;a<Na;a++)for(var l=0;l<ya;l++)la[a][l]=c.r16();for(a=0;a<Ma;a++)h.globals[a]=c.r16();s();e();qa.setTitle(K.getIndStr(128,1));ea.html("");h.selectedCtl=1;R=[h.get(1,0)];h.gameState=1;h.set(h.get(1,0),6,1);Da=Ea=Fa=h.gameChanged=false;sa.reset();h.cmdReady=true;h.runMain()}function t(){if(pa==
"")n();else{localStorage.setItem(pa,JSON.stringify({game:gamename,gamedata:la,globals:h.globals,text:ea.html()}));qa.setTitle(pa);h.gameChanged=false;Aa()}}function n(){var c=O.createDialog("","dBox",true,false,104,79,304,184,undefined);c.add(V.create(218,132,70,18,0,"Save",true,0,0,0,1));c.add(V.create(218,158,70,18,0,"Cancel",true,0,0,0,2));c.add(V.create(14,136,183,16,4352,"Save as:",true,0,0,0,3));c.add(V.create(17,157,177,16,4096,"",true,0,0,0,7));c.add(V.create(14,29,183,98,4608,"",true,0,0,
0,8));c.kind=2;h.isPaused=true;c.show();for(var a=c.getItem(8),l=undefined,u=0;u<localStorage.length;u++){var D=localStorage.key(u);if(JSON.parse(localStorage.getItem(D)).game==gamename){var G=$(document.createElement("div"));G.addClass("listitem");G.click(function(I){l&&l.removeClass("active");l=$(I.target);l.addClass("active");c.getItem(7).val(l.text())});G.text(D);a.append(G)}}h.modalDialog=function(I){switch(I){case 1:pa=c.getItem(7).val();O.close(c);h.isPaused=false;t();break;case 2:O.close(c);
h.isPaused=false;Aa()}}}function s(){O.reset();W.num=0;h.queue=[];h.soundQueue=[];h.textQueue=[];Ca=[]}function z(){for(ra&&ra.removeClass("active");ba.length;)p(ba.pop());m()}function p(c){var a=fa.find(c);if(a)ba.indexOf(c)!=-1?a.addClass("active"):a.removeClass("active");if(c==h.get(1,0))ba.indexOf(c)!=-1?fa.addClass("selected"):fa.removeClass("selected");h.updateWindow(h.getParentWin(c))}function r(c){switch(c){case 65532:return fa;case 65533:return ua;case 65534:return qa;case 65535:return commandsWin}return O.find(c)}
function g(c,a){for(var l=[],u=ca[c*2];u;){l.push(u);a||(l=l.concat(g(u,false)));u=ca[u*2+1]}return l}function o(c){if(!r(c))if(c==h.get(1,0)){P(c,Z);h.updateWindow(Z);X();var a=da.get(c);Z.setTitle(da.capitalize(a))}else{var l={h:h.get(c,1),v:h.get(c,2)};h.getParentWin(c).localToGlobal(l);var u=E();a=da.get(c);var D=O.create(a,"zoomDoc",false,true,u.left,u.top,u.width,u.height);D.kind=14;D.scrollbars();P(c,D);D.refCon.updateScroll=true;var G=$(document.createElement("div"));c=ma.position();G.addClass("zoom");
ma.append(G);G.css("top",l.v+"px");G.css("left",l.h+"px");G.css("width","0px");G.css("height","0px");G.animate({top:u.top+c.top+"px",left:u.left+c.left+"px",width:u.width+"px",height:u.height+"px"},500,function(){G.remove();D.show();h.updateWindow(D)})}}function A(c){var a=O.tryClose(r(c));if(a!=undefined){c=h.getParentWin(a.obj);if(c!=undefined){var l=$(document.createElement("div"));l.addClass("zoom");ma.append(l);l.css("top",a.top+"px");l.css("left",a.left+"px");l.css("width",a.width+"px");l.css("height",
a.height+"px");a={h:h.get(a.obj,1),v:h.get(a.obj,2)};c.localToGlobal(a);l.animate({top:a.v+"px",left:a.h+"px",width:"0px",height:"0px"},500,function(){l.remove();W.num--})}}}function B(c,a,l){var u={},D={h:0,v:0};c.localToGlobal(D);u.minx=D.h;u.miny=D.v;u.maxx=D.h+c.port.width();u.maxy=D.v+c.port.height();var G=$(document.createElement("div"));G.addClass("lasso");ma.append(G);G.css("top",a.pageY+"px");G.css("left",a.pageX+"px");G.css("width","0px");G.css("height","0px");$(document).mousemove(function(I){var U=
Math.max(Math.min(a.pageX,I.pageX),u.minx),M=Math.max(Math.min(a.pageY,I.pageY),u.miny),Q=Math.min(Math.max(a.pageX,I.pageX),u.maxx);I=Math.min(Math.max(a.pageY,I.pageY),u.maxy);G.css("top",M+"px");G.css("left",U+"px");G.css("width",Q-U+"px");G.css("height",I-M+"px")});$(document).mouseup(function(I){$(document).unbind("mousemove");$(document).unbind("mouseup");var U=Math.max(Math.min(a.pageX,I.pageX),u.minx),M=Math.max(Math.min(a.pageY,I.pageY),u.miny),Q=Math.min(Math.max(a.pageX,I.pageX),u.maxx),
Ya=Math.min(Math.max(a.pageY,I.pageY),u.maxy);G.remove();I={h:U,v:M};c.globalToLocal(I);M={top:I.v,left:I.h,width:Q-U,height:Ya-M};U=[];for(Q=0;Q<c.refCon.children.length;Q++){var ga=c.refCon.children[Q].id;if(!h.get(ga,4)){M.left=I.h-h.get(ga,1);M.top=I.v-h.get(ga,2);N(ga,M)&&U.push(ga)}}if(a.shiftkey){if(U.length==0){if(R.length==0||c!=h.getParentWin(R[0]))R.indexOf(c.refCon.id)!=-1?na(c.refCon.id):h.selectObj(c.refCon.id)}else for(;U.length;){ga=U.shift();R.indexOf(ga)!=-1?na(ga):h.selectObj(ga)}h.runMain()}else{if(U.length==
0)ga=c.refCon.id;else for(;U.length;){ga=U.shift();h.selectObj(ga)}h.handleObjectSelect(ga,c,a,l)}})}function E(){for(var c=W.left,a=W.top,l=0;l<W.num;l++){c+=W.stepx;a+=W.stepy;if(a>=330)a=W.top;if(c>=500)c=W.left}W.num++;return{top:a,left:c,width:W.width,height:W.height}}function P(c,a){var l=g(c,true);a.refCon={id:c,x:0,y:0,updateScroll:false,children:[]};for(var u=32767,D=32767,G=0;G<l.length;G++)if(l[G]!=1){child={id:l[G],top:0,left:0,width:0,height:0};if(a!=Z){var I=h.get(child,1),U=h.get(child,
2);if(u>I)u=I;if(D>U)D=U}a.refCon.children.push(child)}if(u!=32767)a.refCon.x=u;if(D!=32767)a.refCon.y=D;if(a!=Z)a.refCon.updateScroll=true}function X(){fa.killControls();for(var c=g(h.get(1,0),true),a=0;a<c.length;a++)F(c[a])}function F(c){if(h.get(c,8)){var a=fa.find(c);a&&fa.remove(a);if(!h.get(c,11)&&h.get(c,0)==h.get(1,0)){a=V.get(K.get("CNTL",128));a.data("refcon",c);V.move(a,h.get(c,9),h.get(c,10));fa.add(a)}}}function T(){if(Ea){Ea=false;if(sa.resume())return Ea=true;return false}if(Da){Da=
false;if(sa.resume())return Da=true;h.updateScreen(false)}for(;R.length;){var c=R.shift();if((h.gameState==0||h.gameState==1)&&Ja(c)){if(sa.run(h.selectedCtl,c,Y,aa))return Da=true;h.updateScreen(false)}}if(h.selectedCtl==1)h.gameChanged=false;else if(h.gameState==0||h.gameState==1)if(sa.run(3,h.selectedCtl,Y,aa))return Ea=true;return false}function Ja(c){if(!ha(c))return false;if(ia()>=2&&Y>0&&!ha(Y))return false;if(h.selectedCtl!=5)return true;if(!(h.get(c,3)==0&&h.get(c,4)==0&&h.get(c,5)==0))return false;
if(h.get(1,0)!=Y)return true;var a={top:0,left:0,width:Z.port.width(),height:Z.port.height()};a.top-=h.get(c,2)+aa.v;a.left-=h.get(c,1)+aa.h;return N(c,a)}function N(c,a){var l={top:0,left:0,width:0,height:0},u;if(u=ja.get(c*2+1)){l.width=u.width;l.height=u.height;if(ja.sectRect(l,a,l))return u.intersect(l);return false}if(u=ja.get(c*2)){l.width=u.width;l.height=u.height;return ja.sectRect(l,a,l)}return false}function ha(c){for(var a=h.get(1,0);c!=0&&c!=1&&c!=a;)c=h.get(c,0);return c}function ia(){if(!h.selectedCtl)return 3E3;
return Va[h.selectedCtl-1]}function na(c){var a=R.indexOf(c);a!=-1&&R.splice(a,1);if((a=ba.indexOf(c))!=-1){ba.splice(a,1);p(c)}}function ta(){var c=K.get(K.getIndStr(129,1),0),a=c.r8();c=h.mac2ascii(c.read(a));var l=O.createDialog("","dBox",true,false,146,96,220,150,undefined);l.add(V.create(75,120,70,18,0,"Ok",true,0,0,0,1));l.add(V.create(20,30,180,40,4352,c,true,0,0,0,2));l.add(V.create(20,80,180,40,4352,"WebVenture <br /> &#169; 2010 Sean Kasun",true,0,0,0,3));l.getItem(2).css("text-align","center");
l.getItem(3).css("text-align","center");l.kind=2;h.isPaused=true;l.show();h.modalDialog=function(){O.close(l);h.isPaused=false}}function va(){var c=O.createDialog("","dBox",true,false,146,96,220,120,undefined);c.add(V.create(75,90,70,18,0,"Ok",true,0,0,0,1));var a=h.setting("volume");if(a==null)a=100;c.add(V.create(55,55,110,13,4864,"",true,a,0,100,2));c.add(V.create(20,25,180,20,4352,"Sound Volume",true,0,0,0,3));c.getItem(3).css("text-align","center");c.kind=2;h.isPaused=true;c.show();h.modalDialog=
function(){var l=c.getItem(2).data("value"),u=new Date;u.setTime(u.getTime()+31536E6);document.cookie="webventure_volume="+escape(l)+"; expires="+u.toGMTString()+"; path=/";O.close(c);h.isPaused=false}}function x(){if(h.gameChanged){var c=h.mac2ascii(K.getIndStr(128,8)),a=O.getAlert(K.get("ALRT",131));h.isPaused=true;a.param([c]);a.show();h.modalDialog=function(l){O.close(a);switch(l){case 1:Aa=x;t();break;case 2:h.isPaused=false;break;case 3:j()}}}else j()}function C(){if(h.gameChanged){var c=h.mac2ascii(K.getIndStr(128,
9)),a=O.getAlert(K.get("ALRT",131));a.param([c]);a.show();h.isPaused=true;h.modalDialog=function(l){O.close(a);switch(l){case 1:Aa=C;t();break;case 2:h.isPaused=false;break;case 3:L()}}}else L()}function L(){var c=O.createDialog("","dBox",true,false,82,71,348,200,undefined);c.add(V.create(256,138,80,18,0,"Open",true,0,0,0,1));c.add(V.create(256,163,80,18,0,"Cancel",true,0,0,0,3));c.add(V.create(12,39,218,146,4608,"",true,0,0,0,7));c.kind=2;h.isPaused=true;c.show();for(var a=c.getItem(7),l=undefined,
u=0;u<localStorage.length;u++){var D=localStorage.key(u);if(JSON.parse(localStorage.getItem(D)).game==gamename){var G=$(document.createElement("div"));G.addClass("listitem");G.click(function(I){l&&l.removeClass("active");l=$(I.target);l.addClass("active")});G.text(D);a.append(G)}}h.modalDialog=function(I){switch(I){case 1:if(l==undefined)break;pa=l.text();O.close(c);h.isPaused=false;I=JSON.parse(localStorage.getItem(pa));la=I.gamedata;h.globals=I.globals;s();e();qa.setTitle(pa);ea.html(I.text);ea.scrollTop(1E4);
h.gameState=1;Da=Ea=Fa=false;R=[];h.selectedCtl=0;sa.reset();h.set(h.get(1,0),6,1);h.gameChanged=false;h.runMain();break;case 3:O.close(c);h.isPaused=false}}}function H(){if(h.gameChanged){var c=h.mac2ascii(K.getIndStr(128,7)),a=O.getAlert(K.get("ALRT",131));a.param([c]);a.show();h.isPaused=true;h.modalDialog=function(l){O.close(a);switch(l){case 1:Aa=H;t();break;case 2:h.isPaused=false;break;case 3:h.gameState=4;h.runMain()}}}else{h.gameState=4;h.runMain()}}function J(c){if(c!=Y){var a;if(Y>0&&(a=
ba.indexOf(Y))!=-1&&R.indexOf(Y)==-1){ba.splice(a,1);p(Y)}Y=c;if(ba.indexOf(Y)==-1){ba.push(Y);p(Y)}h.cmdReady=true}}function oa(c,a,l,u){var D=l.pageX,G=l.pageY,I={h:0,v:0},U=false;S=undefined;u&&$(document).mousemove(function(M){if(S==undefined){if(Math.abs(M.pageX-D)+Math.abs(M.pageY-G)<=7)return false;U=true;S=Ka(c);var Q=h.getChildIdx(a.refCon.children,c);if(Q){I.h=a.refCon.children[Q-1].left;I.v=a.refCon.children[Q-1].top}a.localToGlobal(I);S.css("top",I.v+"px");S.css("left",I.h+"px")}Q=S.position();
S.css("top",Q.top+(M.pageY-G)+"px");S.css("left",Q.left+(M.pageX-D)+"px");D=M.pageX;G=M.pageY;return false});$(document).mouseup(function(M){var Q;if(u){$(document).unbind("mousemove");if(S){Q=S.position();S.remove()}}$(document).unbind("mouseup");if(U){aa.h=Q.left;aa.v=Q.top;M=La(M.pageX,M.pageY);Y=M.id;aa.h-=I.h;aa.v-=I.v;if(M.win!=a){a.localToGlobal(aa);M.win&&M.win.globalToLocal(aa)}h.selectedCtl=5;h.activateCommand(5);h.cmdReady=true}if(!h.cmdReady){J(c);if(!h.selectedCtl){h.selectedCtl=4;h.activateCommand(4);
h.cmdReady=true}}h.runMain()})}function Ta(c,a,l,u){var D=l.pageX,G=l.pageY,I={h:0,v:0},U=false;S=undefined;u&&$(document).mousemove(function(M){if(S==undefined){if(Math.abs(M.pageX-D)+Math.abs(M.pageY-G)<=7)return false;U=true;S=Ka(c);var Q=h.getChildIdx(a.refCon.children,c);if(Q){I.h=a.refCon.children[Q-1].left;I.v=a.refCon.children[Q-1].top}a.localToGlobal(I);S.css("top",I.v+"px");S.css("left",I.h+"px")}Q=S.position();S.css("top",Q.top+(M.pageY-G)+"px");S.css("left",Q.left+(M.pageX-D)+"px");D=
M.pageX;G=M.pageY;return false});$(document).mouseup(function(M){Ra=M.timeStamp;var Q;if(u){$(document).unbind("mousemove");if(S){Q=S.position();S.remove()}}$(document).unbind("mouseup");if(U){aa.h=Q.left;aa.v=Q.top;M=La(M.pageX,M.pageY);Y=M.id;aa.h-=I.h;aa.v-=I.v;if(M.win!=a){a.localToGlobal(aa);M.win&&M.win.globalToLocal(aa)}h.selectedCtl=5;h.activateCommand(5);h.cmdReady=true}if(ia()==1)h.cmdReady=true;h.runMain()})}function Ga(c){ma.append(S);var a={h:h.get(c,1),v:h.get(c,2)};h.getParentWin(c).localToGlobal(a);
S.animate({top:a.v+"px",left:a.h+"px"},300,function(){S.remove()})}function Ka(c){var a=ja.get(c*2);c=ja.get(c*2+1);var l=a.width,u=a.height;if(c){if(l<c.width)l=c.width;if(u<c.height)u=c.height}var D=$(document.createElement("canvas"));D.addClass("proxy");D.attr("width",l);D.attr("height",u);ma.append(D);c?c.bic(D,0,0):ja.fill(D,0);a.xor(D,0,0);return D}function La(c,a){var l=O.findWindow(c,a),u=0;if(l.win!=undefined)u=l.win.kind;if(l.id==3&&(u==14||u==10))l.id=l.win.refCon.id;else switch(u){case 9:l.id=
-1;break;case 11:l.id=-2;break;case 12:l.id=-3;break;case 13:l.id=-4;break;default:switch(l.id){case 0:l.id=-5;break;case 1:l.id=-6;break;case 2:l.id=-7;break;case 3:l.id=-8;break;case 4:l.id=-9;break;case 5:l.id=-10;break;case 6:l.id=-11;break;default:l.id=-12}}return l}var h=this,ma,O,ka,xa,da,K,sa,V,Qa,ja,Xa,wa,Ha,Sa,Z,qa,ua,fa,ea;this.gameState=0;this.gameChanged=false;var ya,Ma,Ba,za,Na,W,Oa,Ia,Pa,Va,Wa,Ca,ba,R;this.textQueue=this.soundQueue=this.queue=undefined;var ra,Y,aa;this.cmdReady=false;
this.selectedCtl=undefined;var Ra,ca,pa="",la;this.globals=undefined;var Fa=false;var Ea=this.isPaused=false,Da=false;this.init=function(){var c=document.createElement("link");c.type="text/css";c.rel="stylesheet";c.href="game.css";$("head").append(c);ma=$(document.createElement("div"));ma.addClass("screen");wa=$(document.createElement("img"));wa.attr("src","images/start.png");wa.css("width","100%");wa.css("height","100%");ma.append(wa);$("script").filter(function(){return this.src.match(/webventure_(min|full)\.js/)}).after(ma);
ka=new FileManager(gamename);K=new ResourceManager(ka);xa=new ObjectManager(ka);da=new TextManager(xa,K);V=new ControlManager;O=new WindowManager(ma,K,V);ja=new GraphicManager(xa);Xa=new SoundManager(xa);Qa=new MenuManager(ma);sa=new Engine(xa,da,K,ja);y()};this.get=function(c,a){var l,u=Oa[a];if(u&128){var D=xa.get(0,c);if(D.length==0)return 0;u&=127;l=(D.charCodeAt(u*2)&255)<<8;l|=D.charCodeAt(u*2+1)&255}else l=la[u][c];l&=Ia[a];return ka.neg16(l>>Pa[a])};this.set=function(c,a,l){if(a==0){var u=
l,D=la[0][c];if(u!=c){var G=D*2;for(D=ca[G];D!=c;){G=D*2+1;D=ca[G]}ca[G]=ca[D*2+1];G=u*2;for(D=ca[G];D&&D<=c;){G=D*2+1;D=ca[G]}ca[c*2+1]=D;ca[G]=c}}a<12&&b(c);idx=Oa[a];l<<=Pa[a];l&=Ia[a];la[idx][c]=l|la[idx][c]&~Ia[a];h.gameChanged=true};this.updateObject=function(c){var a;if(a=this.get(1,0)==c?Z:r(c)){d(c);h.runQueue();h.updateWindow(a)}};this.updateWindow=function(c){if(c!=undefined)if(c.refCon!=undefined)if(c==ua||h.get(c.refCon.id,6)==1){c==Z?ja.get(c.refCon.id*2).draw(Z.port,0,0):ja.fill(c.port,
0);for(var a=0;a<c.refCon.children.length;a++){var l=h.drawObject(c.refCon.children[a].id,c,0);c.refCon.children[a].top=l.top;c.refCon.children[a].left=l.left;c.refCon.children[a].width=l.width;c.refCon.children[a].height=l.height}if(c.kind==14&&c.refCon.updateScroll==true){a={top:0,left:0,right:0,bottom:0};c.refCon.updateScroll=false;for(l=0;l<c.refCon.children.length;l++){var u=c.refCon.children[l];if(a.right==a.left||a.bottom==a.top){a.top=u.top;a.left=u.left;a.bottom=u.top+u.height;a.right=u.left+
u.width}else{a.top=Math.min(a.top,u.top);a.left=Math.min(a.left,u.left);var D=u.left+u.width;a.bottom=Math.max(a.bottom,u.top+u.height);a.right=Math.max(a.right,D)}}if(a.right==a.left||a.bottom==a.top){a.top=c.refCon.y;a.left=c.refCon.x;a.bottom=c.refCon.y;a.right=c.refCon.x}else{if(a.left>c.refCon.x)a.left=c.refCon.x;if(a.right<c.refCon.x)a.right=c.refCon.x;if(a.top>c.refCon.y)a.top=c.refCon.y;if(a.bottom<c.refCon.y)a.bottom=c.refCon.y}c.setScrollBounds(a)}}};this.drawObject=function(c,a,l){var u=
h.get(c,1),D=h.get(c,2),G=h.get(c,3);if(l||!G||!h.get(c,4)){var I=1;if(G||l)I=0;else if(ba.indexOf(c)!=-1)I=2;c=ja.draw(c,u-a.refCon.x,D-a.refCon.y,a.port,I);c.top+=a.refCon.y;c.left+=a.refCon.x;return c}return{top:0,left:0,width:0,height:0}};this.runMain=function(){if(h.gameState==4)window.location="index.html";else{Fa||h.updateScreen(false);if(h.cmdReady||Fa){Fa=false;if(T()){Fa=true;h.isPaused=true;return}h.isPaused=false;h.updateScreen(false);z()}if(h.gameState==2||h.gameState==3)f()}};this.updateScreen=
function(c){this.runQueue();this.printTexts();return this.playSounds(c)};this.runQueue=function(){for(;h.queue.length;){for(var c,a=0,l=0;l<h.queue.length;l++)if(h.queue[l].id>a){a=h.queue[l].id;c=l}a=h.queue.splice(c,1)[0];switch(a.id){case 2:d(a.val);break;case 3:o(a.val);break;case 4:A(a.val);break;case 7:a:{l=a.val;var u=false;a=l.obj;var D=Ca.indexOf(a);D!=-1&&Ca.splice(D,1);if(a==1){l.parent!=h.get(a,0)&&h.queue.push({id:12});if(l.offscreen!=h.get(a,3)||l.invisible!=h.get(a,4))h.updateWindow(h.getParentWin(a))}else if(l.parent!=
h.get(a,0)||l.x!=h.get(a,1)||l.y!=h.get(a,2)){if(D=r(l.parent)){u=D;if(u.refCon!=undefined){D=h.getChildIdx(u.refCon.children,a);if(D!=0){u.refCon.children.splice(D-1,1);u.refCon.updateScroll=true;h.updateWindow(u)}}u=true}if(D=h.getParentWin(a)){u=D;if(u.refCon!=undefined){D=void 0;for(D=0;D<u.refCon.children.length&&a>u.refCon.children[D].id;D++);if(D==u.refCon.children.length||a!=u.refCon.children[D].id){u.refCon.children.splice(D,0,{id:a,top:0,left:0,width:0,height:0});u.refCon.updateScroll=true;
h.updateWindow(u)}}u=true}}else if(l.offscreen!=h.get(a,3)||l.invisible!=h.get(a,4))h.updateWindow(h.getParentWin(a));if(h.get(a,8))if(u||l.hidden!=h.get(a,11)||l.exitx!=h.get(a,9)||l.exity!=h.get(a,10))F(a);l=r(a);u=a;for(D=h.get(1,0);u!=D;){if(u==0||!h.get(u,6))break;u=h.get(u,0)}if(u==D){if(l)break a;h.queue.push({id:3,val:a})}else{if(!l)break a;h.queue.push({id:4,val:a})}a=g(a,true);for(D=0;D<a.length;D++)b(a[D])}break;case 8:a=a.val;u=r(a.from);(l=D=r(a.to))||(l=u);if(l){u=da.get(a.to);l.setTitle(u);
P(a.to,l);l.refCon.updateScroll=true;h.updateWindow(l)}break;case 12:h.set(Z.refCon.id,6,0);h.set(h.get(1,0),6,1);break;case 13:for(;ba.length;)p(ba.pop());break;case 14:Ga(a.val)}}};this.playSounds=function(c){for(var a=0;h.soundQueue.length;){var l=h.soundQueue.splice(0,1)[0];switch(l.id){case 1:Xa.play(l.val);break;case 2:a=Xa.play(l.val);break;case 3:console.log("wait?")}}if(c&&a){setTimeout(h.runMain,a*1E3);return true}return false};this.printTexts=function(){for(;h.textQueue.length;){var c=
h.textQueue.splice(0,1)[0];switch(c.id){case 1:ea.append(c.val);ea.scrollTop(1E4);h.gameChanged=true;break;case 2:ea.append("<br/>");ea.scrollTop(1E4);h.gameChanged=true;break;case 3:da.source=c.val[1];da.target=c.val[0];ea.append(da.get(c.val[2]));ea.scrollTop(1E4);h.gameChanged=true}}};this.invertmain=function(){Z.invert()};this.revertmain=function(){Z.invert();h.runMain()};this.getParentWin=function(c){if(c==1)return ua;if(c=h.get(c,0))return r(c)};this.getFamily=function(c,a){return[c].concat(g(c,
a))};this.getChildIdx=function(c,a){var l;for(l=0;l<c.length&&c[l].id!=a;l++);if(l==c.length)return 0;return l+1};this.unselectall=function(){for(;R.length;)na(R.shift())};this.selectObj=function(c){R.length&&h.getParentWin(c)!=h.getParentWin(R[0])&&h.unselectall();R.indexOf(c)==-1&&R.push(c);if(ba.indexOf(c)==-1){ba.push(c);p(c)}};this.activateCommand=function(c){c=commandsWin.find(c);if(c!=ra){ra&&ra.removeClass("active");(ra=c)&&c.addClass("active")}};var Aa=undefined;this.menuSelect=function(c,
a){switch(c){case 128:switch(a){case 1:ta();break;case 3:va()}break;case 129:switch(a){case 1:x();break;case 3:C();break;case 4:Aa=function(){};t();break;case 5:Aa=function(){};n();break;case 7:H()}break;case 131:switch(a){case 1:cleanup();break;case 2:messup()}break;case 132:doFont(a);break;case 133:doFontSize(a)}};this.buttonClicked=function(c,a){var l=c.data("win");if(l.kind==2)return this.modalDialog(c.data("refcon"));if(l==fa)h.isPaused||h.handleObjectSelect(c.data("refcon"),fa,a,false);else if(c.data("refcon")==
0){commandsWin.remove(Ua);commandsWin.showControls();h.runMain()}else if(!h.isPaused){ra&&c!=ra&&ra.removeClass("active");h.selectedCtl=c.data("refcon");h.activateCommand(h.selectedCtl);switch(ia()){case 0:h.cmdReady=true;break;case 1:h.cmdReady=R.length!=0;break;case 2:if(Y>0)h.cmdReady=true}h.runMain()}};this.handleObjectSelect=function(c,a,l,u){if(a==fa)a=Z;if(l.shiftKey)if(c){R.indexOf(c)!=-1?na(c):h.selectObj(c);h.runMain()}else if(a.kind==14)B(a,l,u);else{if(R.length==0||a!=h.getParentWin(R[0]))R.indexOf(a.refCon.id)!=
-1?na(a.refCon.id):h.selectObj(a.refCon.id);h.runMain()}else if(h.selectedCtl&&R.length&&ia()>1){c?J(c):J(a.refCon.id);h.runMain()}else{if(!c){h.unselectall();if(a.kind==14)B(a,l,u);else c=a.refCon.id}if(c){var D;if(l.timeStamp-Ra<=300){Ra=0;D=true}else D=false;if(D){R.indexOf(c)==-1&&h.unselectall();h.selectObj(c);oa(c,a,l,u)}else{R.indexOf(c)==-1&&h.unselectall();h.selectObj(c);Ta(c,a,l,u)}}}};var S=undefined;this.objHit=function(c,a){var l=0,u;if(u=!this.get(a.id,4))u=c.h>=a.left&&c.v>=a.top&&
c.h<a.left+a.width&&c.v<a.top+a.height?true:false;if(u)if(bmp=ja.get(a.id*2+1)){if(bmp.hit(c.h-a.left,c.v-a.top))l=a.id}else l=a.id;return l};var Ua;this.clickToContinue=function(){var c=commandsWin.port.width(),a=commandsWin.port.height();Ua=V.create(4,4,c-8,a-8,2048,"Click to continue",true,0,0,0,0);Ua.addClass("ctc");commandsWin.hideControls();commandsWin.add(Ua)};this.textEntry=function(c,a,l){da.target=l;da.source=a;var u=O.getDialog(K.get("DLOG",132));u.param([da.get(c)]);u.show();h.modalDialog=
function(D){da.input=u.getItem(3).val();D!=2?sa.push(65535):sa.push(0);O.close(u);h.runMain()}};this.mac2ascii=function(c){for(var a="",l=0;l<c.length;l++)switch(c.charCodeAt(l)){case 13:a+="<br />";break;case 63368:a+="&#224;";break;case 63374:a+="&#233;";break;case 63401:a+="&#169;";break;case 63433:a+="...";break;case 63441:a+="&#8212;";break;default:a+=c.charAt(l)}return a};this.setting=function(c){var a=document.cookie.split(";");c="webventure_"+c+"=";for(var l=0;l<a.length;l++){for(var u=a[l];u.charAt(0)==
" ";)u=u.substring(1,u.length);if(u.indexOf(c)==0)return unescape(u.substring(c.length,u.length))}return null}}var webventure=new WebVenture;function Win(y,w,m,e,d,b,f,k,j){function t(x,C){var L=x,H=C;j.bringToFront(F);$(document).mousemove(function(J){var oa=N.position();N.css("top",oa.top+(J.pageY-H)+"px");N.css("left",oa.left+(J.pageX-L)+"px");L=J.pageX;H=J.pageY});$(document).mouseup(function(J){$(document).unbind("mousemove");$(document).unbind("mouseup");var oa=N.position();N.css("top",oa.top+(J.pageY-H)+"px");N.css("left",oa.left+(J.pageX-L)+"px")})}function n(x,C){var L={h:x,v:C},H=0,J=F.refCon.children.length;for(F.globalToLocal(L);J>
0&&H==0;){J--;H=webventure.objHit(L,F.refCon.children[J])}return H}function s(x,C,L){x.refCon.x+=C;x.refCon.y+=L;var H=E.data("min"),J=E.data("max");if(x.refCon.x<H)x.refCon.x=H;if(x.refCon.x>J-b+15)x.refCon.x=J-b+15;H=P.data("min");J=P.data("max");if(x.refCon.y<H)x.refCon.y=H;if(x.refCon.y>J-f+15)x.refCon.y=J-f+15;x.refCon.updateScroll=true;webventure.updateWindow(F);var oa=setTimeout(s,50,x,C,L);$(document).mouseup(function(){$(document).unbind("mouseup");clearTimeout(oa)})}function z(x,C){var L=
x;$(document).mousemove(function(H){if(C){F.refCon.x+=H.pageX-L;L=H.pageX;H=E.data("min");var J=E.data("max");if(F.refCon.x<H)F.refCon.x=H;if(F.refCon.x>J-b+15)F.refCon.x=J-b+15}else{F.refCon.y+=H.pageY-L;L=H.pageY;H=P.data("min");J=P.data("max");if(F.refCon.y<H)F.refCon.y=H;if(F.refCon.y>J-f+15)F.refCon.y=J-f+15}F.refCon.updateScroll=true;webventure.updateWindow(F)});$(document).mouseup(function(){$(document).unbind("mouseup");$(document).unbind("mousemove")})}var p=undefined,r=undefined,g=undefined,
o=undefined,A=undefined,B=undefined,E=undefined,P=undefined,X=undefined,F=this,T=[];y=undefined;var Ja=w=="zoomDoc",N=$(document.createElement("div"));N.addClass(w);if(w!="plainDBox"&&w!="altDBox"&&w!="dBox"){var ha="<span></span>";y=$(document.createElement("div"));y.addClass("title");y.mousedown(function(x){webventure.isPaused||t(x.pageX,x.pageY);return false});if(m)ha='<div class="close"></div>'+ha;if(Ja)ha+='<div class="resize"></div>';y.html(ha);if(m){ha=y.children("div.close");ha.mousedown(function(){return false});
ha.click(function(){if(!webventure.isPaused){if(F.kind==14){webventure.unselectall();webventure.selectObj(F.refCon.id);webventure.selectedCtl=2;webventure.activateCommand(2);webventure.cmdReady=true}webventure.runMain()}return false})}if(Ja){ha=y.children("div.resize");ha.mousedown(function(){return false});ha.click(function(){resizeClicked();return false})}N.append(y)}this.port=$(document.createElement("canvas"));this.port.mousedown(function(x){if(!webventure.isPaused){j.bringToFront(F);switch(F.kind){case 9:t(x.pageX,
x.pageY);break;case 10:case 14:var C=n(x.pageX,x.pageY),L=false;if(C&&!webventure.get(C,3))L=true;webventure.handleObjectSelect(C,F,x,L);break;case 12:C=n(x.pageX,x.pageY);C==1?webventure.handleObjectSelect(C,F,x,false):t(x.pageX,x.pageY);break;case 13:webventure.handleObjectSelect(webventure.get(1,0),F,x,false)}}return false});this.port.attr("width",b);this.port.attr("height",f);N.append(this.port);var ia=d,na=f,ta=e,va=b;if(y!=undefined){ia-=17;na+=18}if(w=="dBox"){ia-=2;ta-=2;va+=2;na+=2}N.css("top",
ia+"px");N.css("left",ta+"px");N.css("width",va+"px");N.css("height",na+"px");k.append(N);this.show=function(){N.show()};this.hide=function(){N.hide()};this.setTitle=function(x){if(y!=undefined){var C=y.children("span");C.html("");if(x=="")C.hide();else{var L=N.css("display")=="none";N.show();C.css({position:"absolute",visibility:"hidden",display:"block"});var H=b;if(m)H-=30;if(Ja)H-=30;for(var J=0;J<x.length;J++){C.append(x.substring(J,J+1));if(C.width()>H){C.html(x.substring(0,J-1));break}}C.css({position:"",
visibility:"",display:""});L&&N.hide()}}};this.setCanvas=function(x){this.port.remove();x.css("top","0px");x.css("left","0px");x.css("width",b+"px");x.css("height",f+"px");N.append(x)};this.addClass=function(x){N.addClass(x)};this.removeClass=function(x){N.removeClass(x)};this.add=function(x){if(y!=undefined){var C=parseInt(x.css("top"),10);x.css("top",C+17+"px")}N.append(x);x.data("win",this);T.unshift(x)};this.remove=function(x){var C=T.indexOf(x);C!=-1&&T.splice(C,1);x.remove()};this.find=function(x){for(var C=
0;C<T.length;C++)if(T[C].data("refcon")==x)return T[C]};this.killControls=function(){for(var x=0;x<T.length;x++)T[x].remove();T=[]};this.hideControls=function(){for(var x=0;x<T.length;x++)T[x].hide()};this.showControls=function(){for(var x=0;x<T.length;x++)T[x].show()};this.close=function(){N.remove()};this.globalToLocal=function(x){var C=N.position();x.h-=C.left;x.v-=C.top;C=this.port.position();x.h-=C.left;x.v-=C.top;x.h+=this.refCon.x;x.v+=this.refCon.y};this.localToGlobal=function(x){var C=N.position();
x.h+=C.left;x.v+=C.top;C=this.port.position();x.h+=C.left;x.v+=C.top;x.h-=this.refCon.x;x.v-=this.refCon.y};this.hit=function(x,C){pos=N.position();if(x>=pos.left&&x<pos.left+N.width()&&C>=pos.top&&C<pos.top+N.height()){x-=pos.left;C-=pos.top;pos=this.port.position();if(x>=pos.left&&x<pos.left+this.port.width()&&C>=pos.top&&C<pos.top+this.port.height())return{id:3,win:this};return{id:4,win:this}}};this.invert=function(){var x=F.port.get(0).getContext("2d"),C=F.port.width(),L=F.port.height();C=x.getImageData(0,
0,C,L);for(L=0;L<C.height;L++)for(var H=L*C.width*4,J=0;J<C.width;J++){C.data[H++]^=255;C.data[H++]^=255;C.data[H++]^=255;C.data[H++]=255}x.putImageData(C,0,0)};this.param=function(x){for(var C=0;C<T.length;C++){var L=T[C].text().indexOf("^");if(L>=0){var H=T[C].text().substr(0,L),J=T[C].text().substr(L+1,1);H+=x[parseInt(J,10)];H+=T[C].text().substr(L+2);T[C].text(H)}}};this.getItem=function(x){for(var C=0;C<T.length;C++)if(T[C].data("refcon")==x)return T[C]};this.scrollbars=function(){F.port.attr("width",
b-15);F.port.attr("height",f-15);p=$(document.createElement("div"));p.addClass("hscroll");p.css("top",18+f-15+"px");p.css("left","0px");p.css("width",b-15+"px");p.css("height","14px");p.mousedown(function(x){j.bringToFront(F);var C=E.position().left+N.position().left;x.pageX<C?s(F,-20,0):s(F,20,0);return false});A=$(document.createElement("div"));A.addClass("leftarrow");A.css("top","0px");A.css("left","0px");A.css("width","14px");A.css("height","14px");A.mousedown(function(){s(F,-5,0);return false});
p.append(A);B=$(document.createElement("div"));B.addClass("rightarrow");B.css("top","0px");B.css("left",b-30+"px");B.css("width","14px");B.css("height","14px");B.mousedown(function(){s(F,5,0);return false});p.append(B);E=$(document.createElement("div"));E.addClass("slider");E.css("top","0px");E.css("left","15px");E.css("width","30px");E.css("height","12px");E.mousedown(function(x){z(x.pageX,true);return false});p.append(E);N.append(p);r=$(document.createElement("div"));r.addClass("vscroll");r.css("top",
"17px");r.css("left",b-15+"px");r.css("width","14px");r.css("height",f-15+"px");r.mousedown(function(x){j.bringToFront(F);var C=P.position().top+N.position().top;x.pageY<C?s(F,0,-20):s(F,0,20);return false});g=$(document.createElement("div"));g.addClass("uparrow");g.css("top","0px");g.css("left","0px");g.css("width","14px");g.css("height","14px");g.mousedown(function(){s(F,0,-5);return false});r.append(g);o=$(document.createElement("div"));o.addClass("downarrow");o.css("top",f-30+"px");o.css("left",
"0px");o.css("width","14px");o.css("height","14px");o.mousedown(function(){s(F,0,5);return false});r.append(o);P=$(document.createElement("div"));P.addClass("slider");P.css("top","15px");P.css("left","0px");P.css("width","12px");P.css("height","30px");P.mousedown(function(x){z(x.pageY,false);return false});r.append(P);N.append(r);X=$(document.createElement("div"));X.addClass("grow");X.css("top",18+f-15+"px");X.css("left",b-15+"px");X.css("width","14px");X.css("height","14px");X.mousedown(function(x){j.bringToFront(F);
var C=$(document.createElement("div"));C.addClass("resizeProxy");k.append(C);var L=N.position();C.css("top",L.top+"px");C.css("left",L.left+"px");var H=ta+va,J=ia+na;C.css("width",H-ta+"px");C.css("height",J-ia+"px");var oa=x.pageX,Ta=x.pageY;$(document).mousemove(function(Ga){var Ka=H+(Ga.pageX-oa),La=J+(Ga.pageY-Ta);if(Ka>ta+100){H=Ka;C.css("width",H-ta+"px");oa=Ga.pageX}if(La>ia+100){J=La;C.css("height",J-ia+"px");Ta=Ga.pageY}});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");
C.remove();F.resize(H-ta,J-ia)});return false});N.append(X)};this.setScrollBounds=function(x){if(x.left>F.refCon.x)x.left=F.refCon.x;if(x.right<F.refCon.x+b-15)x.right=F.refCon.x+b-15;if(x.top>F.refCon.y)x.top=F.refCon.y;if(x.bottom<F.refCon.y+f-15)x.bottom=F.refCon.y+f-15;E.data("min",x.left);E.data("max",x.right);P.data("min",x.top);P.data("max",x.bottom);x=E.data("min");var C=E.data("max");if(x<C){var L=b-15,H=(F.refCon.x-x)*(b-45)/(C-x)|0;x=L*(b-45)/(C-x)|0;if(x>b-45-H)x=b-45-H;E.css("left",H+
15+"px");E.css("width",x-2+"px")}else{E.css("left","15px");E.css("width",b-47+"px")}x=P.data("min");C=P.data("max");if(x<C){H=F.refCon.y-x;L=f-15;H=H*(f-45)/(C-x)|0;x=L*(f-45)/(C-x)|0;if(x>f-45-H)x=f-45-H;P.css("top",H+15+"px");P.css("height",x-2+"px")}else{P.css("top","15px");P.css("height",f-47+"px")}};this.resize=function(x,C){va=x;na=C;f=C-18;b=va;N.css("width",va+"px");N.css("height",na+"px");p.css("top",18+f-15+"px");p.css("width",b-15+"px");B.css("left",b-30+"px");r.css("left",b-15+"px");r.css("height",
f-15+"px");o.css("top",f-30+"px");X.css("top",18+f-15+"px");X.css("left",b-15+"px");F.port.attr("width",b);F.port.attr("height",f);F.refCon.updateScroll=true;webventure.updateWindow(F)}}
function Dialog(y,w,m,e,d,b,f,k,j,t,n){var s=new Win(y,w,m,e,d,b,f,j,t);s.kind=2;this.show=function(){s.show()};this.hide=function(){s.hide()};this.close=function(){s.close()};this.setTitle=function(z){s.setTitle(z)};this.param=function(z){s.param(z)};this.getItem=function(z){return s.getItem(z)};this.add=function(z){s.add(z)};this.addClass=function(z){s.addClass(z)};this.removeClass=function(z){s.removeClass(z)};if(k!=undefined){y=k.r16()+1;for(w=0;w<y;w++){k.r32();m=k.r16();e=k.r16();d=k.r16()-
m;b=k.r16()-e;f=k.r8();j=k.r8();t="";if(j>0)t=webventure.mac2ascii(k.read(j));j&1&&k.r8();switch(f&127){case 4:m=n.create(e,m,b,d,0,t,true,0,0,0,w+1);s.add(m);break;case 8:m=n.create(e,m,b,d,4352,t,true,0,0,0,w+1);s.add(m);break;case 16:m=n.create(e,m,b,d,4096,t,true,0,0,0,w+1);s.add(m);break;default:console.log("Unknown DITL: "+(f&127));this.die()}}}}
function WindowManager(y,w,m){var e=[];this.create=function(d,b,f,k,j,t,n,s){var z=y.position();j+=z.left;t+=z.top;b=new Win(d,b,k,j,t,n,s,y,this);f==false&&b.hide();b.setTitle(d);this.bringToFront(b);return b};this.createDialog=function(d,b,f,k,j,t,n,s,z){var p=y.position();j+=p.left;t+=p.top;b=new Dialog(d,b,k,j,t,n,s,z,y,this,m);f==false&&b.hide();b.setTitle(d);this.bringToFront(b);return b};this.get=function(d){var b=d.r16(),f=d.r16(),k=d.r16()-b,j=d.r16()-f,t="";switch(d.r16()){case 0:t="document";
break;case 1:t="dBox";break;case 2:t="plainDBox";break;case 3:t="altDBox";break;case 4:t="noGrowDoc";break;case 5:t="movableDBox";break;case 8:t="zoomDoc";break;case 12:t="zoomNoGrow";break;case 16:t="rDoc16";break;case 18:t="rDoc4";break;case 20:t="rDoc6";break;case 22:t="rDoc10"}var n=d.r16()!=0,s=d.r16()!=0;d.r32();var z=d.r8(),p="";if(z!=1)p=webventure.mac2ascii(d.read(z));return this.create(p,t,n,s,f,b,j,k)};this.getDialog=function(d){var b=d.r16(),f=d.r16(),k=d.r16()-b,j=d.r16()-f,t="";switch(d.r16()){case 0:t=
"document";break;case 1:t="dBox";break;case 2:t="plainDBox";break;case 3:t="altDBox";break;case 4:t="noGrowDoc";break;case 5:t="movableDBox";break;case 8:t="zoomDoc";break;case 12:t="zoomNoGrow";break;case 16:t="rDoc16";break;case 18:t="rDoc4";break;case 20:t="rDoc6";break;case 22:t="rDoc10"}var n=d.r8()!=0;d.r8();var s=d.r8()!=0;d.r8();d.r32();var z=d.r16(),p=d.r8(),r="";if(p!=1)r=webventure.mac2ascii(d.read(p));d=w.get("DITL",z);return this.createDialog(r,t,n,s,f,b,j,k,d)};this.getAlert=function(d){var b=
d.r16(),f=d.r16(),k=d.r16()-b,j=d.r16()-f;d=d.r16();d=w.get("DITL",d);return this.createDialog("","dBox",true,false,f,b,j,k,d)};this.close=function(d){for(var b=0;b<e.length;b++)if(e[b]==d){d.close();e.splice(b,1);break}e.length&&this.bringToFront(e[0])};this.tryClose=function(d){if(d!=undefined){var b=d.refCon.id;d.refCon={};if(d.kind==10)d.setTitle("");else{var f={v:0,h:0},k={v:d.port.height(),h:d.port.width()};d.localToGlobal(f);d.localToGlobal(k);this.close(d);return{obj:b,top:f.v,left:f.h,width:k.h-
f.h,height:k.v-f.v}}}};this.find=function(d){for(var b=0;b<e.length;b++)if(e[b].kind==10||e[b].kind==14)if(e[b].refCon!=undefined&&e[b].refCon.id==d)return e[b]};this.bringToFront=function(d){if(e[0]!=d){e[0]!=undefined&&e[0].removeClass("active");for(var b=0;b<e.length;b++)e[b]==d&&e.splice(b,1);e.unshift(d)}d.addClass("active")};this.findWindow=function(d,b){var f=y.position();if(b>=f.top&&b<f.top+20&&d>=f.left&&d<f.left+y.width())return{id:1,win:undefined};for(f=0;f<e.length;f++){var k=e[f].hit(d,
b);if(k!=undefined)return k}return{id:0,win:undefined}};this.reset=function(){for(var d=[],b=0;b<e.length;b++)if(e[b].kind==10||e[b].kind==14)d.push(e[b]);for(b in d)this.tryClose(d[b])};this.closeAll=function(){for(var d=[],b=0;b<e.length;b++)e[b].kind==14?d.push(e[b]):e[b].hide();for(b in d)this.tryClose(d[b])}};function File(y){this.set=0;this.cur=1;this.end=2;this.length=y.length;var w=0;this.bit=0;this.eof=function(){return w>=this.length};this.r8=function(){return y.charCodeAt(w++)&255};this.r16=function(){var m=(y.charCodeAt(w++)&255)<<8;m|=y.charCodeAt(w++)&255;return m};this.r24=function(){var m=(y.charCodeAt(w++)&255)<<16;m|=(y.charCodeAt(w++)&255)<<8;m|=y.charCodeAt(w++)&255;return m};this.r32=function(){var m=(y.charCodeAt(w++)&255)<<24;m|=(y.charCodeAt(w++)&255)<<16;m|=(y.charCodeAt(w++)&255)<<
8;m|=y.charCodeAt(w++)&255;return m};this.peek32=function(){var m=(y.charCodeAt(w)&255)<<24;m|=(y.charCodeAt(w+1)&255)<<16;m|=(y.charCodeAt(w+2)&255)<<8;m|=y.charCodeAt(w+3)&255;return m};this.seek=function(m,e){switch(e){case this.cur:m+=w;break;case this.end:m+=this.length}w=m};this.read=function(m){var e=w;w+=m;return y.substring(e,w)};this.bits=function(m){var e=this.peek32();e>>=32-this.bit-m;e&=(1<<m)-1;this.bit+=m;if(this.bit&16){this.bit&=15;w+=2}return e}}
function MacFile(y,w,m,e,d,b,f,k){this.parent=y;this.name=w;this.type=m;this.creator=e;this.dataStart=d;this.dataLen=b;this.resStart=f;this.resLen=k}
function FileManager(y){function w(k,j){var t=k+j*512;f.seek(t+8,f.set);var n=f.r8();f.r8();var s=f.r16();switch(n){case 0:for(n=0;n<s;n++){f.seek(t+512-(n+1)*2,f.set);var z=f.r16();f.seek(t+z,f.set);var p=f.r8();f.seek(t+z+p+1,f.set);z=f.r32();w(k,z)}break;case 255:for(n=0;n<s;n++){f.seek(t+512-(n+1)*2,f.set);z=f.r16();p=t+z;f.seek(p,f.set);var r=f.r8();if(r!=0){r++;r&1&&r++;f.r8();z=f.r32();var g=f.r8();g=f.read(g);f.seek(p+r,f.set);switch(f.r16()){case 512:f.seek(p+r+4,f.set);var o=f.r32(),A=f.r32();
f.seek(p+r+20,f.set);var B=f.r32();f.seek(2,f.cur);var E=f.r32();f.seek(6,f.cur);var P=f.r32();f.seek(p+r+74,f.set);var X=f.r16();f.seek(p+r+86,f.set);p=f.r16();m[B]=new MacFile(z,g,o,A,X,E,p,P)}}}break;default:console.log("Bad node!");this.die()}}var m=[],e,d,b,f=undefined;$.ajax({url:y,beforeSend:function(k){k.overrideMimeType("text/html; charset=x-user-defined")},complete:function(k){f=new File(k.responseText);f.seek(1044,f.set);e=f.r32();f.seek(1052,f.set);d=f.r16();f.seek(1174,f.set);b=f.r16();
k=(b+d)*e;f.seek(k+e-2,f.set);var j=f.r16();f.seek(k+j+2,f.set);j=f.r32();w(k,j)}});this.isReady=function(){return f!=undefined};this.getResByKind=function(k,j){for(var t=0,n=0,s=0;s<4;s++){t|=k.charCodeAt(s)<<24-s*8;n|=j.charCodeAt(s)<<24-s*8}for(s in m)if(m[s].type==t&&m[s].creator==n){f.seek((m[s].resStart+d)*e,f.set);return new File(f.read(m[s].resLen))}};this.getRes=function(k){for(var j in m)if(m[j].name==k){if(m[j].resLen==0)break;f.seek((m[j].resStart+d)*e,f.set);return new File(f.read(m[j].resLen))}};
this.getData=function(k){for(var j in m)if(m[j].name==k){if(m[j].dataLen==0)break;f.seek((m[j].dataStart+d)*e,f.set);return new File(f.read(m[j].dataLen))}};this.neg16=function(k){if(k&32768)k=-((k^65535)+1);return k}};function BitMap(y,w,m){this.width=y;this.height=w;this.rowBytes=m;this.data=Array(w*m);this.draw=function(e,d,b){if(!(y==0||w==0)){var f=e.get(0).getContext("2d"),k=y,j=w,t=0,n=0;if(d<0){t=-d;d=0}if(b<0){n=-b;b=0}if(k+d>=e.width())k=e.width()-d;if(j+b>=e.height())j=e.height()-b;if(!(k==0||j==0)){e=f.getImageData(d,b,k,j);for(var s=n;s<j;s++)for(var z=s*m,p=(s-n)*e.width*4,r,g=t;g<k;g++){r=(r=this.data[z+(g>>3)]&1<<7-(g&7))?0:255;e.data[p++]=r;e.data[p++]=r;e.data[p++]=r;e.data[p++]=255}f.putImageData(e,
d,b)}}};this.bic=function(e,d,b){if(!(y==0||w==0)){var f=e.get(0).getContext("2d"),k=y,j=w,t=0,n=0;if(d<0){t=-d;d=0}if(b<0){n=-b;b=0}if(k+d>e.width())k=e.width()-d;if(j+b>e.height())j=e.height()-b;if(!(k==0||j==0)){e=f.getImageData(d,b,k,j);for(var s=n;s<j;s++)for(var z=s*m,p=(s-n)*e.width*4,r,g=t;g<k;g++)if(r=this.data[z+(g>>3)]&1<<7-(g&7)){e.data[p++]=255;e.data[p++]=255;e.data[p++]=255;e.data[p++]=255}else p+=4;f.putImageData(e,d,b)}}};this.or=function(e,d,b){if(!(y==0||w==0)){var f=e.get(0).getContext("2d"),
k=y,j=w,t=0,n=0;if(d<0){t=-d;d=0}if(b<0){n=-b;b=0}if(k+d>=e.width())k=e.width()-d;if(j+b>=e.height())j=e.height()-b;if(!(k==0||j==0)){e=f.getImageData(d,b,k,j);for(var s=n;s<j;s++)for(var z=s*m,p=(s-n)*e.width*4,r,g=t;g<k;g++)if(r=this.data[z+(g>>3)]&1<<7-(g&7)){e.data[p++]=0;e.data[p++]=0;e.data[p++]=0;e.data[p++]=255}else p+=4;f.putImageData(e,d,b)}}};this.xor=function(e,d,b){if(!(y==0||w==0)){var f=e.get(0).getContext("2d"),k=y,j=w,t=0,n=0;if(d<0){t=-d;d=0}if(b<0){n=-b;b=0}if(k+d>e.width())k=e.width()-
d;if(j+b>=e.height())j=e.height()-b;if(!(k==0||j==0)){e=f.getImageData(d,b,k,j);for(var s=n;s<j;s++)for(var z=s*m,p=(s-n)*e.width*4,r,g=t;g<k;g++)if(r=this.data[z+(g>>3)]&1<<7-(g&7)){e.data[p++]^=255;e.data[p++]^=255;e.data[p++]^=255;e.data[p++]=255}else p+=4;f.putImageData(e,d,b)}}};this.hit=function(e,d){return(this.data[d*m+(e>>3)]&1<<7-(e&7))!=0};this.intersect=function(e){for(var d=e.top;d<e.top+e.height;d++)for(var b=d*m,f,k=e.left;k<e.left+e.width;k++)if(f=this.data[b+(k>>3)]&1<<7-(k&7))return true;
return false}}function decodePack(y){var w=new BitMap(512,302,64),m=Array(72);y.seek(512,y.set);for(var e=0,d=0;d<w.height;d++){for(var b=0;b<72;){var f=y.r8();if(f!=128)if(f&128){f^=255;f+=2;for(var k=y.r8(),j=0;j<f;j++)m[b++]=k}else{f++;for(j=0;j<f;j++)m[b++]=y.r8()}}for(j=0;j<64;j++)w.data[e++]=m[j]}return w}
function decodePPIC(y){var w=y.bits(3),m,e;e=y.bits(1)?y.bits(10):y.bits(6);if((m=y.bits(1)?y.bits(10):y.bits(6))&&e){m=new BitMap(m,e,m+15>>3&65534);switch(w){case 0:decodePPIC0(m,y);break;case 1:decodePPIC1(m,y);break;case 2:decodePPIC2(m,y);break;case 3:decodePPIC3(m,y)}return m}}
function decodePPIC0(y,w){for(var m=y.width>>4,e=y.width&15,d,b=0,f=0;f<y.height;f++){for(var k=0;k<m;k++){d=w.peek32();w.seek(2,w.cur);d>>=16-w.bit;y.data[b++]=d>>8&255;y.data[b++]=d&255}if(e){d=w.bits(e);d<<=16-e;y.data[b++]=d>>8&255;y.data[b++]=d&255}}}var ppic1huff=[0,8192,16384,20480,24576,28672,32768,36864,40960,45056,49152,53248,55296,57344,59392,61440,63488],ppic1lens=[3,3,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5],ppic1values=[0,15,3,5,6,7,8,9,10,12,255,1,2,4,11,13,14];
function decodePPIC1(y,w){decodeHuff(ppic1huff,ppic1lens,ppic1values,y,w)}var ppic2huff=[0,16384,32768,49152,51200,53248,55296,57344,59392,61440,62464,62976,63488,64E3,64512,65024,65280],ppic2lens=[2,2,2,5,5,5,5,5,5,6,7,7,7,7,7,8,8],ppic2values=[255,0,15,1,3,7,14,12,8,6,2,4,9,13,11,10,5];function decodePPIC2(y,w){decodeHuff(ppic2huff,ppic2lens,ppic2values,y,w)}var loadbits=[8,15,2,255,0,4,255,1,7,9,8,255,3,4,255,4,10,7,10,11,6,255,5,6,6,11,255,7,3,255,9,4,3,14,255,12,2,255,13,1,255,15,255];
function decodePPIC3(y,w){for(var m=Array(17),e,d,b=0;(d=loadbits[b++])!=255;){for(e=w.bits(d);(d=loadbits[b++])!=255;){m[loadbits[b++]]=e%d;e=e/d|0}m[loadbits[b++]]=e}m[16]=0;for(e=16;e>0;e--)for(d=e;d<=16;d++)m[d]>=m[e-1]&&m[d]++;for(e=16;e>=0;e--)if(m[e]==16){m[e]=255;break}b=Array(17);var f=Array(17);d=w.bits(2)+1;var k=0;for(e=0;e<15;e++){if(e)for(;!w.bits(1);)d++;f[e]=d;b[e]=k;k+=1<<16-d}for(b[15]=k;k&1<<16-d;)d++;b[16]=k|1<<16-d;f[15]=d;f[16]=d;decodeHuff(b,f,m,y,w)}
function decodeHuff(y,w,m,e,d){var b;walkHuffLast=walkHuffRepeat=0;b=e.width&3?d.bits(5):d.bits(4)<<1;var f=0,k=e.width&15;if(k){k>>=2;f=k&1;k=2-(k>>1)}for(var j=0,t=0;t<e.height;t++){for(var n=0;n<e.width>>3;n++){var s=walkHuff(y,w,m,d)<<4;e.data[j++]=walkHuff(y,w,m,d)|s}if(f)e.data[j]=walkHuff(y,w,m,d)<<4;j+=k}if(n=e.width&3){j=e.rowBytes-k;for(t=k=s=0;t<e.height;t++){if(b&1){if(s<n){v=walkHuff(y,w,m,d)<<4;k|=v>>s;s+=4}s-=n;v=k;k<<=n;k&=255}else{v=d.bits(n);v<<=8-n}if(f)v>>=4;e.data[j]|=v&255;j+=
e.rowBytes}}if(b&8)for(t=j=0;t<e.height;t++){v=0;if(b&2)for(n=0;n<e.rowBytes;n++){e.data[j]^=v;v=e.data[j++]}else for(n=0;n<e.rowBytes;n++){k=e.data[j]^v;k^=k>>4&15;e.data[j++]=k;v=k<<4}}if(b&4){delta=e.rowBytes*4;if(b&2)delta*=2;j=0;q=delta;for(i=0;i<e.height*e.rowBytes-delta;i++)e.data[q++]^=e.data[j++]}}var walkHuffRepeat=0,walkHuffLast=0;
function walkHuff(y,w,m,e){if(walkHuffRepeat){walkHuffRepeat--;walkHuffLast=walkHuffLast<<8&65280|walkHuffLast>>8;return walkHuffLast&255}var d=e.peek32();d>>=16-e.bit;d&=65535;var b;for(b=0;b<16;b++)if(y[b+1]>d)break;e.bit+=w[b];if(e.bit&16){e.bit&=15;e.seek(2,e.cur)}y=m[b];if(y==255){if(!e.bits(1)){walkHuffLast&=255;walkHuffLast|=walkHuffLast<<8}walkHuffRepeat=e.bits(3);if(walkHuffRepeat<3){walkHuffRepeat<<=4;walkHuffRepeat|=e.bits(4);if(walkHuffRepeat<8){walkHuffRepeat<<=8;walkHuffRepeat|=e.bits(8)}}walkHuffRepeat-=
2;walkHuffLast=walkHuffLast<<8&65280|walkHuffLast>>8;return walkHuffLast&255}else{walkHuffLast<<=8;walkHuffLast|=y;walkHuffLast&=65535}return y}
function GraphicManager(y){function w(m,e,d,b,f,k){m=m.get(0).getContext("2d");for(var j=m.getImageData(e,d,b,f),t=0;t<f;t++)for(var n=t*j.width*4,s=k?0:255,z=0;z<b;z++){j.data[n++]=s;j.data[n++]=s;j.data[n++]=s;j.data[n++]=255}m.putImageData(j,e,d)}this.get=function(m){m=y.get(3,m);if(!(m.length<2)){if(m.length==2)return this.get((m.charCodeAt(0)&255)<<8|m.charCodeAt(1)&255);return decodePPIC(new File(m))}};this.fill=function(m,e){w(m,0,0,m.width(),m.height(),e)};this.draw=function(m,e,d,b,f){var k=
{top:0,left:0,width:0,height:0},j;if(j=this.get(m*2+1)){k={top:d,left:e,width:j.width,height:j.height};switch(f){case 1:j.bic(b,e,d);break;case 2:j.or(b,e,d)}}else if(j=this.get(m*2)){k={top:d,left:e,width:j.width,height:j.height};switch(f){case 1:w(b,e,d,j.width,j.height,0);break;case 2:w(b,e,d,j.width,j.height,1)}}if(f>0&&(j=this.get(m*2)))j.xor(b,e,d);return k};this.sectRect=function(m,e,d){var b=e.top,f=e.left,k=f+e.width;e=b+e.height;if(b<m.top)b=m.top;if(f<m.left)f=m.left;if(e>m.top+m.height)e=
m.top+m.height;if(k>m.left+m.width)k=m.left+m.width;if(k<=f||e<=b)b=e=f=k=0;d.top=b;d.left=f;d.width=k-f;d.height=e-b;return d.height!=0}};function ObjectManager(y){var w=[];this.load=function(m,e){var d=y.getData(e),b={};b.numitems=0;b.isobj=false;d.seek(0,d.set);var f=d.length,k=d.r32(),j;if(k&2147483648){k&=2147483647;b.isobj=true;d.seek(k,d.set);b.numitems=d.r16();f=Array(16);for(var t=Array(16),n=0;n<15;n++)f[n]=d.r16();for(n=0;n<16;n++)t[n]=d.r8();b.offsets=Array(b.numitems);b.lengths=Array(b.numitems);var s=0;for(n=0;n<b.numitems;n++){if((n&63)==0){d.seek(k+(n>>6)*6+48,d.set);var z=d.r24();j=d.r24();s=z&7;d.seek(k+(z>>3),d.set)}b.offsets[n]=
j;z=d.r32()>>16-s&65535;d.seek(-4,d.cur);var p;for(p=0;p<16;p++)if(f[p]>z)break;z=t[p];s+=z&15;if(s&16){s&=15;d.seek(2,d.cur)}z>>=4;p=0;if(z){p=d.peek32();z--;if(z==0)p=0;else p>>=32-z-s;p&=(1<<z)-1;p|=1<<z;s+=z;if(s&16){s&=15;d.seek(2,d.cur)}j+=p}b.lengths[n]=p}j=k-4}else{f-=4;j=f;b.itemlen=k;b.numitems=f/k|0}d.seek(4,d.set);b.data=d.read(j);w[m]=b};this.get=function(m,e){if(e>=w[m].numitems)return"";var d,b;if(w[m].isobj){d=w[m].lengths[e];b=w[m].offsets[e]}else{d=w[m].itemlen;b=e*d}if(!d)return"";
return w[m].data.substring(b,b+d)}};function TextManager(y,w){function m(n){if(n&32768)return b.input;n=new File(y.get(2,n));for(var s=false,z="",p=n.r16();p--;){var r=n.bits(5);if(r>0&&r<27){r|=64;if(s)r|=32;s=true;z+=String.fromCharCode(r)}else switch(r){case 0:z+=" ";break;case 27:z+=s?".":",";s=true;break;case 28:z+=s?"'":'"';s=true;break;case 29:s=n.bits(16);if(s&32768){s^=65535;s=e(s)}else s=m(s);if(s)z+=s;s=true;break;case 30:z+=String.fromCharCode(n.bits(8));s=true;break;case 31:s=!s}}return webventure.mac2ascii(z)}function e(n){var s,
z;s=n&8?b.target:b.source;if((n&3)==1){s=webventure.get(s,7);s=(s>>4&3)+1;z=w.getIndStr(132,s)}else{z=b.get(s);z==""&&fail();switch(n&3){case 2:z=d(0,s)+z;break;case 3:z=d(2,s)+z}}if(z.length&&n&4)z=b.capitalize(z);return z}function d(n,s){var z=webventure.get(s,7)>>n&3;if(z)return w.getIndStr(131,z);return""}var b=this,f,k,j,t=true;this.input="";this.setHuff=function(n){if(n!=undefined){t=false;var s=n.r16();n.r16();f=Array(s);for(var z=0;z<s-1;z++)f[z]=n.r16();k=Array(s);for(z=0;z<s;z++)k[z]=n.r8();
j=Array(s);for(z=0;z<s;z++)j[z]=n.r8()}};this.get=function(n){if(t)return m(n);if(n&32768)return this.input;n=new File(y.get(2,n));var s,z="";for(s=n.bits(1)?n.bits(15):n.bits(7);s--;){var p=n.peek32();p>>=16-n.bit;p&=65535;var r;for(r=0;r<f.length;r++)if(p<f[r])break;n.bit+=k[r];if(n.bit&16){n.bit&=15;n.seek(2,n.cur)}p=j[r];if(p==1)p=n.bits(7);if(p!=2)z+=String.fromCharCode(p);else{if(n.bits(1)){p=n.bits(15);p=this.get(p)}else{p=n.bits(8);p=e(p)}if(p)z+=p}}return webventure.mac2ascii(z)};this.capitalize=
function(n){return n.substr(0,1).toUpperCase()+n.substr(1)}};function EngineState(){function y(e){if(e<0)e=(-e^65535)+1;return e}var w=Array(128),m=128;this.push=function(e){m--;w[m]=y(e)&65535};this.pop=function(){return w[m++]};this.peek=function(e){return w[m+e]};this.poke=function(e,d){w[m+e]=y(d)&65535};this.clear=function(){m=128};this.size=function(){return 128-m}}
function Engine(y,w,m,e){function d(r){r=typeof r!="undefined"?r:false;var g=false;if(p[0].haltedInFirst||r){p[0].haltedInFirst=false;if(g=r?b(0):f())return p[0].haltedInFirst=true;g=true;p[0].familyIdx=0}if(p[0].haltedInFamily||g){p[0].haltedInFamily=false;var o=webventure.getFamily(webventure.get(1,0),false);for(r=p[0].familyIdx;r<o.length;r++){if(g=g?b(o[r]):f()){p[0].haltedInFamily=true;p[0].familyIdx=r;return true}g=true}}var A;if(p[0].haltedInSaves){p[0].haltedInSaves=false;if(f())return p[0].haltedInSaves=
true}do{for(r=g=0;r<p[0].saves.length;r++)if(g<p[0].saves[r].rank){g=p[0].saves[r].rank;A=r}if(g){p[0].saves[A].rank=0;if(b(p[0].saves[A].func))return p[0].haltedInSaves=true}}while(g);p.shift();return false}function b(r){if(func=y.get(1,r)){p[0].p[0]=new File(func);return t()}return false}function f(){var r=t();if(r)return r;p[0].p.shift();if(p[0].p.length)return f()}function k(r){if(r&128)r=-((r^255)+1);return r}function j(r){if(r&32768)r=-((r^65535)+1);return r}function t(){for(var r=p[0].p[0],
g=p[0].state;!r.eof();){var o=r.r8();if(o&128)switch(o){case 128:var A=g.pop(),B=g.pop();o=webventure.get(A,B);g.push(o);break;case 129:A=g.pop();B=g.pop();o=j(g.pop());webventure.set(A,B,o);break;case 130:A=g.pop();B=g.pop();o=g.pop();g.push(s(A,B,o!=0));break;case 131:g.push(p[0].curCtl);break;case 132:g.push(p[0].curObj);break;case 133:g.push(p[0].target);break;case 134:g.push(p[0].ptx);break;case 135:g.push(p[0].pty);break;case 136:g.push(r.r8());break;case 137:g.push(r.r16());break;case 138:A=
g.pop();g.push(webventure.globals[A]);break;case 139:A=g.pop();o=j(g.pop());webventure.globals[A]=o;webventure.gameChanged=true;break;case 140:o=g.pop();g.push(Math.round((o-1)*Math.random()));break;case 141:o=g.peek(0);g.push(o);break;case 142:A=g.pop();for(B=A-1;A--;){o=g.peek(B);g.push(o)}break;case 143:B=g.pop();var E=g.pop();g.push(B);g.push(E);break;case 144:A=g.pop();E=g.peek(A);B=g.peek(0);g.poke(A,B);g.poke(0,E);break;case 145:g.pop();break;case 146:o=g.peek(1);g.push(o);break;case 147:A=
g.pop();o=g.peek(A);g.push(o);break;case 148:E=g.pop();B=g.pop();o=g.pop();g.push(E);g.push(o);g.push(B);break;case 149:var P=j(g.pop());A=j(g.pop());P%=A;if(P<0)P+=A;var X=0,F=0;for(o=1;o<A;o++){F+=P;if(F>=A)F-=A;if(F==X){X++;F=X}else{E=g.peek(X);B=g.peek(F);g.poke(X,B);g.poke(F,E)}}break;case 150:g.clear();break;case 151:g.push(g.size());break;case 152:B=g.pop();E=g.pop();g.push(E+B);break;case 153:B=g.pop();E=g.pop();g.push(E-B);break;case 154:B=g.pop();E=g.pop();g.push(E*B);break;case 155:B=g.pop();
E=g.pop();g.push(E/B|0);break;case 156:B=g.pop();E=g.pop();g.push(E%B);break;case 157:B=g.pop();E=g.pop();g.push(E%B);g.push(E/B|0);break;case 158:o=j(g.pop());if(o<0)o=-o;g.push(o);break;case 159:o=-j(g.pop());g.push(o);break;case 160:B=g.pop();E=g.pop();g.push(E&B);break;case 161:B=g.pop();E=g.pop();g.push(E|B);break;case 162:B=g.pop();E=g.pop();g.push(E^B);break;case 163:o=g.pop();g.push(o^65535);break;case 164:B=g.pop();E=g.pop();g.push(E&&B?65535:0);break;case 165:B=g.pop();E=g.pop();g.push(E||
B?65535:0);break;case 166:B=g.pop();E=g.pop();g.push(!E!=!B?65535:0);break;case 167:o=g.pop();g.push(o==0?65535:0);break;case 168:B=g.pop();E=g.pop();g.push(E>B?65535:0);break;case 169:B=g.pop();E=g.pop();g.push(E<B?65535:0);break;case 170:B=j(g.pop());E=j(g.pop());g.push(E>B?65535:0);break;case 171:B=j(g.pop());E=j(g.pop());g.push(E<B?65535:0);break;case 172:B=g.pop();E=g.pop();g.push(E==B?65535:0);break;case 173:B=w.get(g.pop());E=w.get(g.pop());g.push(E==B?1:0);break;case 174:o=w.get(g.pop());
A=w.get(g.pop());g.push(A.toLowerCase().indexOf(o.toLowerCase())!=-1?1:0);break;case 175:o=w.get(g.pop());A=w.get(g.pop());g.push(RegExp("\\b"+o+"\\b","i").test(A)?65535:0);break;case 176:o=j(r.r16());r.seek(o,r.cur);break;case 177:o=k(r.r8());r.seek(o,r.cur);break;case 178:o=j(r.r16());B=g.pop();B!=0&&r.seek(o,r.cur);break;case 179:o=k(r.r8());B=g.pop();B!=0&&r.seek(o,r.cur);break;case 180:o=j(r.r16());B=g.pop();B==0&&r.seek(o,r.cur);break;case 181:o=k(r.r8());B=g.pop();B==0&&r.seek(o,r.cur);break;
case 182:o=g.pop();A=g.pop();p[0].saves.push({rank:o,func:A});break;case 183:A=g.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].func==A)p[0].saves[o].rank=0;break;case 184:A=g.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].rank<=A)p[0].saves[o].rank=0;break;case 185:B=g.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].rank>=B)p[0].saves[o].rank=0;break;case 186:A=g.pop();B=g.pop();for(o=0;o<p[0].saves.length;o++)if(p[0].saves[o].rank>=B&&p[0].saves[o].rank<=A)p[0].saves[o].rank=
0;break;case 187:o=g.pop();A=g.pop();B=g.pop();E=g.pop();P=g.pop();p.unshift({curCtl:o,curObj:A,target:B,ptx:E,pty:P,state:new EngineState,saves:[],p:[undefined]});if(d(true))return true;break;case 188:o=g.pop();p[0].p.unshift(undefined);if(b(o))return true;p[0].p.shift();r=p[0].p[0];break;case 189:A=g.pop();webventure.queue.push({id:2,val:A});break;case 190:o={};o.from=g.pop();o.to=g.pop();webventure.queue.push({id:8,val:o});o=o;webventure.set(o.to,6,webventure.get(o.from,6));webventure.set(o.from,
6,0);A=webventure.getFamily(o.from,true);for(B=1;B<A.length;B++)webventure.set(A[B],0,o.to);break;case 191:webventure.queue.push({id:14,val:p[0].curObj});break;case 192:webventure.queue.push({id:13});break;case 193:o=g.pop();webventure.textQueue.push({id:3,val:[p[0].target,p[0].curObj,o]});break;case 194:webventure.textQueue.push({id:2});break;case 195:o=g.pop();webventure.textQueue.push({id:3,val:[p[0].target,p[0].curObj,o]});webventure.textQueue.push({id:2});break;case 196:webventure.textQueue.push({id:2});
o=g.pop();webventure.textQueue.push({id:3,val:[p[0].target,p[0].curObj,o]});webventure.textQueue.push({id:2});break;case 197:o=g.pop();webventure.textQueue.push({id:1,val:o});break;case 198:push(2);break;case 199:A=g.pop();webventure.soundQueue.push({id:1,val:A});break;case 200:A=g.pop();webventure.soundQueue.push({id:2,val:A});break;case 201:webventure.soundQueue.push({id:3});break;case 202:o=new Date;o=[o.getFullYear(),o.getMonth()+1,o.getDate(),o.getHours(),o.getMinutes(),o.getSeconds()];g.push(o[0]);
g.push(o[1]);g.push(o[2]);g.push(o[3]);g.push(o[4]);g.push(o[5]);break;case 203:g.push((new Date).getDay()+1);break;case 204:o=g.pop();A=g.pop();A=webventure.getFamily(A,o!=0);for(o=1;o<A.length;o++)g.push(A[o]);g.push(A.length-1);break;case 205:o=g.pop();A=g.pop();A=webventure.getFamily(A,o!=0);g.push(A.length-1);break;case 206:g.push(86);break;case 207:o=m.getIndStr(129,1);g.push(o.charCodeAt(3)-48);break;case 208:g.push(1);break;case 209:A=g.pop();o=n(A);o={v:o.height,h:o.width};g.push(o.h);g.push(o.v);
break;case 210:B=g.pop();E=g.pop();g.push(z(B,E));break;case 211:o=A=g.pop();A=[];B=webventure.getFamily(webventure.get(o,0),1);for(E=1;E<B.length;E++)o<B[E]&&z(B[E],o)>=40&&A.push(B[E]);for(;A.length;)webventure.set(A.pop(),0,o);break;case 212:A=A=g.pop();o=webventure.getFamily(A,1);A=webventure.get(A,0);for(B=1;B<o.length;B++)webventure.set(o[B],0,A);break;case 213:r=g.pop();webventure.textEntry(r,p[0].curObj,p[0].target);return true;case 214:webventure.activateCommand(g.pop());break;case 215:webventure.gameState=
3;break;case 216:webventure.gameState=2;break;case 217:r=g.pop();setTimeout(webventure.runMain,r/60*1E3);return true;case 218:webventure.updateScreen(false);webventure.clickToContinue();return true;case 219:webventure.runQueue();break;case 220:if(webventure.playSounds(true))return true;break;case 221:webventure.printTexts();break;case 222:if(webventure.updateScreen(true))return true;break;case 223:r=g.pop();webventure.invertmain();setTimeout(webventure.revertmain,r/60*1E3);return true;case 224:g.pop();
break;case 225:g.pop();break;case 226:B=g.pop();E=g.pop();E*=B;o=g.pop();E/=o;g.push(E|0);break;case 227:A=g.pop();webventure.updateObject(A);break;case 228:g.push(0);break;case 229:console.log("wait for event");break;case 230:g.push(fib);break;case 231:A=g.pop();B=1;for(o=fib=0;o<A;o++){fib+=B;fib^=B;B^=fib;fib^=B}break;default:console.log("func: "+o.toString(16));this.die()}else g.push(o)}return false}function n(r){var g={top:0,left:0,width:0,height:0},o=webventure.getParentWin(r),A=0;if(o&&o.refCon)A=
webventure.getChildIdx(o.refCon.children,r);if(A){if(o.refCon.children[A-1].width==0||o.refCon.children[A-1].height==0){r=webventure.drawObject(r,o,true);o.refCon.children[A-1].top=r.top;o.refCon.children[A-1].left=r.left;o.refCon.children[A-1].width=r.width;o.refCon.children[A-1].height=r.height}g.top=o.refCon.children[A-1].top;g.left=o.refCon.children[A-1].left;g.width=o.refCon.children[A-1].width;g.height=o.refCon.children[A-1].height}else if((bmp=e.get(r*2))!=undefined){g.top=webventure.get(r,
2);g.left=webventure.get(r,1);g.width=bmp.width;g.height=bmp.height}else if((bmp=e.get(r*2+1))!=null){g.top=webventure.get(r,2);g.left=webventure.get(r,1);g.width=bmp.width;g.height=bmp.height}else{g.top=0;g.left=0;g.width=0;g.height=0}return g}function s(r,g,o){var A=0;r=webventure.getFamily(r,o);for(o=1;o<r.length;o++)A+=webventure.get(r[o],g);return A}function z(r,g){if(webventure.get(r,0)!=webventure.get(g,0))return 0;var o=n(r),A=n(g);if(e.sectRect(A,o,A))return A.width*A.height*100/(o.width*
o.height)|0;return 0}var p=[];this.reset=function(){p=[]};this.push=function(r){p[0].state.push(r)};this.run=function(r,g,o,A){p.unshift({curCtl:r,curObj:g,target:o,ptx:A.h,pty:A.v,state:new EngineState,saves:[],p:[]});return this.resume(true)};this.resume=function(r){for(r=typeof r!="undefined"?r:false;p.length;)if(d(r))return true;return false}};function ResourceManager(){var y=[];this.open=function(w){y.push(w);return y.length-1};this.close=function(w){y.splice(w,1)};this.get=function(w,m){for(var e=w.charCodeAt(0)<<24|w.charCodeAt(1)<<16|w.charCodeAt(2)<<8|w.charCodeAt(3),d=y.length-1;d>=0;d--){var b=y[d];b.seek(0,b.set);var f=b.r32(),k=b.r32();b.seek(k+24,b.set);k=k+b.r16();b.seek(k,b.set);for(var j=b.r16()+1,t=0;t<j;t++){if(b.r32()==e){e=b.r16()+1;b.seek(k+b.r16(),b.set);for(t=0;t<e;t++){if(b.r16()==m){b.seek(2,b.cur);f+=b.r32()&16777215;
b.seek(f,b.set);f=b.r32();return new File(b.read(f))}b.seek(10,b.cur)}return}b.seek(4,b.cur)}}};this.getString=function(w){w=this.get("STR ",w);if(w==undefined)return"";var m=w.r8();return w.read(m)};this.getIndStr=function(w,m){if(m==0)return"";var e=this.get("STR#",w);if(e==undefined)return"";var d=e.r16();if(m>d)return"";for(;;){m--;if(m==0){d=e.r8();return e.read(d)}d=e.r8();e.seek(d,e.cur)}}};function ControlManager(){function y(e,d,b,f,k,j,t){var n=$(document.createElement("div"));n.addClass("button");n.css("top",d+"px");n.css("left",e+"px");n.css("width",b-2+"px");n.css("height",f-2+"px");n.css("line-height",f-2+"px");n.html(k);n.data("refcon",t);j==false&&n.hide();n.mousedown(function(s){webventure.buttonClicked(n,s);return false});return n}function w(e,d,b,f,k,j,t){var n=$(document.createElement("div"));n.addClass("cbutton");n.css("top",d+"px");n.css("left",e+"px");n.css("width",b-
2+"px");n.css("height",f-2+"px");n.html(k);n.data("refcon",t);j==false&&n.hide();n.mousedown(function(s){webventure.buttonClicked(n,s);return false});return n}function m(e,d,b,f,k,j,t,n,s){var z=$(document.createElement("div"));z.addClass("hslider");z.css("top",d+"px");z.css("left",e+"px");z.css("width",b+"px");z.css("height",f+"px");z.data("refcon",s);n==false&&z.hide();e=$(document.createElement("div"));e.addClass("hsliderLeft");e.css("top","0px");e.css("left","0px");z.append(e);e=$(document.createElement("div"));
e.addClass("hsliderWell");e.css("top","0px");e.css("left","4px");e.css("width",b-8+"px");z.append(e);d=$(document.createElement("div"));d.addClass("hsliderRight");d.css("top","0px");d.css("left",b-4+"px");z.append(d);var p=$(document.createElement("div"));p.addClass("hsliderThumb");p.css("top","-4px");p.css("left",((k-j)*(b-8-11)/t|0)+"px");e.append(p);z.data("value",k);p.mousedown(function(r){var g=r.pageX,o=p.position().left;$(document).mousemove(function(A){o+=A.pageX-g;g=A.pageX;if(o>=0&&o<=b-
8-11)p.css("left",o+"px");else o<0?p.css("left","0px"):p.css("left",b-8-11+"px");return false});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");var A=p.position().left;z.data("value",j+(A*(t-j)/(b-8-11)|0));return false});return false});return z}this.create=function(e,d,b,f,k,j,t,n,s,z,p){switch(k>>4){case 0:return y(e,d,b,f,j,t,p);case 128:return w(e,d,b,f,j,t,p);case 256:k=$(document.createElement("input"));k.addClass("textinput");k.css("top",d+"px");
k.css("left",e+"px");k.css("width",b+"px");k.css("height",f+"px");k.val(j);k.data("refcon",p);t==false&&k.hide();return k;case 272:k=$(document.createElement("div"));k.addClass("text");k.css("top",d+"px");k.css("left",e+"px");k.css("width",b+"px");k.css("height",f+"px");k.html(j);k.data("refcon",p);t==false&&k.hide();return k;case 288:j=$(document.createElement("div"));j.addClass("list");j.css("top",d+"px");j.css("left",e+"px");j.css("width",b+"px");j.css("height",f+"px");j.data("refcon",p);t==false&&
j.hide();return j;case 304:return m(e,d,b,f,n,s,z,t,p);default:console.log("Unknown CDEF:"+k);this.die()}};this.get=function(e){var d=e.r16(),b=e.r16(),f=e.r16()-d,k=e.r16()-b,j=e.r16(),t=e.r8()!=0;e.r8();var n=e.r16(),s=e.r16(),z=e.r16(),p=e.r32(),r=e.r8(),g="";if(r!=0)g=e.read(r);return this.create(b,d,k,f,z,g,t,j,s,n,p)};this.move=function(e,d,b){var f=e.position();e.css("left",f.left+d+"px");e.css("top",f.top+b+"px")}};function Sound(y,w){function m(){var b=Array(44+y);b[0]=82;b[1]=73;b[2]=70;b[3]=70;var f=36+y;b[4]=f&255;b[5]=f>>8&255;b[6]=f>>16&255;b[7]=f>>24&255;b[8]=87;b[9]=65;b[10]=86;b[11]=69;b[12]=102;b[13]=109;b[14]=116;b[15]=32;b[16]=16;b[17]=0;b[18]=0;b[19]=0;b[20]=1;b[21]=0;b[22]=1;b[23]=0;b[24]=w&255;b[25]=w>>8&255;b[26]=w>>16&255;b[27]=w>>24&255;b[28]=b[24];b[29]=b[25];b[30]=b[26];b[31]=b[27];b[32]=1;b[33]=0;b[34]=8;b[35]=0;b[36]=100;b[37]=97;b[38]=116;b[39]=97;b[40]=y&255;b[41]=y>>8&255;b[42]=y>>16&
255;b[43]=y>>24&255;for(f=0;f<y;f++)b[44+f]=e.data[f];f="";var k,j,t="",n,s;j="";var z=0;do{k=b[z++];j=b[z++];t=b[z++];n=k>>2;k=(k&3)<<4;if(j==undefined)s=j=64;else if(t==undefined){k|=j>>4;j=64}else{k|=j>>4;s=(j&15)<<2|t>>6;j=t&63}f+=d.charAt(n)+d.charAt(k)+d.charAt(s)+d.charAt(j)}while(z<b.length);return f}var e=this,d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.data=Array(y);this.time=function(){return y/w};this.play=function(){var b=$(document.createElement("audio"));
$(document.body).append(b);b.attr("src","data:audio/x-wav;base64,"+m());var f=webventure.setting("volume");if(f==null)f=100;b.attr("volume",f/100);b.bind("ended",function(){b.remove()});b.get(0).play()}}
function SoundManager(y){var w=false;try{var m=document.createElement("audio").canPlayType("audio/wav");w=m!=""&&m!="no"}catch(e){}this.muted=false;this.play=function(d){var b=y.get(4,d);d=new File(b);var f=undefined;switch(b.charCodeAt(5)&255){case 16:var k=[];d.seek(408,d.set);for(var j=0;j<16;j++)k[j]=d.r8();var t=d.r32()*2;d.r16();j=d.r32()*22100/65536|0;var n=new Sound(t,j),s;for(j=0;j<t;j++){if(j&1)s>>=4;else s=d.r8();n.data[j]=k[s&15]}f=n;break;case 18:d.seek(12,d.set);k=d.r16();d.seek(52,
d.set);s=d.r16()+52;d.seek(s,d.set);t=d.r32()-6;d.r16();j=d.r32()*22100/65536|0;j=new Sound(t*k,j);n=0;b=d.seek(226,d.set)+226;for(f=0;f<k;f++){d.seek(b+f*2,d.set);var z=d.r16();d.seek(s+10,d.set);for(var p=0;p<t;p++){var r=d.r8();if(r&128){r-=128;r=r*z;r=r>>8&255;if(r&128)r=127;r+=128}else{r=(r^255)+1;r-=128;r=r*z;r=r>>8&255;if(r&128)r=127;r+=128;r=(r^255)+1}j.data[n++]=r}}f=j;break;case 24:k=[];d.seek(594,d.set);for(j=0;j<16;j++)k[j]=d.r8();s=d.r32()*2;d.r16();j=d.r32()*22100/65536|0;n=new Sound(s,
j);for(j=0;j<s;j++){if(j&1)t>>=4;else t=d.r8();n.data[j]=k[t&15]}f=n;break;case 26:k=[];d.seek(544,d.set);for(t=0;t<16;t++)k[t]=d.r8();s=d.r32();d.r16();t=d.r32()*22100/65536|0;n=new Sound(s,t);for(t=0;t<s;t++){if(t&1)j>>=4;else j=d.r8();n.data[t]=k[j&15]}f=n;break;case 68:d.seek(94,d.set);k=d.r32();s=d.r32()*22100/65536|0;s=new Sound(k,s);for(t=0;t<k;t++)s.data[t]=d.r8();f=s;break;case 120:k=[];d.seek(186,d.set);for(t=0;t<16;t++)k[t]=d.r8();d.r32();s=d.r32();t=d.r32()*22100/65536|0;j=new Sound(s,
t);for(t=0;t<s;t++){if(t&1)n<<=4;else n=d.r8();j.data[t]=k[n>>4&15]}f=j;break;case 126:s=[];d.seek(194,d.set);for(j=0;j<16;j++)s[j]=d.r8();d.r32();t=d.r32();j=d.r32()*22100/65536|0;n=new Sound(t,j);b=128;for(j=0;j<t;j++){if(j&1)k<<=4;else k=d.r8();b+=s[k>>4&15];n.data[j]=b&255}f=n}if(f==undefined)return 0;else{w&&!this.muted&&f.play();return f.time()}}};function Menu(y,w){this.id=y;this.title=w;this.el=undefined;var m=[];this.add=function(e){m.push(e)};this.draw=function(){var e=$(document.createElement("table"));e.addClass("menu");var d=$(document.createElement("tbody"));e.append(d);var b=this.el.position();e.css("top",b.top+19+"px");e.css("left",b.left+"px");for(b=0;b<m.length;b++){var f=m[b].draw();d.append(f)}return e}}
function MenuItem(y,w){this.draw=function(){var m=$(document.createElement("tr"));if(y=="-"){var e=$(document.createElement("td"));e.attr("colspan","2");e.addClass("divider");e.append(document.createElement("hr"))}else{m.addClass("menuitem");e=$(document.createElement("td"));e.html(y);m.append(e);e=$(document.createElement("td"));if(w!=0){e.addClass("shortcut");e.append(String.fromCharCode(w))}}m.append(e);return m}}
function MenuManager(y){function w(d){if(!webventure.isPaused){for(var b,f=0,k=$(d.target);k.data("refCon")==undefined;)k=k.parent();k.addClass("active");d=k.data("refCon");for(b=0;b<m.length;b++)if(m[b].id==d)break;var j=m[b].draw();y.append(j);$(document).mousemove(function(t){var n=e.position();if(t.pageX>=n.left&&t.pageY>n.top&&t.pageX<n.left+e.width()&&t.pageY<n.top+e.height())for(b=0;b<m.length;b++){n=m[b].el.position();var s=(m[b].el.outerWidth()-m[b].el.width())/2;if(t.pageX>=n.left-s&&t.pageX<
n.left-s+m[b].el.outerWidth()){j.remove();k.removeClass("active");k=m[b].el;k.addClass("active");j=m[b].draw();y.append(j);break}}else{n=j.position();if(t.pageX>=n.left&&t.pageY>=n.top&&t.pageX<n.left+j.width()&&t.pageY<n.top+j.height()){t.pageY-=n.top;j.find("tr").each(function(z,p){n=$(p).position();if(t.pageY>=n.top&&t.pageY<n.top+$(p).height()){if($(p).hasClass("menuitem")){f=z+1;$(p).addClass("active")}}else $(p).removeClass("active")})}else{j.find("tr").each(function(z,p){$(p).removeClass("active")});
f=0}}});$(document).mouseup(function(){$(document).unbind("mousemove");$(document).unbind("mouseup");j.remove();k.removeClass("active");f&&webventure.menuSelect(m[b].id,f)})}}var m=[],e;this.get=function(d){var b=d.r16();d.seek(12,d.cur);var f=d.r8(),k="";if(f!=0)k=d.read(f);if(f==1)k="";for(b=new Menu(b,k);;){k=d.r8();if(k==0)break;f="";if(k!=0)f=webventure.mac2ascii(d.read(k));d.r8();k=d.r8();var j=d.r8(),t=d.r8();f=new MenuItem(f,k,j,t);b.add(f)}m.push(b)};this.show=function(){e=$(document.createElement("div"));
e.addClass("menubar");for(var d in m){var b=$(document.createElement("div"));b.addClass("menu");m[d].title==""?b.addClass("apple"):b.append(m[d].title);b.data("refCon",m[d].id);b.mousedown(function(f){w(f);return false});m[d].el=b;e.append(b)}y.append(e)};this.addDA=function(d){m[0].add(new MenuItem(d,0,0,0))}};webventure.init();
